---
title: "Match day 23 Season 2526"
author: "Dr Phil Barter"
format: 
  dashboard:
      scrolling: true
      logo: https://anfieldindex.com/wp-content/uploads/2016/09/AI-Under-Pressure.png
      nav-buttons: 
                  - icon: github
                    href: https://github.com/Barts78
                  - icon: linkedin
                    href: https://www.linkedin.com/in/phil-barter-55500122/
                  - icon: twitter
                    href: https://twitter.com/Barts78
                  - icon: bluesky
                    href: https://bsky.app/profile/barts78.bsky.social
                    
      theme: 
        - Lux
        - Matchdash.scss
      type: default 
---


```{r}
#| label: Simulate Football Match Outcomes Based on xG
#'
#' @param home_xg_vector Numeric vector of xG values for each home team shot
#' @param away_xg_vector Numeric vector of xG values for each away team shot
#' @param runs Number of simulations to perform (default: 10000)
#' @param seed Random seed for reproducibility (default: 1111)
#'
#' @return A list containing:
#' - `prob_matrix`: A matrix of scoreline probabilities
#' - `long_prob_matrix`: Data frame for plotting with ggplot
#' - `simulation_results`: Data frame of simulated outcomes


simulate_match_outcomes <- function(
  home_xg_vector, 
  away_xg_vector, 
  runs = 10000, 
  seed = 1111,
  actual_home_goals = NULL,
  actual_away_goals = NULL
) {
  set.seed(seed)

  safe_simulate_goals <- function(xg_vector, runs) {
    # Flatten in case it's a list (like from dplyr::select)
    xg_vector <- unlist(xg_vector)

    if (length(xg_vector) == 0) return(rep(0, runs))

    # Clean and clip to [0, 1]
    xg_vector <- as.numeric(xg_vector)
    xg_vector <- xg_vector[!is.na(xg_vector)]
    xg_vector <- pmin(pmax(xg_vector, 0), 1)

    if (length(xg_vector) == 0) return(rep(0, runs))

    draws <- rbinom(length(xg_vector) * runs, size = 1, prob = rep(xg_vector, each = runs))
    goals_matrix <- matrix(draws, nrow = runs, byrow = FALSE)
    rowSums(goals_matrix)
  }

  home_goals <- safe_simulate_goals(home_xg_vector, runs)
  away_goals <- safe_simulate_goals(away_xg_vector, runs)

  simulation_results <- data.frame(Home = home_goals, Away = away_goals)
  prob_matrix <- table(simulation_results$Home, simulation_results$Away) / runs

  long_prob_matrix <- as.data.frame(as.table(prob_matrix))
  colnames(long_prob_matrix) <- c("Home", "Away", "Probability")
  long_prob_matrix <- long_prob_matrix %>%
    mutate(Probability = round(Probability * 100, 2))

  goal_summary <- NULL
  if (!is.null(actual_home_goals) && !is.null(actual_away_goals)) {
    exact_count <- sum(home_goals == actual_home_goals & away_goals == actual_away_goals)
    at_least_home <- sum(home_goals >= actual_home_goals)
    at_least_away <- sum(away_goals >= actual_away_goals)

    goal_summary <- list(
      actual_score = paste(actual_home_goals, "-", actual_away_goals),
      exact_occurrences = exact_count,
      exact_percentage = round(100 * exact_count / runs, 2),
      home_goals_at_least = at_least_home,
      away_goals_at_least = at_least_away,
      home_goals_at_least_pct = round(100 * at_least_home / runs, 2),
      away_goals_at_least_pct = round(100 * at_least_away / runs, 2)
    )
  }

  return(list(
    prob_matrix = prob_matrix,
    long_prob_matrix = long_prob_matrix,
    simulation_results = simulation_results,
    goal_summary = goal_summary
  ))
}


```

```{r}
#| label: Team season sumary function 

# Reusable function to compute team summary metrics
compute_season_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV),
           Match_day = as.numeric(Match_day)) %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(Match_day = first(Match_day),
              n_matches = n_distinct(game_name),
              across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
),
        ~ sum(.x, na.rm = TRUE) / n_matches
      ),
      #.groups = "drop"
    ) %>%
    #select(-n_matches) %>%
    mutate(
      In_play_time = round(In_play_time / 60, 1),
      Possession   = round((Touches / (sum(Touches))) * 100, 1),
      Field_Tilt   = round((Final_Third_Touches / (sum(Final_Third_Touches))) * 100, 1),
      Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
      Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
      Long_Pass_Rate    = round((Long_Passes / Attempted_Passes) * 100, 2),
      Cross_Success     = round((Successful_Cross / Cross_Passes) * 100, 2),
      Failed_Pass    = Attempted_Passes - Successful_Passes,
      Failed_Cross   = Cross_Passes - Successful_Cross,
      Failed_Dribble = Dribbles_Total - Dribbles_Won,
      Poss_Gained = Interceptions_Total + Recoverys_Total +
                    (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
      Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble +
                  OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
      Posession_Control =
        Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
        (Aerial_Won - Aerial_Lost) -
        (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
         UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
      `EPV % xG Con.`   = round((xG   / TeamEPV) * 100, 1),
      `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1)
    ) %>%
    mutate(across(everything(), ~ replace_na(.x, 0))) %>%
    mutate(across(where(is.numeric), ~ round(.x, 2)))
}

```


```{r}
#| label: Team sumary function 

# Reusable function to compute team summary metrics
compute_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV)) %>%
    group_by(across(all_of(group_vars))) %>%
        summarise(Match_day = first(Match_day), 
                  across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
        ),
                 sum, na.rm = TRUE)) %>%
    mutate(In_play_time = round(In_play_time / 60, 1),
           Possession = round((Touches/(sum(Touches)))*100,1),
           Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1),
           Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
           Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
           Long_Pass_Rate = round((Long_Passes / Attempted_Passes) * 100, 2),
           Cross_Success = round((Successful_Cross / Cross_Passes) * 100, 2),
           Failed_Pass = Attempted_Passes - Successful_Passes,
           Failed_Cross = Cross_Passes - Successful_Cross,
           Failed_Dribble = Dribbles_Total - Dribbles_Won,
           Poss_Gained = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
           Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
           Posession_Control = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
                               (Aerial_Won - Aerial_Lost) -
                               (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
                               UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
           `EPV % xG Con.` = round((xG / TeamEPV) * 100, 1),
           `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1),
           ) %>%
    
    mutate(across(everything(), ~replace_na(.x, 0))) 
  
}

```

``` {r}
#| label: Shift column function
# Shift column funtion, this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

```

```{r}
#| output: false
#| label: touch area function Quantiles
#' Function for plotting Player touch areas
#' Function for plotting Team touch areas - set at 75%

#calculate touch area of player - set at 75% using quantiles
touch_area_shape_quantiles <- function(data) {
  
  x_low <- quantile(data$x, 0.15)
  x_high <- quantile(data$x, 0.85)
  
  y_low <- quantile(data$y, 0.15)
  y_high <- quantile(data$y, 0.85)
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}
```
```{r}

#| output: false
#| label: touch area function Mad
#' Function for plotting Player touch areas using 1.5 MAD( 75% of data) Mediands
touch_area_shape_mad <- function(data) {
  
  x_median <- median(data$x)
  y_median <- median(data$y)
  
  x_mad <- median(abs(data$x - x_median))/0.6745
  y_mad <- median(abs(data$y - y_median))/0.6745
  
  x_low <- x_median - 1.5*x_mad
  x_high <- x_median + 1.5*x_mad
  
  y_low <- y_median - 1.5*y_mad
  y_high <- y_median + 1.5*y_mad
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

```


```{r}
#| output: false
#| label: Enhanced TouchPlayerPlot_AI with method selection and dynamic faceting
TouchPlayerPlot_AI <- function(
  data,
  color = "firebrick4",
  text_color = "",
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "quantile",  # or "mad"
  facet_by = "playerId"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    filter(`type/value` %in% c(1, 2, 3, 4, 7, 8, 9, 10:16, 41, 42, 44, 45, 50, 52, 54, 61, 73, 74),
           `outcomeType/value` == 1) %>%
    drop_na(playerId, x, y) %>%
    filter(between(expandedMinute, plot_start, plot_finish))

  list_data <- split(data, data$playerId)

  # Use appropriate shape function
  shape_fn <- if (method == "mad") touch_area_shape_mad else touch_area_shape_quantiles
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    na.omit()

  teamtitle <- paste(title, "Player Touch Areas")
  
  # --- 1) Desired role order ---------------------------------------------------
role_levels <- c("Keeper", "Defender", "Midfielder", "Attacker")
facet_col   <- sym(facet_by)        # should be "playerId" for this function

# --- 2) Build facet order from role, then name --------------------------------
# (If a player appears with multiple roles, the first by role order is taken.)
facet_levels <- data %>%
  distinct(!!facet_col, role) %>%
  mutate(role = factor(role, levels = role_levels)) %>%
  arrange(role, !!facet_col) %>%
  pull(!!facet_col) %>%
  as.character()

# keep exactly 11 panels
facet_levels <- facet_levels[seq_len(min(11, length(facet_levels)))]

# --- 3) Relevel the faceting variable in ALL datasets used in the plot --------
data <- data %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

touch_area_data <- touch_area_data %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

PlayerPos <- PlayerPos %>%
  mutate(!!facet_col := factor(.data[[facet_by]], levels = facet_levels)) %>%
  filter(!is.na(.data[[facet_by]]))

  player_touch_map <- ggplot(touch_area_data) +
    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    
    geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey") +
    geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey") +
    geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey") +
    
    geom_point(data = data, aes(x = x, y = y), alpha = 0.5, colour = "black", size = 1) +
    geom_polygon(aes(x = x, y = y), colour = color, alpha = 0.2, fill = color, size = 0.4) +
    geom_point(data = PlayerPos, aes(x = x, y = y), colour = color, alpha = 0.8, shape = 19, size = 2) +
    facet_wrap(as.formula(paste("~", facet_by)), ncol = 4) +
    labs(
      title = teamtitle,
      x = "",
      subtitle = paste(subtitle, "
Area = 75% of activity, Team Colour Dot = Player Average Position"),
      caption = My_caption
    ) +
    theme(
      legend.position = "none",
      plot.background = element_rect(colour = "snow", fill = "snow"),
      panel.background = element_rect(colour = "snow", fill = "snow"),
      strip.background = element_rect(fill = color, color = "black", linetype = "solid", linewidth = 1),
      strip.text = element_text(size = 8, colour = text_color),
      plot.title = element_text(colour = "black", size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_blank()
    )

  if (logo == "Yes") {
    player_touch_mapAI <- ggdraw() +
      draw_plot(player_touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.445, y = 0.438, scale = 0.12)
  } else {
    player_touch_mapAI <- player_touch_map
  }

  return(player_touch_mapAI)
}
```

```{r}
#| output: false
#| lable: Enhanced TouchTeamPlot_OPTA with method selection
TouchTeamPlot_OPTA <- function(
  data,
  color = "#E74C3C",
  palette = NULL,
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "mad"  # or "quantile"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "file_name", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    drop_na(playerId, x, y) %>%
    filter(dplyr::between(expandedMinute, plot_start, plot_finish))

  shape_fn <- if (method == "quantile") touch_area_shape_quantiles else touch_area_shape_mad
  list_data <- split(data, data$playerId)
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(dplyr::full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    tidyr::drop_na()

  # ---- NEW: build palette from `palette` or default white -> color ramp ----
  players <- sort(unique(as.character(touch_area_data$playerId)))
  n <- length(players)

  build_palette <- function(players, palette, color) {
    n <- length(players)

    # 1) Named vector mapping playerId -> color
    if (is.character(palette) && !is.null(names(palette))) {
      if (!all(players %in% names(palette))) {
        warning("Named palette does not cover all players; missing players will be auto-colored.")
      }
      cols <- palette[players]
      # fill any NAs (uncovered players) from a white->color ramp
      if (anyNA(cols)) {
        fill_cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(sum(is.na(cols)))
        cols[is.na(cols)] <- fill_cols
      }
      names(cols) <- players
      return(cols)
    }

    # 2) Paletteer "pkg::pal" string
    if (is.character(palette) && length(palette) == 1 && grepl("::", palette, fixed = TRUE)) {
      if (requireNamespace("paletteer", quietly = TRUE)) {
        cols <- as.character(paletteer::paletteer_d(palette, n))
        names(cols) <- players
        return(cols)
      } else {
        warning("paletteer not installed; falling back to white -> color ramp.")
      }
    }

    # 3) Plain vector of colors to interpolate
    if (is.character(palette) && length(palette) >= 1) {
      cols <- grDevices::colorRampPalette(palette)(n)
      names(cols) <- players
      return(cols)
    }

    # Default: white -> color ramp (keeps your 'min = white' feel)
    cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(n)
    if (n == 1) cols <- color
    names(cols) <- players
    cols
  }

  pal <- build_palette(players, palette, color)

  # lock factor levels
  touch_area_data <- touch_area_data %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  PlayerPos <- PlayerPos %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  # -------------------------------------------------------------------------

  teamtitle <- paste(title, "Areas")

  touch_map <- ggplot(touch_area_data) +
    
    # use the palette (discrete by player)
    scale_fill_manual(values = pal) +
    scale_colour_manual(values = pal) +

    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9),
             x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83),
             y = 0, yend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    #plot player touch area
    geom_polygon(aes(x = x, y = y, fill = playerId, colour = playerId), alpha = 0.15, size = 0.5) +
    #plot player average position
    geom_point(data = PlayerPos, aes(x = x, y = y, fill = playerId, colour = playerId),
               alpha = 0.7, shape = 21, size = 3, stroke = 0.5) +
    # plot player name
    geom_text(data = PlayerPos, aes(x = x, y = y + 4, label = playerId, colour = playerId), size = 3) +
    labs(
      title = teamtitle,
      subtitle = paste(subtitle, "\nArea = 75% of activity, Dot = Player Average Position"),
      caption = My_caption,
      x = ""
    ) +
    theme(
      strip.background = element_rect(fill = "#E5E5E5", 
      colour = NA), strip.text = element_text(colour = "black", size = 10), 
      plot.title = element_text(colour = "black", 
      size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_text(colour = "black", size = 12, face = "bold"),
      legend.position = "none"
    )

  if (logo == "Yes") {
    touch_mapAI <- ggdraw() +
      draw_plot(touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.4, y = 0.45, scale = 0.07)
  } else {
    touch_mapAI <- touch_map
  }

  return(touch_mapAI)
}

```

```{r}
#| output: false
#| label: Shot map function

#' Function for plotting shots for a team

plot_shot_AI <- function(data, type = "", teamColor = "#B22222", text_color = "", bins = 30, highlight_goals = "", average_location = "", matchFixture = "", mapName = "", mapType = "", matchDate = "", dataSource = "", logo = "", wrap = "") {
  
  # Checking data frame   
  if ((nrow(data) > 0) &&
      sum(c("minute", "X", "Y", "xG", "xGOT", "NPxG", "result", "OTShots", "player", "Game_Period") %in% names(data)) == 10) {

    # set plot names
    if (dataSource == "UnderStat") {
      
      if (mapType == "Home") {
      
        home_team <- (data$home_team[nrow(data)])
        
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "Away") {
      
        away_team <- (data$away_team[nrow(data)]) 
        
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold \";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
    
      } else if (mapType == "Player") {  
      
        last <- sub(".* ", "", data$player[nrow(data)])
        first <- sub(" .*", "", data$player[nrow(data)])
        player_name <- paste(first, last)
      
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span>><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
      
    } else if (dataSource == "FotMob") {
      if (mapType == "Home") {
        
        home_team <- (data$home_team[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$away_team[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        last <- (data$last_name[nrow(data)])
        first <- (data$first_name[nrow(data)])
        player_name <- paste(first, last)
        
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
        
    } else if (dataSource == "Opta") {
      if (mapType == "Team") {
        
       team_name <- (data$TeamName[nrow(data)]) 

        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{team_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$TeamName[nrow(data)]) 
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        player_name <- (data$playerId[nrow(data)])
        
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal,</span><span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'> SoT</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
    }
      
    fixture_name <- paste(matchFixture, "(",dataSource,")")
  

    # set Plot Colours and scale
    fill_b <- "#E5E5E5"
    pitch_lines <- "black"
    color_b <- teamColor
    colorLine <- "#95A5A6"
    colorText <- "black"
    fill_Goal <- c("No Goal" = fill_b,"SoT" = teamColor, "Goal" = teamColor)
    Alpha_Goal <- c("No Goal" = 0.9,"SoT" = 0.3, "Goal" = 1)
    # Data Wrangling 
    if (dataSource == "UnderStat") {
      data <- data %>%
        mutate(X = 100 * X) %>%
        mutate(Y = 100 * Y)
      
     } else if (dataSource == "FotMob") {
        data <- data %>%
             mutate(X = (X * 0.941050375),
                    Y = (Y * 1.464079972))
        
     } else if (dataSource == "Opta") {
        data <- data 
      }
    
    if (nrow(data) >= 1) {
      data <- data %>%
        mutate(xG = round(xG,2),
               isGoal = ifelse(result == "Goal", "Goal", ifelse(OTShots == 1, "SoT", "No Goal"))) 

              # set the pitch up
              plot <- data %>%
                ggplot() +
                annotate_pitch(dimensions = pitch_opta, colour = pitch_lines, fill = fill_b) +
                theme_pitch() +
                annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
                annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

                
                # add zone numbers
                geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE)
              
              # geometrics 
              if (average_location == TRUE || average_location == "") {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") { ## Don't highlight goals ----
                    plot  <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute,"\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = "",
                      )
                  } else if (highlight_goals == TRUE) { ## Highlight goals ----
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, fill = isGoal, alpha = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_alpha_manual(values = Alpha_Goal)+
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") { ## DENSITY ----
                  plot <- plot +
                      stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
                    scale_fill_gradient(high = teamColor, low = text_color) +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5)
                  
                } else if (type == "hexbin") { ## HEXBIN ----
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                    labs(
                      fill = "Count of Shots"
                    )
                }
              } else if (average_location == FALSE) {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") {
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      geom_image(data = filter(data, isGoal == "Goal"),
    mapping = aes(x = X, y = Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball3.png"), 
     by = "width", inherit.aes = TRUE
  ) +
                      
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } else if (highlight_goals == TRUE) {
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, fill = isGoal, alpha = isGoal, text = paste("Player:", player, "\nMin:", minute,  "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21,  stroke = 0.5) +
                      
                      geom_image(data = filter(data, isGoal == "Goal"),
    mapping = aes(x = X, y = Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball3.png"),
    by = "width", inherit.aes = TRUE
  ) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_alpha_manual(values = Alpha_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") {
                  plot <- plot +
                    stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
                    scale_fill_gradient(high = teamColor, low = text_color) +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(fill = "xG")
                  
                  
                } else if (type == "hexbin") {
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nOutcome:", result,  "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(
                      fill = "Count of Shots")
                } 
              }
              # Make Half pitch  
              plot <- plot +
                coord_flip(xlim = c(50, 100),
                           ylim = c(100, 0)) +
              scale_y_reverse()
              
              # formatting  
              plot <- plot +
                labs(title = shot_map_name, 
                     subtitle = fixture_name,
                     caption = My_caption) +
                
                theme(legend.position = "none",
                      legend.direction = "horizontal",
                      legend.background = element_rect(fill = "snow"),
                      legend.title = element_text(colour = colorText, face = "bold"),
                      legend.text = element_text(colour = colorText, size = 10),
                      legend.key = element_rect(fill = "snow"),
                      plot.title = element_markdown(),
                      plot.caption = element_markdown(),
                      plot.background = element_rect(colour = "snow", fill = "snow"),
                      panel.background = element_rect(colour = "snow", fill = "snow"),
                      plot.subtitle = element_text(colour = colorText, hjust = 0, size = 10))
              
              # wrap or not
              if (wrap == "Player") 
                {
                #divide stats by player
                player_stats <- data %>%
                  group_by(player) %>%
                  summarize(
                    total_xG = sum(xG),
                    total_goal = sum(result == "Goal"),
                    xg_sot = total_xG / n(),
                    total_shots = n(),
                    SOT = sum(OTShots)
                  )

                plot <- plot +
                  facet_wrap(~player) +
                  theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                        strip.text = element_text(size = 10, colour = text_color))
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = colorText, size = 2) +
                  geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                
                } else if (wrap == "Time") {
                  
                  #divide stats by time period
                  GPeriod_stats <- data %>%
                    group_by(Game_Period) %>%
                    summarize(
                      total_xG = sum(xG),
                      total_goal = sum(result == "Goal"),
                      xg_sot = total_xG / n(),
                      total_shots = n(),
                      SOT = sum(OTShots)
                    )
                  
                  
                    plot <- plot +
                      
                      facet_wrap(~ Game_Period) +
                      theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                            strip.text = element_text(size = 10, colour = text_color)) 
                    
                    plot <- plot +
                    geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = colorText, size = 2) +
                      geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                  
              } else if (wrap == "") {
                total_xG <- sum(data$xG)
                total_goal <- sum(data$result == "Goal")
                xg_sot <- total_xG / nrow(data)
                total_shots <- nrow(data)
                SOT <- sum(data$OTShots)
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 89.45, label = format(round(total_xG, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 89.45, label = "Total xG", color = colorText, size = 3) +
                  geom_point(x = 54, y = 71.05, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 71.05, label = format(round(SOT, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 71.05, label = "SOT", color = colorText, size = 3) +
                  geom_point(x = 54, y = 50, size = 12, color = pitch_lines, shape = 21, fill = fill_b, stroke = 0.5) +
                  
                  geom_text(x = 54, y = 50, label = format(round(total_shots, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 50, label = "Total Shots", color = colorText, size = 3) +  
                  geom_point(x = 54, y = 28.95, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 28.95, label = format(round(xg_sot, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 28.95, label = "xG/Shot", color = colorText, size = 3) +
                  geom_point(x = 54, y = 10.55, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 10.55, label = format(round(total_goal, 2)), color = colorText, size = 3) +
                  geom_text(x = 60, y = 10.55, label = "Goals", color = colorText, size = 3)
              
                Finalplot <- plot
              }
              
              # logo or not
              if (logo == "Yes") {
                
                # annotate plot
                Finalplot <- ggdraw() +
                  draw_plot(plot, x = 0, y = 0, width = 1, height = , scale = 1) +
                  draw_image(logo_AI,  x = 0.42, y = 0.45, scale = 0.07) 
                
              } else if (logo == "") {
                
                Finalplot <- plot
              }
              
              return(Finalplot)
              
             } else 
               {
              ## add WARNING that there were no rows in the data frame passed into function??
              return(plot)
    }
    }
  }

```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: Pass network plotting function

plot_passnet_AI <- function(data, 
                            team_name, 
                            scale_stat = "EPV",
                            scale_color = "firebrick2", 
                            text_color = "white", 
                            subtitle = "", 
                            plot_start = "00", 
                            plot_finish = "45", 
                            logo = "", 
                            pitch = "", 
                            wrap = "", 
                            pressmap = "", 
                            passes = "2", 
                            Facet_by = "Game_Period") {
  
  # ---- set up dynamic facet column
  facet_col <- rlang::sym(Facet_by)
  passes    <- as.numeric(passes)
  
    # Checking data frame 
    
    if ((nrow(data) > 0) &&
        sum(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "Game_Quarter", "player_shirt", "Successful_Passes") %in% names(data)) == 13) {
    } else {
      print(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "Game_Quarter", "player_shirt", "Successful_Passes"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
    
    # Generate error messages
    
    if (is.character(data$playerId) == FALSE) {
      stop("The playerId column is supposed to contain player names.")
    }
    
    if (is.character(data$TeamName) == FALSE) {
      stop("The TeamName column is supposed to contain team names.")
    }
  
    # full Pitch or half Pitch

    if  (pitch == "Half") { 
      data <- data %>%
        filter(x >= 50)
    
    }else if (pitch == "Full") {
      data <- data
    }
  # exclude set pieces and throw ins
  Pass_data <- data %>%
    filter(Attempted_Passes == 1)

      # Stat calculation
    
    if (scale_stat == "xT") {
      
      df <- Pass_data %>%
        calculate_threat(type = "opta")
      
      df <- df %>%
        mutate(xT = xTEnd - xTStart) %>%
        select(xT)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$xT
      
      leg_title <- "xT"
      
    } else if (scale_stat == "EPV") {
      
      df <- Pass_data %>%
        calculate_epv(type = "opta")
      
      df <- df %>%
        mutate(EPV = EPVEnd - EPVStart) %>%
        select(EPV)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$EPV
      
      leg_title <- "EPV"
      
    }
    
  # Calculate Pass percentage
  Pass_data <- Pass_data %>%
  replace_na(list(Attempted_Passes = 0, Successful_Passes = 0)) %>%
  mutate(stat = as.numeric(stat)) %>%
 replace_na(list(stat = 0))

  Pass_data <- Pass_data %>%
  mutate(Pass_Suc = if_else(Attempted_Passes > 0,
                                   Successful_Passes / Attempted_Passes, NA_real_))
  
  #set title text
    PassNetTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network</span>"))
  
  PassNetTitle_textD <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network & </span><span style='font-family:\"Arial\";color:gray12;font-size:14px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:14px;'>Unsuccessful</span><span style='color:gray12;font-size:14px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:14px;'>Successful</span><span style='color:gray12;font-size:14px;'>)</span>"))
  
    # wrap or not
    if (wrap == "Yes") {

      #calculate pressing date

if (pressmap == "Yes") {
  PressData <- data %>%
    filter(TeamName == team_name, Defensive_Action == 1)
}

plotCaption <- paste0(
  glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line = </span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span>"))

# ---- Data wrangling --------------------------------------------------------

# If you still want the "receiver" column by next event within period:

data1 <- Pass_data %>%
  filter(TeamName == team_name, !is.na(playerId)) %>%
  arrange(!!facet_col, expandedMinute) %>%
  group_by(!!facet_col) %>%
  mutate(receiver = dplyr::lead(playerId, n = 1)) %>%
  ungroup()


# ---- Nodes: player averages per chosen facet -----------------------
nodes <- data1 %>% 
  group_by(playerId, player_shirt, !!facet_col) %>% 
  summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# ---- Edgelist: successful passes per Facet choice ------------------
edgelist <- data1 %>%
  filter(Successful_Passes == 1) %>%
  select(from = playerId, to = receiver, !!facet_col) %>%
  filter(!is.na(to)) %>%
  group_by(from, to, !!facet_col) %>%
  summarise(n = dplyr::n(), .groups = "drop")

# ---- Coordinates for pass lines connections-----------------
coords <- nodes %>%
  select(playerId, !!facet_col, x, y)

# Join coords for 'from' and 'to' WITH chosen facet
edges <- edgelist %>%
  left_join(coords, by = join_by(from == playerId, !!facet_col)) %>%
  left_join(coords, by = join_by(to   == playerId, !!facet_col),
            suffix = c("", ".to")) %>%
  mutate(xend = x.to, yend = y.to) %>%
  mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  group_by(player1, player2, !!facet_col) %>%
  summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"
  ) %>%
  filter(Total_Passes >= passes)

# ---- Final tidy on nodes ---------------------------------------------------
nodes <- nodes %>%
  arrange(!!facet_col) %>%
  mutate(
    playerId        = ifelse(grepl(" ", playerId), sub(".*\\s", "", playerId), playerId),
    playerId_short  = if_else(grepl(" ", playerId), sub(".*\\s", "", playerId), playerId)
  )

# Plot the passnetwork
      
      plot_passnet <- ggplot() +
        
        #setup the pitch
        annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
        theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        
        #set scale and color gradient
        scale_colour_gradientn(
          colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        scale_size_continuous(range = c(0.5, 3)) +
        
        scale_fill_manual(values = c("#0000FF",  "red2"))
      
      if (pressmap == "Yes") {
        
        #plot pressing data
        plot_passnet <- plot_passnet +
          geom_point(
  data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1, show.legend = FALSE)
        
      } else if (pressmap == "") {
        
        plot_passnet <- plot_passnet
      }
      
        #plot player connections
        plot_passnet <- plot_passnet +
          geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25)), colour = "black", alpha = 0.8, show.legend = FALSE) +

        #plot player positions
          new_scale_color() +
          new_scale_fill() +
          geom_point(data = nodes, aes(x, y, fill = stat), size = 3, shape = 21, colour = "black", stroke = 0.5) +

        #plot player Numbers
        geom_text(data = nodes, aes(x, y, label = player_shirt), colour = "black", size = 1) +
        
        # set scale and colors

      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)),
        breaks = c(0, .25, .5, .75, 1),
        labels = scales::label_percent(accuracy = 1),
        name   = "Line Color = Passing Success") +  
          
        scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        #formatting
          labs(title = PassNetTitle_text,
               subtitle = plotCaption,
             x = "",
             colour = leg_title,
             caption = My_caption) +
          
            theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_blank()) +

        #Wrap the plots
          facet_wrap(as.formula(paste("~", Facet_by)), ncol = 4) +
          theme(strip.text.x = element_text(face = "bold", size = 10, colour = text_color),
              strip.background.x = element_rect(fill = scale_color, color = "black", linetype = "solid", linewidth = 1))

    } else if (wrap == "") {
      
      #calculate pressing date
      
      if (pressmap == "Yes") {
        
        data <- data %>%
          filter(between(expandedMinute, plot_start, plot_finish))
        
        PressData <- data %>%
          filter(TeamName == team_name) 
        
        PressData <- PressData %>%
          filter(Defensive_Action == 1)

      } else if (pressmap == "") {
        
      }
      
      plotCaption <- paste0(
  glue("
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><br>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>Line = </span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes, Larger Circle = More Passes</span>"))

            
            plotTag <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span"))
            
            plotExplaination <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Darker Circle Colour = Higher Threat (EPV)</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;', Darker Line = Higher Pass Completion, Direction of Attack Right to Left</span>"))

# Data Wrangling 
      
# Team + valid IDs
data1 <- Pass_data %>%
  dplyr::filter(TeamName == team_name) %>%
  dplyr::filter(!is.na(playerId))

# Create Receiver data
  data1 <- data1 %>%
  mutate(receiver = dplyr::lead(playerId, n = 1))

# Restrict time window (ensure plot_start/finish are numeric)
data1 <- data1 %>%
  dplyr::filter(dplyr::between(expandedMinute, as.numeric(plot_start), as.numeric(plot_finish)))

# Nodes (per player)
nodes <- data1 %>%
  dplyr::group_by(playerId, player_shirt) %>%
  dplyr::summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# Edgelist (successful passes between players)
edgelist <- data1 %>%
  dplyr::filter(Successful_Passes == 1) %>%
  dplyr::select(from = playerId, to = receiver) %>%
  dplyr::group_by(from, to) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%  
  tidyr::drop_na()

# Join coordinates
coords <- nodes %>% dplyr::ungroup() %>% dplyr::select(playerId, x, y)

edges <- edgelist %>%
  dplyr::left_join(coords, by = c("from" = "playerId")) %>%
  dplyr::rename(x = x, y = y) %>%
  dplyr::left_join(coords, by = c("to"   = "playerId"), suffix = c("", ".to")) %>%
  dplyr::rename(xend = x.to, yend = y.to)

# Collapse to undirected pairs
edges <- edges %>%
  dplyr::mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"                         
  ) %>%
  dplyr::filter(Total_Passes >= passes)

# Pass % per connection
PassStats <- data1 %>%
  dplyr::select(player1 = playerId, player2 = receiver,
                Successful_Passes, Attempted_Passes) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    n = dplyr::n(),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"                
  ) %>%
  tidyr::drop_na() %>%
  dplyr::mutate(Pass_Suc = dplyr::if_else(Attempted_Passes > 0,
                                          Successful_Passes / Attempted_Passes, NA_real_)) %>%
  tidyr::replace_na(list(Pass_Suc = 0))

edges <- edges %>%
  dplyr::left_join(PassStats %>% dplyr::select(player1, player2, Pass_Suc),
                   by = c("player1", "player2")) %>%
  tidyr::replace_na(list(Pass_Suc = 1))

# Final tidy on nodes
nodes <- nodes %>%
  dplyr::arrange(events) %>%
  dplyr::mutate(
    playerId_short = dplyr::if_else(grepl(" ", playerId),
                                    sub(".*\\s", "", playerId),
                                    playerId)
  )

      #set range for text to change on player circle
      EPVRange <- (max(nodes$stat)) * 0.7
      
      # Plot

    plot_passnet <- ggplot() +
      
      #setup the pitch
      annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
      theme_pitch() +
      annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      
      # add zone numbers
      geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
      
      #set scale and color gradient
      scale_fill_manual(values = c("#0000FF",  "red2"), labels = c("Won", "Lost"), name = "")

      
    if (pressmap == "Yes") {
      
      #plot pressing data
      plot_passnet <- plot_passnet +
        geom_point(data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1.5, stroke = 0.5, show.legend = FALSE)

    } else if (pressmap == "") {
     
      plot_passnet <- plot_passnet
      
    }
      
      #plot player connections
    plot_passnet <- plot_passnet +
      new_scale_fill() +
      
      geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25), colour = Pass_Suc)) +
      guides(linewidth = "none") +

      #plot player positions
      geom_point(data = nodes, aes(x, y, fill = stat, size = Attempted_Passes), shape = 21, colour = "black", stroke = 0.5) +
      
      # set colour
      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)),
        breaks = c(0, .25, .5, .75, 1),
        labels = scales::label_percent(accuracy = 1),
        name   = "Line Color = Passing Success") +
      
      scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
      
      # set scale
      scale_size_continuous(range = c(2, 10),
                        name = "Attempted Passes",
        guide = "none")
      
      plot_passnet <- plot_passnet +
      new_scale_color() +
      
      #plot player Numbers
      geom_text(data = nodes,
          aes(x, y, label = player_shirt,
              color = stat > EPVRange,
              size = Successful_Passes/4),
          show.legend = FALSE) +
      
      # set scale    
      scale_color_manual(values = c("TRUE" = "white", "FALSE" = "black"), guide = "none") +
      
      #formatting
      labs(title = PassNetTitle_text,
           subtitle = plotCaption,
           #tag = plotTag,
           x = "",
           colour = leg_title,
           caption = My_caption) +
      theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.tag = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_blank())
    }
    
    # If half pitch
    
    if (pitch == "Half") {
      
      plot_passnet <- plot_passnet +
        coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
        scale_y_reverse() +
        labs(y = " ") +
        theme(axis.title.y = element_blank(),
              axis.title.x = element_blank())
      
    } else if (pitch == "Full") {
      
      plot_passnet <- plot_passnet
      
    }
    
    # Press or not formatting
    
    if (pressmap == "Yes") {
      
      plot_passnet <- plot_passnet +

        #formatting
        labs(title = PassNetTitle_textD,
             x = "",
             colour = leg_title)
      
    } else if (pressmap == "") {
      
      plot_passnet <- plot_passnet
    }

    # logo or not
  
    if (logo == "Yes") {
    
    # annotate plot
    Finalplot_passnet <- plot_passnet +
    annotation_custom(AI_Logo, xmin = 90, xmax = 100, ymin = 105, ymax = 115) +
      coord_cartesian(clip = "off") +
      theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    
    } else if (logo == "") {
      
      Finalplot_passnet <- plot_passnet +
        theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    }

  return(Finalplot_passnet)
  #return(list(plot = Finalplot_passnet, nodes = nodes, edges = edges))

}
```


``` {r}
#| label: Dashboard Setup
#| echo: false
#| output: false
#| warning: false
#| message: false

library(tidyverse)
library(shiny)
library(gifski)
library(magick)
library(systemfonts)
library(sysfonts)
library(fontawesome)
library(glue)
library(worldfootballR)
library(gganimate)
library(ggsoccer)
library(paletteer)
library(ggpointdensity)
library(ggthemes)
library(ggtext)
library(ggiraph)
#library(ggiraphExtra)
library(ggimage)
library(gt)
library(gtExtras)
library(grid)
library(ggdensity)
library(treemapify)
library(magick)
library(readxl)
library(writexl)
library(chromote)
library(ggrepel)
library(png)
library(patchwork)
library(plotly)
library(reshape)
library(psych)
library(ggshakeR)
library(tidyquant)
library(gfonts)
library(extrafont)
library(extrafontdb)
library(ggnewscale)
library(stringr)
library(ggh4x)
library(ggforce)
library(scales)
library(slider)
library(rlang)

###############
#set team information
#set away
Match_Away <- paste0("Liverpool")

#Set Home
Match_Home <- paste0("Bournemouth")

#set match date
Game_date <- paste("24-01-2026")

#set Game name
GameName <- paste0(Match_Home," vs ", Match_Away)

#set fixture
Match_Fixture <- paste0(Match_Home, " vs ", Match_Away, " - ", Game_date)

#set database
DataBaseName <- paste0("EPLComp_LFC_Games_2526")

######################
#set colours
#set Away color
Color_Home <- paste("red")

#set Away text
Color_Home_Text <- paste("black")

#set away color scale
ColorScale_Home <- paste("ggsci::red_material")

#set away color scale con
ColorScale_HomeC <- paste("ggthemes::Red")

#set Home color
Color_Away <- paste("black")

#set home text color
Color_Away_Text <- paste("ivory")

#set home color scale
ColorScale_Away <- paste("ggsci::grey_material")

#set home color scale con
ColorScale_AwayC <- paste("ggthemes::Gray")

#####################
#load fonts
#set fonts
font_add("Awesome", regular = "/Library/Fonts/Font Awesome 7 Brands-Regular-400.otf")

#load match data
fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Season 2526/EPL Games/Processed Games/", Match_Fixture, ".xlsx")
plottingData <- read_xlsx(fileName)

#load player data
PlayerfileName <- paste0("~/Documents/Dropbox files/AI lfc data/Data Sets/WhoScored/Season 2526/EPL Players/Processed Games/", Match_Fixture, " - PlayerData.xlsx")
Playerdata <- read_xlsx(PlayerfileName)

#load season data
fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Databases/", DataBaseName, ".xlsx")
SeasonData <- read_xlsx(fileName)

#add in team group to data base
SeasonData <- SeasonData %>%
  mutate(Team_Group = ifelse(TeamName == "Liverpool", "Liverpool", "All Oppo"))

#set match day number
#MatchDay <- 21
#MatchDay <- 21
MatchDay <- first(na.omit(plottingData$Match_day))

#ser game date
Game_date <- first(na.omit(plottingData$Game_date))

#set game week
GameWeek <- paste0("MD ",MatchDay)

#set viz location for camcorder adn blue sky images
Vizlocation <- paste0("~/Documents/Dropbox files/AI LFC data/R files/AI UP/Scripts/Viz Pack/Season 2526/EPL/", GameWeek)

#set pk timte
PKTime <- 00

#redcard (min before)
redcard <- 00

#redcard (min before)
redcard2 <- 00

#set league points
League_Points <- 0
AFC_League_Points <- 00
MC_League_Points <- 00

#set man of the match
HMOM = paste("")
AMOM = paste("")

#set Waves titles
WavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

AwayWavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

#set xg line titles 
xGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

AwayxGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

#set dribbles title
DribblesTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Dribbles (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set duels title
DuelsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set PPs title
PPsTitle_textHalf <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayPPsTitle_textHalf <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

PPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

AwayPPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Z14 & HS Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

HomeTertiary_title <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Match  </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Possession</span><span style='color:grey12;font-size:16px;'> to </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Field Tilt</span><span style='color:gray12;font-size:16px;'> conversion</span>"))

AwayTertiary_title <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Match  </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Possession</span><span style='color:grey12;font-size:16px;'> to </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Field Tilt</span><span style='color:gray12;font-size:16px;'> conversion</span>"))

##new socials
social_caption <- function(twitter="@Barts78",
                           github = "Barts78",
                           linkedin= "Phil-barter",
                           mastodon= "@DrBarts",
                           threads = "Barts78",
                           data = "OPTA",
                           blueSky = "@barts78",
                           icon_color="black",
                           font_color="#454545",
                           bg_color="snow",
                           font_family="sans-serif"){
  
  icons = list(
    twitter = "&#xe61a",
    github = "&#xf09b",
    linkedin = "&#xf08c",
    mastodon = "&#xf4f6",
    threads = "&#xe618",
    data = "&#xf16b",
    blueSky = "&#xe671"
  )   
  
  social = list(threads = threads, linkedin = linkedin, twitter = twitter, mastodon = mastodon, github = github, blueSky = blueSky, data = data)
  social = social[!is.na(social)]
  
  caption = ""
  for (name in names(social)) {
    icon = icons[name]
    info = social[name]
    html = glue("<span style='font-family:\"Font Awesome 7 Brands\";color:{icon_color};font-size:8px;'>{icon};</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>
                <span style='font-family:{font_family};color:{font_color};font-size:8px;'>{info}</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>")
    
    
    caption = paste0(caption,html)
  }
  
  caption
}

#create social caption
my_socials <- social_caption(twitter = "@Barts78",
                             github = "Barts78",
                             linkedin = "Phil-barter",
                             mastodon = "@DrBarts",
                             threads = NA,
                             blueSky = "@barts78",
                             data = "OPTA",
                             icon_color = "#454545",
                             font_color = "#454545",
                             bg_color = "snow",
                             font_family = "sans-serif")

my_datasource <- paste0('<span style="font-family:\'Font Awesome 7 Free\', Arial, sans-serif;color:#454545;font-size:8px;">&#x1F4BE;</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>',
                        '<span style="font-family:sans-serif;color:#454545;font-size:8px;">OPTA</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>')

My_caption <- paste0(my_socials)

```

```{r}
#| output: false
#| label: set Summary values
#| message: false
#| warning: false

#set summary values
Total_EPV <- sum(plottingData$Cumalative_EPV)
GameTime <- max(plottingData$expandedMinute)
OutofPlayTime <- round(sum(plottingData$Out_of_play_time)/60,2)
InPlayTime <- round(sum(plottingData$In_play_time)/60,2)
Possession <- round(sum(plottingData$Touches),2)
HomePossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName == Match_Home))/Possession)*100),2)
AwayPossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName == Match_Away))/Possession)*100),2)
HomeEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomeEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexT <- round(sum(plottingData$xTvalue[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxT <- round(sum(plottingData$xTvalue[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexTA <- round(sum(plottingData$TeamxT[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxTA <- round(sum(plottingData$TeamxT[plottingData$TeamName == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexG <- round(sum(plottingData$xG[plottingData$TeamName == Match_Home]),2)
AwayxG <- round(sum(plottingData$xG[plottingData$TeamName == Match_Away]),2)
HomeNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName == Match_Home]),2)
AwayNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName == Match_Away]),2)
HomeBCs <- round(sum(plottingData$BCs[plottingData$TeamName == Match_Home]),0)
AwayBCs <- round(sum(plottingData$BCs[plottingData$TeamName == Match_Away]),0)
Final_Third_Possession <- round(sum(plottingData$Final_Third_Touches),2)
HomeFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName == Match_Home))/Final_Third_Possession)*100),2)
AwayFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName == Match_Away))/Final_Third_Possession)*100),2)
HomeDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName == Match_Home]),0)
AwayDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName == Match_Away]),0)
HomePasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName == Match_Home]),0)
AwayPasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName == Match_Away]),0)
HomePPDA <- round(sum(AwayPasses/HomeDActions),2)
AwayPPDA <- round(sum(HomePasses/AwayDActions),2)
HomeEPVCon <- round(sum(HomexG/HomeEPVA),2)
AwayEPVCon <- round(sum(AwayxG/AwayEPVA),2)
HomeProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName == Match_Home]),2)
AwayProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName == Match_Away]),2)
HomeCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName == Match_Home]),2)
HomeProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName == Match_Home]),2)
AwayCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName == Match_Away]),2)
AwayProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName == Match_Away]),2)
HomeGoals <- round(sum(plottingData$Home_Goals),0)
HomeSOT <- round(sum(plottingData$OTShots[plottingData$TeamName == Match_Home]),0)
HomeShootingP <- round(sum(HomeGoals/HomeSOT), 2)
AwayGoals <- round(sum(plottingData$Away_Goals),0)
AwaySOT <- round(sum(plottingData$OTShots[plottingData$TeamName == Match_Away]),0)
AwayShootingP <- round(sum(AwayGoals/AwaySOT), 2)
HomePPDO <- round(sum(HomeShootingP + (1 - AwayShootingP))*1000, 0)
AwayPPDO <- round(sum(AwayShootingP + (1 - HomeShootingP))*1000, 0)

#prepare first sub time data (min before sub)
firstSubHome <- plottingData %>%
  filter(TeamName == Match_Home, SubTime != 0) %>%
  summarise(firstsubhome = min(SubTime)) %>%
  pull(firstsubhome)

firstSubAway <- plottingData %>%
  filter(TeamName == Match_Away, SubTime != 0) %>%
  summarise(firstsubaway = min(SubTime)) %>%
  pull(firstsubaway)

#first goal
plottingData <- plottingData %>%
  mutate(First_goal = if_else(`type/value` == 16, as.numeric(expandedMinute), NA_real_)) %>%
  mutate(First_goal = min(First_goal, na.rm = TRUE))

First_Goal <- first(na.omit(plottingData$First_goal))


# set-up data frame from main variables above for summary tables
PPDOTable <- data.frame(TeamName = c(Match_Home, Match_Away),
                         PPDO = c(HomePPDO, AwayPPDO))

plottingData <- plottingData %>%
  mutate('Game_Quarter' = ifelse(minute < 26 & period == 1, "1st Quarter",
                                ifelse(minute < 51 & minute > 25 & period == 1, "2nd Quarter",
                                       ifelse(minute < 71 & minute > 50 & period == 2, "3rd Quarter",
                                              ifelse(minute < 100 & minute > 70 & period == 2, "4th Quarter", "Injury Time")))))

#open play crosses

#plottingData <- plottingData %>%
#  mutate(Open_play_Crosses = as.integer(Cross_Passes == 1 & Corners == 0),
#         Successful_Open_play_Crosses = as.integer(Open_play_Crosses == 1 & `outcomeType/value` == 1),
#                  UnSuccessful_Open_play_Crosses = as.integer(Open_play_Crosses == 1 & `outcomeType/value` == 0))

```

# Line Up

```{r}
#| label: lineup setup
#| output: false

Playerdata <- Playerdata %>%
  filter(role == "Substitute") %>%
    select(Team = TeamName, Player = PlayerName, Shirt_Number = jerseyNumber, Mins_Played = substitution_minute, role) %>%
    replace_na(list(Mins_Played = 0))

MD_lineups <- plottingData %>%
  select(TeamName, playerId, playerNumber, Shirt_Number = player_shirt, role, minutes_played) %>%
  group_by(playerId, TeamName) %>%
  replace_na(list(minutes_played = 0)) %>%
  summarise(Mins_Played = min(minutes_played),  playerNumber = first(playerNumber), Shirt_Number = first(Shirt_Number),
    role = first(role), .groups = "drop") %>%
  select(Team = TeamName, Player = playerId, Shirt_Number, Mins_Played, role)

MD_lineups <- bind_rows(MD_lineups, Playerdata)

```

## Row {.flow}
### column
```{r}
#| label: Line up Home
#| message: false
#| warning: false
#| results: asis
lineupdataHome <- MD_lineups %>%
  filter(Team == Match_Home) %>%
  arrange(desc(Mins_Played)) %>%
  mutate(role = factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward", "Substitute"))) %>%
  arrange(role) %>%
  
  #lineupdataHome <- lineupdataHome %>%
  gt(groupname_col = "role") %>%
  cols_hide(Team) %>%
  cols_move_to_end(columns = c(Shirt_Number, Player)) %>%
  #cols_move_to_end(columns = c(Player, Shirt_Number, Mins_Played, Sub_On)) %>%
  #row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward", "Substitute")) %>%
  cols_align(align = "right", columns = (rev(everything()))) %>%
  tab_header(
    title = paste0(Match_Home, " Line up"),
    subtitle = paste0(Match_Fixture)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_style(
    style = list(cell_text(align = "right"), 
                 cell_fill(color = "#E5E5E5")),
    locations = cells_body(columns = "Player")) %>%
    tab_style(
    style = cell_text(color = "#E5E5E5"),
    locations = cells_column_labels('Player')) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text, align = "right"), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "Right",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 20,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
lineupdataHome
```
### column
```{r}
#| label: Line up Away
#| message: false
#| warning: false
#| results: asis

lineupdataAway <- MD_lineups %>%
  filter(Team == Match_Away) %>%
  arrange(desc(Mins_Played)) %>%
  gt(groupname_col = "role", rowname_col = "Player") %>%
  cols_hide(Team) %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward", "Substitute")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Line up"),
    subtitle = paste0(Match_Fixture)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text, align = "left"), 
                 cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "Left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 20,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")

lineupdataAway
```

# Match Summary
``` {r}
#| output: false
#| label: Season summary table setup averages
#posession and goals by team
MatchSummarySeasonData <- compute_season_summary(SeasonData, group_vars = c("Team_Group")) 

MatchSummarySeasonData <- MatchSummarySeasonData %>%
  select('Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonHalfData <- compute_season_summary(SeasonData %>% mutate(Half = case_when(
  period == 1 ~ "First Half",
  period == 2 ~ "Second Half",
  period == 3 ~ "First Half Extra Time",
  period == 4 ~ "Second Half Extra Time",
  TRUE ~ "Injury Time")
), group_vars = c("Half", "Team_Group"))

MatchSummarySeasonHalfData <- MatchSummarySeasonHalfData %>%
  select(Half, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonPeriodData <- compute_season_summary(SeasonData, group_vars = c("Game_Period", "Team_Group"))

MatchSummarySeasonPeriodData <- MatchSummarySeasonPeriodData %>%
  select(Game_Period, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonGameStateData <- compute_season_summary(SeasonData, group_vars = c("Game_State", "Team_Group"))

MatchSummarySeasonGameStateData <- MatchSummarySeasonGameStateData %>%
  select(Game_State, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryGameNameData <- compute_summary(SeasonData, group_vars = c("game_name", "Team_Group"))

MatchSummaryGameNameData <- MatchSummaryGameNameData %>%
  select('Fixture' = game_name, Match_day, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

```
``` {r}
#| output: false
#| label: Season summary table setup Totals
#posession and goals by team
MatchSummarySeasonData <- compute_summary(SeasonData, group_vars = c("Team_Group")) 

MatchSummarySeasonData <- MatchSummarySeasonData %>%
  select('Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonHalfData <- compute_summary(SeasonData %>% mutate(Half = case_when(
  period == 1 ~ "First Half",
  period == 2 ~ "Second Half",
  period == 3 ~ "First Half Extra Time",
  period == 4 ~ "Second Half Extra Time",
  TRUE ~ "Injury Time")
), group_vars = c("Half", "Team_Group"))

MatchSummarySeasonHalfData <- MatchSummarySeasonHalfData %>%
  select(Half, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonPeriodData <- compute_summary(SeasonData, group_vars = c("Game_Period", "Team_Group"))

MatchSummarySeasonPeriodData <- MatchSummarySeasonPeriodData %>%
  select(Game_Period, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonGameStateData <- compute_summary(SeasonData, group_vars = c("Game_State", "Team_Group"))

MatchSummarySeasonGameStateData <- MatchSummarySeasonGameStateData %>%
  select(Game_State, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryGameNameData <- compute_summary(SeasonData, group_vars = c("game_name", "Team_Group"))

MatchSummaryGameNameData <- MatchSummaryGameNameData %>%
  select('Fixture' = game_name, Match_day, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

```


``` {r}
#| output: false
#| message: false
#| warning: false
#| label: Match summary table setup
#posession and goals by team
MatchSummaryData <- compute_summary(plottingData, group_vars = c("TeamName")) 


MatchSummaryData <- MatchSummaryData %>%
  left_join(PPDOTable, by = c("TeamName" = "TeamName"), copy = TRUE) 


MatchSummaryData <- MatchSummaryData %>%
  select('Team' = TeamName, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, 'Blocked Shots' = Blocked_Shot, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'EPV % NPxG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, PPDO, 'Possession Control' = Posession_Control)

MatchSummaryHalfData <- compute_summary(plottingData %>% mutate(Half = case_when(
  period == 1 ~ "First Half",
  period == 2 ~ "Second Half",
  period == 3 ~ "First Half Extra Time",
  period == 4 ~ "Second Half Extra Time",
  TRUE ~ "Injury Time")
), group_vars = c("Half", "TeamName"))

MatchSummaryHalfData <- MatchSummaryHalfData %>%
  select(Half, 'Team' = TeamName, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, 'Blocked Shots' = Blocked_Shot, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'EPV % NPxG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control)

MatchSummaryPeriodData <- compute_summary(plottingData, group_vars = c("Game_Period", "TeamName"))

MatchSummaryPeriodData <- MatchSummaryPeriodData %>%
  select(Game_Period, 'Team' = TeamName, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, 'Blocked Shots' = Blocked_Shot, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'EPV % NPxG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control)

MatchSummaryQuarterData <- compute_summary(plottingData, group_vars = c("Game_Quarter", "TeamName"))

MatchSummaryQuarterData <- MatchSummaryQuarterData %>%
  select(Game_Quarter, 'Team' = TeamName, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, 'Blocked Shots' = Blocked_Shot, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'EPV % NPxG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control)

MatchSummaryGameStateData <- compute_summary(plottingData, group_vars = c("Game_State", "TeamName"))

MatchSummaryGameStateData <- MatchSummaryGameStateData %>%
  select(Game_State, 'Team' = TeamName, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, 'Blocked Shots' = Blocked_Shot, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'EPV % NPxG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control)

```
```{r}
#| output: false
#| message: false
#| warning: false
#| label: Match MC setup

#Load data (opta Data)
dashboard_data <- plottingData

#Home team Dashboard data
dashboard_data <- dashboard_data %>%
  filter(TeamName == Match_Home) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, expandedMinute, type, period)

#Away dashboard data
#Load data
Awaydashboard_data <- plottingData

Awaydashboard_data <- Awaydashboard_data %>%
  filter(TeamName == Match_Away) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, expandedMinute, type, period)

#Matchday MC Data setup
HomexGMC <- HomeShots <- dashboard_data %>%
  filter(period != 5) %>%
  select(xG)
AwayxGMC <- AwayShots <- Awaydashboard_data %>%
  filter(period != 5) %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(dashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(Awaydashboard_data$type == "Goal", 1, NA)))


#run MC for Match outcomes and Match Score proablity
sim_results <- simulate_match_outcomes(home_xg_vector = HomexGMC, away_xg_vector = AwayxGMC, seed = 1111, runs = 10000, actual_home_goals = HomeTotalGoals, actual_away_goals = AwayTotalGoals)

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(sim_results$prob_matrix[upper.tri(sim_results$prob_matrix)])*100)
Home_wins_prob <- (sum(sim_results$prob_matrix[lower.tri(sim_results$prob_matrix)])*100)
tie_prob <- (sum(diag(sim_results$prob_matrix))*100)

# Create a data frame for Match outcome bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability, 2))

#create data frame for Match score tile plot
long_prob_matrix <- sim_results$long_prob_matrix

#redo factor to numeric the score probablity
long_prob_matrix <- long_prob_matrix %>%
  mutate(Home = as.numeric(as.character(Home)),
         Away = as.numeric(as.character(Away)))


# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

## Row {.tabset}
```{r}
#| title: Match Summary tables
#| label: Summary tables
#| results: asis
MatchSummaryTable <- MatchSummaryData %>%
  gt(groupname_col = "Team") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - Full Time**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(3, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(2, 6, 20:21, 24, 26, 28),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(2:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:18)) %>%
  tab_spanner(label = "Passes", columns = c(19:26)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = Match_Away)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = Match_Home)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 
MatchSummaryTable

MatchSummaryHalfsTable <- MatchSummaryHalfData %>%
  gt(rowname_col = "Team", groupname_col = "Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Half**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 17:20),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 21:22, 25, 27, 29),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:19)) %>%
  tab_spanner(label = "Passes", columns = c(20:27)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryHalfData$Half)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryHalfsTable

MatchSummaryPeriodTable <- MatchSummaryPeriodData %>%
  gt(rowname_col = "Team", groupname_col = "Game_Period") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Game Period**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 17:20),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 21:22, 25, 27, 29),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:19)) %>%
  tab_spanner(label = "Passes", columns = c(20:27)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryPeriodData$Game_Period)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%

  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryPeriodTable

MatchSummaryQuarterTable <- MatchSummaryQuarterData %>%
  gt(rowname_col = "Team", groupname_col = "Game_Quarter") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Game Quarter**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 17:20),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 21:22, 25, 27, 29),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:19)) %>%
  tab_spanner(label = "Passes", columns = c(20:27)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryPeriodData$Game_Quarter)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%

  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryQuarterTable

MatchSummaryGameStateTable <- MatchSummaryGameStateData %>%
  gt(rowname_col = "Team", groupname_col = "Game_State") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Game State**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  #cols_hide(`Possession %`) %>%
  fmt_number(
    columns = c(4, 17:20),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 21:22, 25, 27, 29),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:19)) %>%
  tab_spanner(label = "Passes", columns = c(20:27)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryGameStateData$Game_State)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryGameStateTable

```

``` {r}
#| title: Season Summary Tables
#| results: asis
#| label: Season summary tables


MatchSummarySeasonTable <- MatchSummarySeasonData %>%
  gt(groupname_col = "Team") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - Full Games**"),
    subtitle = paste0("Up to ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(3, 14:17),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(2, 6, 19, 22, 24, 26, 30),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = "white"), cell_fill(color = "black")),
    locations = cells_row_groups(groups = "All Oppo")) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = "white"), cell_fill(color = "red4")),
    locations = cells_row_groups(groups = "Liverpool")) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "#B22222",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 
MatchSummarySeasonTable

MatchSummarySeasonHalfsTable <- MatchSummarySeasonHalfData %>%
  gt(rowname_col = "Team", groupname_col = "Half") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Half**"),
    subtitle = paste0("Up to ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryHalfData$Half)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
    tab_style(
    style = list(cell_fill(color = "red4"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"Liverpool"
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = "black"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"All Oppo"
    )
  ) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonHalfsTable

MatchSummarySeasonPeriodTable <- MatchSummarySeasonPeriodData %>%
  gt(rowname_col = "Team", groupname_col = "Game_Period") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game Period**"),
    subtitle = paste0("Up to ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryPeriodData$Game_Period)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    style = list(cell_fill(color = "red4"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"Liverpool"
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = "black"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"All Oppo"
    )
  ) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonPeriodTable

MatchSummarySeasonGameStateTable <- MatchSummarySeasonGameStateData %>%
  gt(rowname_col = "Team", groupname_col = "Game_State") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game State**"),
    subtitle = paste0("Up to ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(5, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    style = list(cell_fill(color = "red4"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"Liverpool"
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = "black"),
                 cell_text(size = 16, weight = "bold", color = "white")),
    locations = cells_stub(
      rows = Team == !!"All Oppo"
    )
  ) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryGameStateData$Game_State)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonGameStateTable

MatchSummaryGameNameData <- MatchSummaryGameNameData %>%
  mutate(Match_day = as.numeric(Match_day)) %>%
  filter(!Match_day == 0) %>%
  arrange(Match_day)
  
  MatchSummaryGameNameTable <- MatchSummaryGameNameData %>%
  gt(rowname_col = "Team", groupname_col = "Match_day") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Match Day**"),
    subtitle = paste0("Up to ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(6, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(4, 8, 21, 24, 26, 28, 32),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryGameNameData$Match_day)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameNameData$Team == "All Oppo")),
    style = list(cell_fill(color = "black"),
                 cell_text(size = 16, weight = "bold", color = "white"))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameNameData$Team == "Liverpool")),
    style = list(cell_fill(color = "red4"),
                cell_text(size = 16,  weight = "bold", color = "white"))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryGameNameTable

```

## Row {.flow}
```{r}
#| label: Match Goals Probablity Plot
# Create a tiled plot for the MC Match scores
MD_MC_Plot <- ggplot(long_prob_matrix, aes(x = as.numeric(Home), y = as.numeric(Away), fill = Probability)) +
  geom_tile(colour = "black") +
  geom_text(aes(label = paste(Probability, "%")), size = 4, color = if_else(long_prob_matrix$Probability > 4.5, Color_Home_Text, Color_Away_Text),) +
        scale_fill_gradientn(
        colors = c(Color_Away, Color_Home),
        values = scales::rescale(c(0, 1)), 
        name = "Probablity") +
  scale_x_continuous(breaks = seq(0, max(long_prob_matrix$Home), 1)) +
  scale_y_continuous(breaks = seq(0, max(long_prob_matrix$Away), 1)) +
  labs(title = paste("Match Final Score Probablity (10000 sims)"),
        subtitle = paste(Match_Fixture),
        x = paste0(Match_Home, " Goals"), 
        y = paste0(Match_Away, " Goals"),
        caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Plot

#save Plot
ggsave(path = Vizlocation, "Match Goals Probality Plot.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
```{r}
#| label: Match Result Probablity Plot
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot

#save Plot
ggsave(path = Vizlocation, "Match Result Probablity Plot.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
## Row {.flow}
```{r}
#|label: Home Match teratitory plot
#data imports
df <- plottingData %>%
  arrange(expandedMinute) %>%
  mutate(
    possession_roll5 = slide_dbl(Home_Possession,
                                 mean,
                                 .before = 4,   
                                 .complete = TRUE),
    Field_tilt_roll5 = slide_dbl(Home_FThird_Possession,
                                 mean,
                                 .before = 4,   
                                 .complete = TRUE)) %>% 
  
  select(expandedMinute, Home_Possession, Away_Possession, TeamName, possession_roll5, Field_tilt_roll5, Home_FThird_Possession, Away_FThird_Possession) %>%   
  mutate(across(everything(), ~replace_na(., 0))) %>%
  mutate(
    Possession_diff = possession_roll5 - Field_tilt_roll5   # positive = home leading
  )

# 2) Smooth the two lines into 'pred' (loess) and clamp to [0,1]
lo_home <- loess(possession_roll5  ~ expandedMinute, data = df, span = 0.2, na.action = na.exclude)
lo_away <- loess(Field_tilt_roll5  ~ expandedMinute, data = df, span = 0.2, na.action = na.exclude)

pred <- tibble(expandedMinute = sort(unique(df$expandedMinute))) %>%
  mutate(
    home_s = pmax(0, pmin(1, predict(lo_home, newdata = cur_data()))),
    away_s = pmax(0, pmin(1, predict(lo_away, newdata = cur_data())))
  )



#data wrangling 
seg <- pred %>%
  arrange(expandedMinute) %>%
  mutate(
    xmin = expandedMinute,
    xmax = lead(expandedMinute),
    home_next = lead(home_s),
    away_next = lead(away_s)
  ) %>%
  filter(!is.na(xmax)) %>%
  mutate(
    ymin = pmin(home_s, away_s, home_next, away_next),
    ymax = pmax(home_s, away_s, home_next, away_next),
    leader = ifelse(home_s > away_s, "home", "away")
  )

eps <- 1e-3  # small tolerance around crossings

# seg must already have: expandedMinute, home_s, away_s
rib <- seg %>%
  arrange(expandedMinute) %>%
  mutate(
    ymin = pmin(home_s, away_s),
    ymax = pmax(home_s, away_s),
    home_on_top = home_s > away_s + eps,
    away_on_top = away_s > home_s + eps
  )

# Two masked ribbons (no overlap)
rib_home <- rib %>%
  mutate(ymin = ifelse(home_on_top, ymin, NA_real_),
         ymax = ifelse(home_on_top, ymax, NA_real_))

rib_away <- rib %>%
  mutate(ymin = ifelse(away_on_top, ymin, NA_real_),
         ymax = ifelse(away_on_top, ymax, NA_real_))
#plot the ribbons and lines
ggplot() +
  # ribbon when HOME is above
  geom_ribbon(data = rib_home,
              aes(x = expandedMinute, ymin = ymin, ymax = ymax),
              fill = Color_Home, alpha = 0.30, color = NA) +
  # ribbon when AWAY is above
  geom_ribbon(data = rib_away,
              aes(x = expandedMinute, ymin = ymin, ymax = ymax),
              fill = Color_Away, alpha = 0.30, color = NA) +


  # smoothed lines
  geom_line(data = seg, aes(x = expandedMinute, y = home_s),
            linewidth = 1.2, color = Color_Home) +
  geom_line(data = seg, aes(x = expandedMinute, y = away_s),
            linewidth = 1.2, color = Color_Away) +
  
  scale_fill_manual(
    values = c("home" = Color_Home, "away" = Color_Away),
    name   = "Tertiary",
    labels = c("home" = "Possession (red)", "away" = "Field Tilt (blue)")
  ) +
  
  scale_y_continuous(
    labels = label_percent(accuracy = 1),   # show 25% instead of 0.25
    limits = c(0, 1)                        # keep axis from 0% to 100%
  ) +
  scale_x_continuous(breaks = seq(0, max(seg$expandedMinute), 15)) +
  
  labs(
    title    = HomeTertiary_title,
    subtitle = Match_Fixture,
    x        = "Match Time (Mins)",
    y        = "Possession (%)",
    caption  = My_caption
  ) +
  coord_cartesian(ylim = c(0, 1), clip = "off") +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.background = element_rect(fill = "snow"),
    legend.key = element_rect(fill = "snow"),
    plot.background = element_rect(colour = "snow", fill = "snow"),
    panel.background = element_rect(colour = "snow", fill = "snow"),
    plot.title = element_markdown(),
    plot.subtitle = element_markdown(),
    plot.caption = element_markdown(),
    legend.title = element_text(colour = "black", size = 6),
    legend.text  = element_text(colour = "black", size = 6),
    axis.title = element_text(colour = "black", size = 8),
    
    plot.margin  = margin(28, 20, 48, 20)
  ) +
  # team labels
  annotate("label",
           x = max(pred$expandedMinute) / 2, y = 1,
           label = paste(Match_Away, " Defensive Goal Line"), vjust = 0, hjust = 0.5,
           size = 4, color = Color_Away_Text, fontface = "bold", fill = Color_Away) +
  annotate("label",
           x = max(pred$expandedMinute) / 2, y = 0.05,
           label = paste(Match_Home, " Defensive Goal Line"), vjust = 1, hjust = 0.5,
           size = 4, color = Color_Home_Text, fontface = "bold", fill = Color_Home)

```
```{r}
#|label: Away Match teratitory plot
#data imports
df <- plottingData %>%
  arrange(expandedMinute) %>%
  mutate(
    possession_roll5 = slide_dbl(Away_Possession,
                                 mean,
                                 .before = 4,   
                                 .complete = TRUE),
    Field_tilt_roll5 = slide_dbl(Away_FThird_Possession,
                                 mean,
                                 .before = 4,   
                                 .complete = TRUE)) %>% 
  
  select(expandedMinute, Home_Possession, Away_Possession, TeamName, possession_roll5, Field_tilt_roll5, Home_FThird_Possession, Away_FThird_Possession) %>%   
  mutate(across(everything(), ~replace_na(., 0))) %>%
  mutate(
    Possession_diff = possession_roll5 - Field_tilt_roll5   # positive = home leading
  )

# 2) Smooth the two lines into 'pred' (loess) and clamp to [0,1]
lo_home <- loess(possession_roll5  ~ expandedMinute, data = df, span = 0.2, na.action = na.exclude)
lo_away <- loess(Field_tilt_roll5  ~ expandedMinute, data = df, span = 0.2, na.action = na.exclude)

pred <- tibble(expandedMinute = sort(unique(df$expandedMinute))) %>%
  mutate(
    home_s = pmax(0, pmin(1, predict(lo_home, newdata = cur_data()))),
    away_s = pmax(0, pmin(1, predict(lo_away, newdata = cur_data())))
  )

#pred <- df %>% transmute(expandedMinute, home_s = possession_roll5, away_s = Field_tilt_roll5).

#data wrangling 
seg <- pred %>%
  arrange(expandedMinute) %>%
  mutate(
    xmin = expandedMinute,
    xmax = lead(expandedMinute),
    home_next = lead(home_s),
    away_next = lead(away_s)
  ) %>%
  filter(!is.na(xmax)) %>%
  mutate(
    ymin = pmin(home_s, away_s, home_next, away_next),
    ymax = pmax(home_s, away_s, home_next, away_next),
    leader = ifelse(home_s > away_s, "home", "away")
  )

eps <- 1e-3  # small tolerance around crossings

# seg must already have: expandedMinute, home_s, away_s
rib <- seg %>%
  arrange(expandedMinute) %>%
  mutate(
    ymin = pmin(home_s, away_s),
    ymax = pmax(home_s, away_s),
    home_on_top = home_s > away_s + eps,
    away_on_top = away_s > home_s + eps
  )

# Two masked ribbons (no overlap)
rib_home <- rib %>%
  mutate(ymin = ifelse(home_on_top, ymin, NA_real_),
         ymax = ifelse(home_on_top, ymax, NA_real_))

rib_away <- rib %>%
  mutate(ymin = ifelse(away_on_top, ymin, NA_real_),
         ymax = ifelse(away_on_top, ymax, NA_real_))
#plot the ribbons and lines
ggplot() +
  # ribbon when HOME is above
  geom_ribbon(data = rib_home,
              aes(x = expandedMinute, ymin = ymin, ymax = ymax),
              fill = Color_Home, alpha = 0.30, color = NA) +
  # ribbon when AWAY is above
  geom_ribbon(data = rib_away,
              aes(x = expandedMinute, ymin = ymin, ymax = ymax),
              fill = Color_Away, alpha = 0.30, color = NA) +


  # smoothed lines
  geom_line(data = seg, aes(x = expandedMinute, y = home_s),
            linewidth = 1.2, color = Color_Home) +
  geom_line(data = seg, aes(x = expandedMinute, y = away_s),
            linewidth = 1.2, color = Color_Away) +
  
  scale_fill_manual(
    values = c("home" = Color_Home, "away" = Color_Away),
    name   = "Tertiary",
    labels = c("home" = "Possession (red)", "away" = "Field Tilt (blue)")
  ) +
  
  scale_y_continuous(
    labels = label_percent(accuracy = 1),   # show 25% instead of 0.25
    limits = c(0, 1)                        # keep axis from 0% to 100%
  ) +
  scale_x_continuous(breaks = seq(0, max(seg$expandedMinute), 15)) +
  
  labs(
    title    = AwayTertiary_title,
    subtitle = Match_Fixture,
    x        = "Match Time (Mins)",
    y        = "Possession (%)",
    caption  = My_caption
  ) +
  coord_cartesian(ylim = c(0, 1), clip = "off") +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.background = element_rect(fill = "snow"),
    legend.key = element_rect(fill = "snow"),
    plot.background = element_rect(colour = "snow", fill = "snow"),
    panel.background = element_rect(colour = "snow", fill = "snow"),
    plot.title = element_markdown(),
    plot.subtitle = element_markdown(),
    plot.caption = element_markdown(),
    legend.title = element_text(colour = "black", size = 6),
    legend.text  = element_text(colour = "black", size = 6),
    axis.title = element_text(colour = "black", size = 8),
    
    plot.margin  = margin(28, 20, 48, 20)
  ) +
  # team labels
  annotate("label",
           x = max(pred$expandedMinute) / 2, y = 1,
           label = paste(Match_Home, " Defensive Goal Line"), vjust = 0, hjust = 0.5,
           size = 4, color = Color_Home_Text, fontface = "bold", fill = Color_Home) +
  annotate("label",
           x = max(pred$expandedMinute) / 2, y = 0.05,
           label = paste(Match_Away, " Defensive Goal Line"), vjust = 1, hjust = 0.5,
           size = 4, color = Color_Away_Text, fontface = "bold", fill = Color_Away)

```


``` {r}
#| output: false
#| message: false
#| warning: false
#MC Season calculations for top three
#load data

#Awaydashboard__Season_data <- Awaydashboard__Season_data %>%
#  filter(TeamName == Match_Away) %>%
#  filter(TotalShots == 1) %>%
#  filter(!situation == "NA") %>%
#  mutate(TotalxG = cumsum(xG)) %>%
#  mutate(TotalNPxG = cumsum(NPxG)) %>%
#  mutate(TotalxGOT = cumsum(xGOT)) %>%
#  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
#  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
#  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
#  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
#  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, #TotalShots, xG, NPxG, xGOT, expandedMinute, type)

AwayShotsALL <- Awaydashboard_data %>%
  select(xGA = xG)

HomeShotsALL <- dashboard_data %>%
  select(xG)

#predit seaosn on a match by match basis
# Set simulation parameters
n_sims <- 10000  # Number of simulations
n_games <- 38    # Number of games in season
remaining_games <- 38
#- n_games
current_points <- League_Points
win_prob <- 0.5   # Probability of winning a game (adjust as needed)
draw_prob <- 0.5 # Probability of drawing a game (adjust as needed)
#loss_prob <- 1 - win_prob - draw_prob
loss_prob <- 0.5

# Simulate goals scored and conceded using appropriate distributions
# (adjust distributions and parameters based on your data or assumptions)
goals_scored <- rpois(n_sims * n_games, lambda = HomeShotsALL$xG)  # Poisson distribution for goals scored
goals_conceded <- rpois(n_sims * n_games, lambda = AwayShotsALL$xGA)  # Poisson distribution for goals conceded

# Reshape data into a single data frame for clarity
sim_data <- data.frame(
  sim_id = rep(1:n_sims, each = n_games),
  game_id = 1:n_games,
  goals_scored = goals_scored,
  goals_conceded = goals_conceded
)

# Calculate points per game for each simulated team
sim_data <- sim_data %>%
  mutate(
    points = case_when(
      goals_scored > goals_conceded ~ 3,
      goals_scored == goals_conceded ~ 1,
      TRUE ~ 0
    )
  )

P_Season = (remaining_games/38)
#print(P_Season)

# Calculate total points per season for each simulation
season_totals <- sim_data %>%
  group_by(sim_id) %>%
  summarise(total_points = sum(points) * P_Season + current_points)

# Limit total points to the maximum possible (current + remaining games * 3)
season_totals <- season_totals %>%
  mutate(total_points = pmin(total_points, current_points + remaining_games * 3))

# Calculate and summarize final point probabilities
point_probs <- season_totals %>%
  mutate(total_points = round(total_points)) %>%  
  count(total_points) %>%
  mutate(prob = (n / n_sims) * 100) %>%
  arrange(total_points) %>%
  mutate(total_points = round(total_points))

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
Season_MC_Plot <- ggplot(point_probs, aes(x = total_points, y = prob)) +
  geom_bar(stat = "identity", fill = Color_Home, color = "black") +
  labs(title = "Liverpool Final Predicted Point Totals (10000 Sims)",
       subtitle = paste("After Match Day ", MatchDay),
       x = "Final Points",
       y = "Probability %",
       caption = my_socials) +
#  scale_x_continuous(limits = c((min(League_Points)), (max(point_probs$total_points))), 
#                     breaks = seq(0, (max(point_probs$total_points)), 1)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 5)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#Season_MC_Plot

```

# Pass Maps
```{r}
# data wrangling for pass connection tables

PassConnections <- plottingData 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "TeamName"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "x", new_names = "Endx", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "y", new_names = "Endy", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "second", new_names = "End_second", len = 1, up = FALSE)

# number of passes or carries between players
EPVEvents <- PassConnections %>%
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Attempted_Passes, Successful_Passes, UnSuccessful_Passes, BCs, Key_Passes, Prog_Passes, Attempted_Carries, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Final_Third_Carries,EPV, xT, x, y, Endx, Endy, PK_Box_Passes, Final_Third_Passes, Cross_Passes, Long_Passes, expandedMinute)


#EPV events prep for main tables
EPVPassEvents <- EPVEvents %>%
  filter(Attempted_Passes == 1) %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Successful Passes' = Successful_Passes, UnSuccessful_Passes, 'Long Passes' = Long_Passes, Crosses = Cross_Passes, 'PK Box Passes' = PK_Box_Passes, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, 'Final Third Passes' = Final_Third_Passes,  BCs, EPV, xT, 'Game Min' = expandedMinute)

EPVCarrieEvents <- EPVEvents %>%
    filter(Attempted_Carries == 1) %>%
    select(Passer_Team, Passer, Receiver, Receiver_Team, 'Successful Carries' = Successful_Carries, UnSuccessful_Carries, 'Prog Carries' = Prog_Carries, 'Final Third Carries' = Final_Third_Carries,  BCs, EPV, xT, 'Game Min' = expandedMinute)
  

# number of passes between players
PassConnections <- PassConnections %>%
  filter(Attempted_Passes == 1) %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue, x, y, Endx, Endy, PK_Box_Passes, Final_Third_Passes, Cross_Passes, Long_Passes, second, End_second, EventTime) %>%
  mutate(Pass_time = round(((End_second - second) + 60) %% 60, 2))

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Long_Passes = sum(Long_Passes), Final_Third_Passes = sum(Final_Third_Passes), PK_Box_Passes = sum(PK_Box_Passes), Crosses = sum(Cross_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), Pass_time = mean(EventTime)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100),
         EPV_P_Pass = (round(EPV / Successful_Passes, 3))) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 5) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Long_Passes = sum(Long_Passes), 'Final Third Passes' = sum(Final_Third_Passes), 'PK Box Passes' = sum(PK_Box_Passes), Crosses = sum(Crosses), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), EPV_P_Pass, Pass_time)

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Final Third Passes', 'PK Box Passes', Crosses,  'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV, 'EPV / Pass' = EPV_P_Pass, 'Pass Time' = Pass_time)

```
## Row {.flow}
### column {.tabset}
```{r}
#| title: 1st Half passnetwork


HomepassPlot1stWD <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 5)
HomepassPlot1stWD

#save Plot
ggsave(path = Vizlocation, "Home Passnetwork 1st  half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: 2nd Half passnetwork


HomepassPlot2ndWD <- plot_passnet_AI(data = plottingData,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 5)
HomepassPlot2ndWD

#save Plot
ggsave(path = Vizlocation, "Home Passnetwork 2nd  half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
``` {r}
#| title: Passnetwork first Goal 
#| label: Home passnetwork First Goal
HomepassPlot20m <- plot_passnet_AI(data = plottingData, 
                                        team_name = Match_Home, scale_stat = "EPV", 
                                        scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " Up to First Goal"),
                                        plot_start = 00, plot_finish = First_Goal, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 2)
HomepassPlot20m
```
### column {.tabset}
```{r}
#| title: 1st Half passnetwork


AwaypassPlot1stWD <- plot_passnet_AI(data = plottingData,  
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                   plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 5)
AwaypassPlot1stWD

#save Plot
ggsave(path = Vizlocation, "Away Passnetwork 1st  half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| title: 2nd Half passnetwork


AwaypassPlot2ndWD <- plot_passnet_AI(data = plottingData,  
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away, text_color = Color_Away_Text,  subtitle = paste0(Match_Fixture, " 2nd Half"),
                                   plot_start = 46, plot_finish = 100, pressmap = "Yes", logo = "", passes = 5)
AwaypassPlot2ndWD

#save Plot
ggsave(path = Vizlocation, "Away Passnetwork 2nd  half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
``` {r}
#| title: Passnetwork First Goal 
#| label: Away passnetwork first Goal

AwaypassPlot20m <- plot_passnet_AI(data = plottingData,  
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away, text_color = Color_Away_Text,  subtitle = paste0(Match_Fixture, " Up to First Goal"),
                                   plot_start = 00, plot_finish = First_Goal, pressmap = "Yes", logo = "", passes = 2)
AwaypassPlot20m
```

## Row {.flow}
### column {.tabset}
```{r}
#| title: Passnetwork to 1st Sub 
#| label: Home 1st subs passnetwork
HomepassPlot1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                   team_name = Match_Home, scale_stat = "EPV", 
                                   scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " to 1st Subs"),
                                   plot_start = 00, plot_finish = firstSubHome, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 5)
HomepassPlot1stsubsWD

#save Plot
ggsave(path = Vizlocation, "Home Passnetwork 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

``` {r}
#| title: Passnetwork Post 1st Sub 
#| label: Home post 1st subs passnetwork
HomepassPlotPost1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                        team_name = Match_Home, scale_stat = "EPV", 
                                        scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                        plot_start = firstSubHome, plot_finish = 100, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 5)
HomepassPlotPost1stsubsWD
```

### column {.tabset}
```{r}
#| title: Passnetwork to 1st Sub 
#| label: Away 1st subs passnetwork

AwaypassPlot1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " to 1st Subs"),
                                   plot_start = 00, plot_finish = firstSubAway, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 5)
AwaypassPlot1stsubsWD

#save Plot
ggsave(path = Vizlocation, "Away Passnetwork 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

``` {r}
#| title: Passnetwork post 1st Sub 
#| label: Away post 1st subs passnetwork
AwaypassPlotpost1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                        team_name = Match_Away, scale_stat = "EPV", 
                                        scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                        plot_start = firstSubAway, plot_finish = 100, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 5)
AwaypassPlotpost1stsubsWD
```
## Row {.flow}
### column {.tabset}
```{r home attack pass 1st}
#| title: Attacking Passnetwork 1st Half
#pass map EPV Home 1st half
HomepassPlot1stAtt <- plot_passnet_AI(data = plottingData, 
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pitch = "Half", pressmap = "Yes", passes = 5)
HomepassPlot1stAtt


```

```{r home attack pass 2nd}
#| title: Attacking Passnetwork 2nd Half

#pass map EPV Home 2nd half
HomepassPlot2ndAtt <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 46, plot_finish = 100, pitch = "Half", pressmap = "Yes", passes = 5)
HomepassPlot2ndAtt

```

```{r}
#| title: Attacking Passnetwork 1st Goal

#pass map EPV Home 2nd half
HomepassPlot20mA <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " up to First Goal"),
                                  plot_start = 00, plot_finish = First_Goal, pitch = "Half", pressmap = "Yes", passes = 2)
HomepassPlot20mA

```

### column {.tabset}
```{r away attack pass 1st}
#| title: Attacking Passnetwork 1st Half
#pass map EPV Away 1st half
AwaypassPlot1stAtt <- plot_passnet_AI(data = plottingData, 
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                     plot_start = 00, plot_finish = 44, pitch = "Half", pressmap = "Yes", passes = 5)
AwaypassPlot1stAtt

```

```{r away attack pass 2nd}
#| title: Attacking Passnetwork 2nd Half
#pass map EPV Away 2nd half
AwaypassPlot2ndAtt <- plot_passnet_AI(data = plottingData,
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                     plot_start = 46, plot_finish = 100, pitch = "Half", pressmap = "Yes", passes = 5)
AwaypassPlot2ndAtt

```
```{r}
#| title: Attacking Passnetwork 1st Goal
#pass map EPV Away 2nd half
AwaypassPlot2ndAtt20m <- plot_passnet_AI(data = plottingData,
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " up to First Goal"),
                                     plot_start = 20, plot_finish = First_Goal, pitch = "Half", pressmap = "Yes", passes = 2)
AwaypassPlot2ndAtt20m

```
## Row {.flow}
### column {.tabset}
```{r}
#| title: Attacking Passnetwork 1st Sub
#pass map EPV Home 1st sub
HomepassPlot1subAtt <- plot_passnet_AI(data = plottingData,  
                                    team_name = Match_Home, scale_stat = "EPV", 
                                    scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " up to 1st Sub"),
                                    plot_start = 00, plot_finish = firstSubHome, pitch = "Half", pressmap = "Yes", passes = 5)
HomepassPlot1subAtt

```

```{r}
#| title: Attacking Passnetwork Post 1st Sub
#pass map EPV Home 1st sub
HomepassPlot1subAttpost <- plot_passnet_AI(data = plottingData,  
                                    team_name = Match_Home, scale_stat = "EPV", 
                                    scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                    plot_start = firstSubHome, plot_finish = 100, pitch = "Half", pressmap = "Yes", passes = 5)
HomepassPlot1subAttpost

```
### column {.tabset}
```{r}
#| title: Attacking Passnetwork 1st Sub
#pass map EPV Away 1st Sub
AwaypassPlot1SubAtt <- plot_passnet_AI(data = plottingData,
                                      team_name = Match_Away, scale_stat = "EPV", 
                                      scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " up to 1st Sub"),
                                      plot_start = 00, plot_finish = firstSubAway, pitch = "Half", pressmap = "Yes", passes = 5)
AwaypassPlot1SubAtt

```

```{r}
#| title: Attacking Passnetwork Post 1st Sub
#pass map EPV Away 1st Sub
AwaypassPlot1SubAttpost <- plot_passnet_AI(data = plottingData,
                                      team_name = Match_Away, scale_stat = "EPV", 
                                      scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                      plot_start = firstSubAway, plot_finish = 100, pitch = "Half", pressmap = "Yes", passes = 5)
AwaypassPlot1SubAttpost

```

## Row {.flow}
### column {.tabset}
```{r}
#| title: Passnetwork - By Game Period
HomepassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                      team_name = Match_Home, scale_stat = "EPV", 
                                      scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                      plot_start = 00, plot_finish = 100, pitch = "", pressmap = "Yes", wrap = "Yes", Facet_by = "Game_Period", passes = 2)
HomepassPlotFTAttW
```
```{r}
#| title: Passnetwork - By Game Quarter
HomepassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                      team_name = Match_Home, scale_stat = "EPV", 
                                      scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                      plot_start = 00, plot_finish = 100, pitch = "", pressmap = "Yes", wrap = "Yes", Facet_by = "Game_Quarter", passes = 2)
HomepassPlotFTAttW
```

```{r}
#| title: Attacking Passnetwork - By Game Period
HomepassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                      team_name = Match_Home, scale_stat = "EPV", 
                                      scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                      plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes", Facet_by = "Game_Period", passes = 2)
HomepassPlotFTAttW
```
```{r}
#| title: Attacking Passnetwork - By Game Quarter
HomepassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                      team_name = Match_Home, scale_stat = "EPV", 
                                      scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                      plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes", Facet_by = "Game_Quarter", passes = 2)
HomepassPlotFTAttW
```

### column {.tabset}
```{r}
#| title: Passnetwork - By Game Period
AwaypassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                     plot_start = 00, plot_finish = 100, pitch = "", pressmap = "Yes", wrap = "Yes",  Facet_by = "Game_Period", passes = 2)
AwaypassPlotFTAttW
```
```{r}
#| title: Passnetwork - By Game Quarter
AwaypassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                     plot_start = 00, plot_finish = 100, pitch = "", pressmap = "Yes", wrap = "Yes",  Facet_by = "Game_Quarter", passes = 2)
AwaypassPlotFTAttW
```
```{r}
#| title: Attacking Passnetwork - By Game Period
AwaypassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                     plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes",  Facet_by = "Game_Period", passes = 2)
AwaypassPlotFTAttW
```
```{r}
#| title: Attacking Passnetwork - By Game Quarter
AwaypassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " By Time Period"),
                                     plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes",  Facet_by = "Game_Quarter", passes = 2)
AwaypassPlotFTAttW
```
## Row {.tabset}
```{r}
#| title: Pass Connections by Passer
#| label: Home pass connections tables
#| results: asis

PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
    fmt_number(
    columns = c(16),
    decimals = 2
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```
```{r}
#| title: Pass Connections by Receiver
#| label: Home pass connections tables Reciever
#| results: asis

PassConnectionTableHomeR <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Passer", groupname_col = "Receiver") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
    fmt_number(
    columns = c(16),
    decimals = 2
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHomeR
```

## Row {.tabset}
```{r}
#| title: Pass Connections by Passer
#| results: asis
#| label: away Pass connections table
PassConnectionTableAway <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Away,
         Passer_Team == Match_Away) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
    fmt_number(
    columns = c(16),
    decimals = 2
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16)))

PassConnectionTableAway
```

```{r}
#| title: Pass Connections by Receiver
#| results: asis
#| label: away Pass connections table Reciever
PassConnectionTableAwayr <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Away,
         Passer_Team == Match_Away) %>%
  gt(rowname_col = "Passer", groupname_col = "Receiver") %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
    fmt_number(
    columns = c(16),
    decimals = 2
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16)))

PassConnectionTableAwayr
```

## Row {.flow}
```{r}
#| label: home passing tree plot

PassConnectionTreeHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) 

group <- PassConnectionTreeHome$Passer
subgroup <- PassConnectionTreeHome$Receiver
value <- PassConnectionTreeHome$'Attempted Passes'

PassConnectionTreeHomePlot <- PassConnectionTreeHome %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, value, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 13,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_HomeC) + 
  labs(title = paste0(Match_Home, " Passing Connections (Min 5 passes)"), 
       subtitle = paste0(Match_Fixture, " Darker color = More Passes, \n Number & Name = Number Passes by Player, Large Name =  Reciever"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PassConnectionTreeHomePlot

```

``` {r}

#| label: away passing tree plot

PassConnectionTreeAway <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Away, 
         Passer_Team == Match_Away) 

group <- PassConnectionTreeAway$Passer
subgroup <- PassConnectionTreeAway$Receiver
value <- PassConnectionTreeAway$'Attempted Passes'

PassConnectionTreeAwayPlot <- PassConnectionTreeAway %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, value, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 13,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_AwayC) + 
  labs(title = paste0(Match_Away, " Passing Connections (Min 5 passes)"), 
       subtitle = paste0(Match_Fixture, " Darker color = More Passes,  \n Number & Name = Number Passes by Player, Large Name =  Reciever"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PassConnectionTreeAwayPlot

```


# Passing Analysis
## Row {.flow}
```{r home wave plot}
touchpass_bar_data <- plottingData 

touchpass_bar_data <- touchpass_bar_data %>%
      filter(!Own_Goals == 1 & TeamName == Match_Home) %>%
  filter(TeamName == Match_Home)


touchpass_bar_data <- touchpass_bar_data %>%
  group_by(expandedMinute, minute) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Successful_Passes = sum(Successful_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    Possession = mean(Home_Possession),
    TotalShots = sum(TotalShots),) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point = ifelse(str_detect(Goals, "1"), paste0(minute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Touches + 0.5), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point = as.numeric(Goal_point)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  mutate(Possession = round(Possession,2))

#canvas
touchpass_bar_plot <- touchpass_bar_data %>%
  ggplot(aes(x = expandedMinute, y = value)) +
  
#geometrics
  geom_bar(aes(x = expandedMinute, y = Touches, fill = Color_Home), stat = "identity", colour = "black", width = 1, position = position_nudge(x = 0.5)) +
  geom_bar(aes(x = expandedMinute, y = Attempted_Passes, fill = "ivory4"), stat = "identity",  colour = "black", width = 1, position = position_nudge(x = -0.5)) +
  geom_bar(aes(x = expandedMinute, y = TotalShots, fill = "green3"), stat = "identity", colour = "black", width = 1) +
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = -0.5, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.03) +    
  
  scale_fill_identity(name = "",
                       breaks = c(Color_Home,"ivory4", "green3"),
                       labels = c("Touches", "Passes", "Shots"),
                       guide = "legend") +
  
#formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
  labs(title = WavesTitle_text,
        caption = My_caption,
         subtitle = paste0(Match_Fixture),
         x = "Match Time (Mins)",
         y = "Metric Total") +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(face = "bold", size = 12),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none")

touchpass_bar_plot
```

```{r Away waves plot}
Awaytouchpass_bar_data <- plottingData 

Awaytouchpass_bar_data <- Awaytouchpass_bar_data %>%
  filter(!Own_Goals == 1 & TeamName == Match_Away) %>%
  filter(TeamName == Match_Away)

Awaytouchpass_bar_data <- Awaytouchpass_bar_data %>%
  group_by(expandedMinute, minute) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Successful_Passes = sum(Successful_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    AwayPossession = mean(Away_Possession),
    TotalShots = sum(TotalShots),) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Touches + 0.5), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  mutate(AwayPossession = round(AwayPossession,2))

#canvas
Awaytouchpass_bar_plot <- Awaytouchpass_bar_data %>%
  ggplot(aes(x = expandedMinute)) +
  

  #bars
  geom_bar(aes(x = expandedMinute, y = Touches, fill = Color_Away), stat = "identity", colour = "black", width = 1, position = position_nudge(x = 0.5)) +
  geom_bar(aes(x = expandedMinute, y = Attempted_Passes, fill = "ivory4"), stat = "identity",  colour = "black", width = 1, position = position_nudge(x = -0.5)) +
  geom_bar(aes(x = expandedMinute, y = TotalShots, fill = "green3"), stat = "identity", colour = "black", width = 1) +
  scale_fill_identity(name = "",
                      breaks = c(Color_Away,"ivory4", "green3"),
                      labels = c("Touches", "Passes", "Shots"),
                      guide = "legend") +
  
  # Other geoms and formatting for half time etc
  #geom_segment(aes(y = 0, yend = max(Touches), x = 45, xend = 45), linewidth = 0.8, colour = "black", linetype = "longdash") +
  #geom_text(aes(x = 45, y = max(Touches), label = "HT"), colour = "black", hjust = 1.5, vjust = 1, size = 4) +
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = -0.5, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.03) +

  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
  labs(title = AwayWavesTitle_text,
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match Time (Mins)",
         y = "Metric Total") +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(face = "bold", size = 12),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none")

Awaytouchpass_bar_plot
```

```{r}
#| output: false
# Step 1: Filter successful passes open play only
successful_passes <- plottingData 

# Step 2: Identify passing sequences with more than the defined level of pass

passing_sequencesHome <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, TeamName, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, period
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1) %>%
  mutate(Goal_point_X = ifelse(TeamName == Match_Home & (str_detect(type, "Goal")), paste0(x), NA)) %>%
  mutate(Goal_point_Y = ifelse(TeamName == Match_Home & (str_detect(type, "Goal")), paste0(y), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))


passing_sequencesAway <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, TeamName, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, period
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1) %>%
  mutate(Goal_point_X = ifelse(TeamName == Match_Away & (str_detect(type, "Goal")), paste0(x), NA)) %>%
  mutate(Goal_point_Y = ifelse(TeamName == Match_Away & (str_detect(type, "Goal")), paste0(y), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

#tabeldata
passing_sequencesHome_Table <- passing_sequencesHome %>%
  filter(TeamName == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesHome_1st_Table <- passing_sequencesHome %>%
  filter(TeamName == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1, 
    period == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesHome_2nd_Table <- passing_sequencesHome %>%
  filter(TeamName == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 2) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')


passing_sequencesAway_Table <- passing_sequencesAway %>%
  filter(TeamName == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesAway_1st_Table <- passing_sequencesAway %>%
  filter(TeamName == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesAway_2nd_Table <- passing_sequencesAway %>%
  filter(TeamName == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 2) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

# Define the desired order
desired_order <- c("VLow", "Low", "Medium", "High")

# Arrange passing_sequencesHome_Table
passing_sequencesHome_Table <- passing_sequencesHome_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_Table <- passing_sequencesAway_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesHome_1st_Table <- passing_sequencesHome_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_1st_Table <- passing_sequencesAway_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesHome_2nd_Table <- passing_sequencesHome_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_2nd_Table <- passing_sequencesAway_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))
```

## Row {.flow}
```{r}
#| label: passing chains all in

passing_sequencesHome_Plot <- passing_sequencesHome %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesHome$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.09, "cm")),
    lineend = "round",
    linewidth = 0.08,
    color = passing_sequencesHome$Pchain
  ) +
  # add goal
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.1) +

  #wrap it 
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  
  #format it
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesHome_Plot
```

```{r}
#| label: Away passing chains all in

passing_sequencesAway_Plot <- passing_sequencesAway %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesAway$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.09, "cm")),
    lineend = "round",
    linewidth = 0.08,
    color = passing_sequencesAway$Pchain
  ) +  
# add goal
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.1) +

  #wrap it 
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  
  #format it
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesAway_Plot

```

## Row {.flow}
### column {.tabset}
``` {r}
#| title: Full time
#| label: home passing chains tables FT
#| results: asis

Home_Passing_Chains_Table <- passing_sequencesHome_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " FT Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_Table
```

``` {r}
#| title: 1st Half
#| label: home passing chaing tables 1st
#| results: asis

Home_Passing_Chains_1st_Table <- passing_sequencesHome_1st_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " 1st Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_1st_Table
```

``` {r}
#| title: 2nd Half
#| label: home passing chaing tables 2nd
#| results: asis

Home_Passing_Chains_2nd_Table <- passing_sequencesHome_2nd_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " 2nd Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_2nd_Table

```
### column {.tabset}
``` {r}
#| title: Full time
#| label: away passing chaing tables FT
#| results: asis
Away_Passing_Chains_Table <- passing_sequencesAway_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " FT Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Away_Passing_Chains_Table
```

``` {r}
#| title: 1st Half
#| label: away passing chaing tables 1st
#| results: asis

Away_Passing_Chains_1st_Table <- passing_sequencesAway_1st_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " 1st Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Away_Passing_Chains_1st_Table
```

``` {r}
#| title: 2nd Half
#| label: away passing chaing tables 2nd
#| results: asis

Away_Passing_Chains_2nd_Table <- passing_sequencesAway_2nd_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " 2nd Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Away_Passing_Chains_2nd_Table
```

```{r}
#| output: false
Zone14_Passes_Home_Data <- plottingData %>%
  filter(TeamName == Match_Home,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start)  %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

Zone14_Passes_Home_Data <- Zone14_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_Home_Data <- plottingData %>%
  filter(TeamName == Match_Home,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start)  %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

LHS_Passes_Home_Data <- LHS_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_Home_Data <- plottingData %>%
  filter(TeamName == Match_Home,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start)  %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

RHS_Passes_Home_Data <- RHS_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

Zone14_Passes_Away_Data <- plottingData %>%
  filter(TeamName == Match_Away,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start)  %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

Zone14_Passes_Away_Data <- Zone14_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_Away_Data <- plottingData %>%
  filter(TeamName == Match_Away,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start) %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

LHS_Passes_Away_Data <- LHS_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_Away_Data <- plottingData %>%
  filter(TeamName == Match_Away,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, period, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start) %>%
      mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

RHS_Passes_Away_Data <- RHS_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

#combine data frames
Z14_HS_Passes_Home_Data <- bind_rows(Zone14_Passes_Home_Data, LHS_Passes_Home_Data, RHS_Passes_Home_Data)

Z14_HS_Passes_Away_Data <- bind_rows(Zone14_Passes_Away_Data, LHS_Passes_Away_Data, RHS_Passes_Away_Data)

Z14_HS_Passes_Home_Data <- Z14_HS_Passes_Home_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_Away_Data <- Z14_HS_Passes_Away_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_Home_Data <- Z14_HS_Passes_Home_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))

Z14_HS_Passes_Away_Data <- Z14_HS_Passes_Away_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))
```

## Row {.flow}
### column {.tabset}
```{r}
#| title: By half
Zone14_HS_Passes_Home_Plot <- Z14_HS_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Half) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = PPsTitle_textHalf, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Z14 and HS plot by half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| title: By Game Period
Zone14_HS_Passes_Home_Plot <- Z14_HS_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = PPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Z14 and HS plot by period.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


### column {.tabset}
```{r}
#| title: By Half
Zone14_HS_Passes_Away_Plot <- Z14_HS_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Half) +
  labs(title = AwayPPsTitle_textHalf, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Away_Plot

#save Plot
ggsave(path = Vizlocation, "Away Z14 and HS plot by Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| title: By Game Period
Zone14_HS_Passes_Away_Plot <- Z14_HS_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = AwayPPsTitle_text,
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Away_Plot

#save Plot
ggsave(path = Vizlocation, "Away Z14 and HS plot by period.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

## Row {.flow}
```{r}
#| echo: false
#| output: false
#| 
Long_Passes_Data <- plottingData %>%
  filter(Long_Passes == 1 | Cross_Passes == 1) %>%
  select(TeamName, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Cross_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName, Corners, Short_Corners) %>%
  mutate(Pass_Type = ifelse(Cross_Passes == 1, "Cross",
                            ifelse(Long_Passes == 1, "Long Pass","Successful"))) %>%
    mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

LPsTitle_textGP <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

AwayLPsTitle_textGP <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))
```

### column {.tabset}
```{r}
#| out-height: 100%
#| out-width: 100%
#| title: By half
Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(TeamName == Match_Home ,
           Corners == 0,
           Short_Corners == 0) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Crosses and Long pass plot by half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: By Game Period
Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(TeamName == Match_Home,
           Short_Corners == 0,
           Corners == 0) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Game_Period) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_textGP, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Crosses and Long pass plot by game period.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
### column {.tabset}
``` {r}
#| out-height: 100%
#| out-width: 100%
#| title: By Half
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(TeamName == Match_Away,
           Corners == 0,
           Short_Corners == 0) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot by half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

``` {r}
#| out-height: 100%
#| out-width: 100%
#| title: By Game period
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(TeamName == Match_Away, 
           Short_Corners == 0,
           Corners == 0) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Game_Period) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_textGP, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot by period.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
## Row
### column {.tabset}
```{r}
#| title: 1st Half Pass Recieving Areas

HomePRecievedHeatMapplot1Half <- plottingData %>%
  filter(Successful_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Home, 
         period == 1) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Recieving Pass Heat Map \nUp 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePRecievedHeatMapplot1Half

```
```{r}
#| title: 2nd Half Pass Recieving Areas
HomePRecievedHeatMapplot2Half <- plottingData %>%
  filter(Successful_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Home, 
         period == 2) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics

  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Recieving Pass Heat Map \nUp 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePRecievedHeatMapplot2Half


```
```{r}
#| title: Up to 1st Sub Pass Recieving Areas

HomePRecievedHeatMapplot1Sub <- plottingData %>%
  filter(Successful_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Home, 
         between(minute, 00, firstSubHome)) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +

  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Recieving Pass Heat Map \nUp 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePRecievedHeatMapplot1Sub
```
### column {.tabset}
```{r}
#| title: 1st Half Pass Recieving Areas
AwayPRecievedHeatMapplot1Half <- plottingData %>%
  filter(Successful_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Away, 
         period == 1) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste0(Match_Away," Open Play Recieving Pass Heat Map \nUp 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPRecievedHeatMapplot1Half
```
```{r}
#| title: 2nd Half Pass Recieving Areas

AwayPRecievedHeatMapplot2Half <- plottingData %>%
  filter(Successful_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Away, 
         period == 2) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics

  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste0(Match_Away," Open Play Recieving Pass Heat Map \nUp 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPRecievedHeatMapplot2Half

```
```{r}
#| title: Up to 1st Sub Pass Recieving Areas

AwayPRecievedHeatMapplot1Sub <- plottingData %>%
  filter(Attempted_Passes == 1,
         Short_Corners == 0,
         Corners == 0,
         TeamName == Match_Away, 
         between(minute, 00, firstSubAway)) %>%
  ggplot(aes(x = finalX, y = finalY)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  #geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +

  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste0(Match_Away," Open Play Recieving Pass Heat Map \nUp 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Receieved Passes, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPRecievedHeatMapplot1Sub

```



# Player Analysis
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: player stats tables setup

MatchSummaryPLayerData <- plottingData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = as.numeric(ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0))) %>%
  group_by(TeamName, playerId, role, player_shirt) %>%
    summarise(
    across(
      c(Goals, 
        TotalShots, 
        OFShots, 
        SoT = OTShots, 
        Out_Box_Shots, 
        Touches, 
        Defensive_Third_Touches, 
        Middle_Third_Touches, 
        Final_Third_Touches, 
        PK_Box_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries, 
        Attempted_Passes, 
        Successful_Passes, 
        Long_Passes, 
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        BCs,
        TeamEPV,   
        xG, 
        xGOT, 
        MyxA,
        TeamxT,
        Aerial_total, 
        Aerial_Won, 
        Aerial_Lost, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
        UnSuccessful_Touches,
        Attacking_Half_Touches, 
        Defensive_Half_Touches, 
        Mis_Control, 
        Dispossessed_Total, 
        Dribbles_Total, 
        Dribbles_Won, 
        Dribbles_Lost,
        Blocked_Shot,
        SixYard_Box_Shots, 
        PK_Box_Shots, 
        NPxG,
        UnSuccessful_Passes,
        Successful_Long_Passes, 
        Corners, 
        Short_Corners, 
        Cross_Passes, 
        Successful_Cross, 
        UnSuccessful_Cross, 
        Tackles_Total, 
        Tackles_Won, 
        Tackles_Lost, 
        Fouls_Total, 
        Fouls_Conceeded, 
        Fouls_Received,
        Interceptions_Total, 
        Recoverys_Total,
        Clearances_Total,
        Offside_Won, 
        Offside_Lost
        ), 
      \(x) sum(x, na.rm = TRUE)
    ),
    minutes_played = min(minutes_played, na.rm = TRUE),
    Carries_distance = sum(Carries_distance, na.rm = TRUE),
    Successful_Carries_Distance = sum(Successful_Carries_Distance, na.rm = TRUE),
    Prog_Carries_Distance = sum(Prog_Carries_Distance, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  group_by(TeamName) %>%
  mutate(
    Team_TotalTouches = sum(Touches),
    Team_TotalEPV = sum(TeamEPV),
    Team_TotalxG = sum(xG),
    Team_TotalPasses = sum(Attempted_Passes),
    Team_TotalDuels = sum(Ground_Duels_Total),
    Team_TotalAerials = sum(Aerial_total),
    Team_TotalShots = sum(TotalShots),
    Possession = round((Touches / Team_TotalTouches), 2),
    Pass_Success = round((Successful_Passes / Attempted_Passes), 2),
    Aerial_Success = (Aerial_Won / Aerial_total),
    Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
    On_Ball_Time = round(InPlayTime * Possession,2),
    Team_EPV_P = round((TeamEPV / Team_TotalEPV), 2),
    Team_xG_P = round((xG / Team_TotalxG), 2),
    Team_Duels_P = round((Ground_Duels_Total / Team_TotalDuels), 2),
    Team_Aerial_P = round((Aerial_total / Team_TotalAerials), 2),
    Team_Passes_P = round((Attempted_Passes / Team_TotalPasses), 2),
    Team_Shots_P = round((TotalShots / Team_TotalShots), 2)
  ) %>%
  replace_na(list( Aerial_Success = 0)) %>%
  replace_na(list( Duel_Success = 0)) %>%
  ungroup()

MD_adv_passing <- plottingData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "TeamName", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = TeamName, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(Recieving_Suc = (Successful_Recieved / Passes_Recieved)) %>%
  replace_na(list(Recieving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, Recieving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

# add all data together
MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  left_join(MatchdayTableAdvPass, by = c("TeamName" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#work out detailed passing, and touches variables
MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  mutate('xG/Shot' =  xG/TotalShots,
  'Shot Accuracy' = SoT/TotalShots,
  'Shot Quality' = (xGOT - xG)/xG) %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate(Failed_Pass = round(Attempted_Passes - Successful_Passes, 2),
         Failed_Cross = round(Cross_Passes - Successful_Cross, 2),
         Failed_Dribble = round(Dribbles_Total - Dribbles_Won, 2),
         Poss_Gained = round(Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost), 2),
         Poss_Lost = (Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost),
         Posession_Control = (Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost) - (Mis_Control + Dispossessed_Total + UnSuccessful_Passes + UnSuccessful_Cross + Dribbles_Lost  + OFShots + Blocked_Shot + Offside_Lost)),) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))

DefEPVData <- plottingData %>%
  filter(Corners == 0,
         Short_Corners == 0,
         FreeKicks == 0,
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 107,
           `type/value` == 1 |
           `type/value` == 2 | 
           `type/value` == 3 |
           `type/value` == 4 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "EPV_Def", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(TeamName, playerId, EPVvalue, Defensive_Action, `outcomeType/value`, EPV_Def, role) %>%
  mutate(EPV_Faced = (EPVvalue + EPV_Def),
    Successful_Def_EPV = ifelse(`outcomeType/value` == 1, paste0(EPV_Faced), 0),
         Unsuccessful_Def_EPV = ifelse(`outcomeType/value` == 0, paste0(EPV_Faced), 0), 
         Successful_Def_EPV = as.numeric(Successful_Def_EPV),
         Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

DefEPVData <- DefEPVData %>%
    group_by(playerId, role, TeamName) %>% 
  summarise(EPV_Faced = sum(EPV_Faced),
            EPV_Won = sum(Successful_Def_EPV/EPV_Faced), 
            EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .)) 

MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  left_join(DefEPVData, by = c('playerId' = 'playerId', 'TeamName' = 'TeamName', 'role' = 'role'), copy = TRUE)


MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
    replace_na(list( EPV_Faced = 0, EPV_Won = 0, EPV_Lost = 0)) 


#subset for standard player stats data table 1
MatchSummaryPLayerPassingData <- MatchSummaryPLayerData

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesData <- MatchSummaryPLayerData

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingData <- MatchSummaryPLayerData

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveData <- MatchSummaryPLayerData

#sub set for player profile plots
MatchSummaryPLayerProfileData <- MatchSummaryPLayerData

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingData <- MatchSummaryPLayerPassingData %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = Recieving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesData <- MatchSummaryPLayerTouchesData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingData <- MatchSummaryPLayerShootingData %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveData <- MatchSummaryPLayerDefensiveData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)

#data wrangling for player profile plots
Player_Summary_plot_data <- MatchSummaryPLayerProfileData %>%
  select(Team = TeamName, Name = playerId, role, '% Possession' = Possession, `% On Ball Time` = On_Ball_Time, Touches = Touches, 'Total Shots' = TotalShots, OFShots, SoT, 'Out Box Shots' = Out_Box_Shots, BCs, Goals, xG, xGOT, '% xG' = Team_xG_P, Touches, PK_Box_Touches, 
         'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, 'Key Passes' = Key_Passes, EPV = TeamEPV, '% EPV' = Team_EPV_P, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success %' = Duel_Success, '% Duels' = Team_Duels_P, '% Passes' = Team_Passes_P, '% Shots' = Team_Shots_P, '% Aerials' = Team_Aerial_P)


Player_Summary_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, '% Possession', '% xG', '% EPV', '% Passes', '% Shots', '% Duels', '% Aerials') %>%
  pivot_longer(cols = c('% Possession', '% xG', '% EPV','% Passes', '% Shots', '% Duels', '% Aerials'), names_to = "Metric", values_to = "Value")

#player profile plot data
Player_Goal_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, OFShots, SoT, 'Out Box Shots', BCs, Goals, Assists, 'Key Passes') %>%
  pivot_longer(cols = c(OFShots, SoT, `Out Box Shots`, BCs, Goals, Assists, `Key Passes`), names_to = "Metric", values_to = "Value") 

#filter data by team
Player_Summary_plot_data_Home <- Player_Summary_data %>%
  filter(Team == Match_Home)

Player_Summary_plot_data_Away <- Player_Summary_data %>%
  filter(Team == Match_Away) 

Player_Goal_plot_data_Home <- Player_Goal_data %>%
  filter(Team == Match_Home)

Player_Goal_plot_data_Away <- Player_Goal_data %>%
  filter(Team == Match_Away) 


#work out team and unit averages
#general metrics
Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

#goal metrics
Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()


#wrap the tiles for the general plot
Player_Summary_data_Home$Metric  <- str_wrap(Player_Summary_data_Home$Metric, width = 5)  

Player_Summary_data_Away$Metric  <- str_wrap(Player_Summary_data_Away$Metric, width = 5)  


#wrap the tiles for the goal plot
Player_Goal_data_Home$Metric  <- str_wrap(Player_Goal_data_Home$Metric, width = 5)  

Player_Goal_data_Away$Metric  <- str_wrap(Player_Goal_data_Away$Metric, width = 5)  


#reorder data
facet_order <- c("Keeper", "Defender", "Midfielder", "Forward")

#general plot
Player_Summary_data_Home  <- Player_Summary_data_Home  %>%
arrange(factor(role, levels = facet_order))

Player_Summary_data_Away  <- Player_Summary_data_Away  %>%
  arrange(factor(role, levels = facet_order))

#goal plot
Player_Goal_data_Home <- Player_Goal_data_Home %>%
  arrange(factor(role, levels = facet_order))

Player_Goal_data_Away <- Player_Goal_data_Away %>%
  arrange(factor(role, levels = facet_order))

```
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: player Season stats tables setup

MatchSummaryPLayerSeasonData <- SeasonData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = as.numeric(ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0))) %>%
  group_by(TeamName, playerId, role, player_shirt) %>%
    summarise(
    across(
      c(Goals, 
        TotalShots, 
        OFShots, 
        SoT = OTShots, 
        Out_Box_Shots, 
        Touches, 
        Defensive_Third_Touches, 
        Middle_Third_Touches, 
        Final_Third_Touches, 
        PK_Box_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries, 
        Attempted_Passes, 
        Successful_Passes, 
        Long_Passes, 
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        BCs,
        TeamEPV,   
        xG, 
        xGOT, 
        MyxA,
        TeamxT,
        Aerial_total, 
        Aerial_Won, 
        Aerial_Lost, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
        UnSuccessful_Touches,
        Attacking_Half_Touches, 
        Defensive_Half_Touches, 
        Mis_Control, 
        Dispossessed_Total, 
        Dribbles_Total, 
        Dribbles_Won, 
        Dribbles_Lost,
        Blocked_Shot,
        SixYard_Box_Shots, 
        PK_Box_Shots, 
        NPxG,
        UnSuccessful_Passes,
        Successful_Long_Passes, 
        Corners, 
        Short_Corners, 
        Cross_Passes, 
        Successful_Cross, 
        UnSuccessful_Cross, 
        Tackles_Total, 
        Tackles_Won, 
        Tackles_Lost, 
        Fouls_Total, 
        Fouls_Conceeded, 
        Fouls_Received,
        Interceptions_Total, 
        Recoverys_Total,
        Clearances_Total,
        Offside_Won, 
        Offside_Lost
        ), 
      \(x) sum(x, na.rm = TRUE)
    ),
    minutes_played = min(minutes_played, na.rm = TRUE),
    Carries_distance = sum(Carries_distance, na.rm = TRUE),
    Successful_Carries_Distance = sum(Successful_Carries_Distance, na.rm = TRUE),
    Prog_Carries_Distance = sum(Prog_Carries_Distance, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  group_by(TeamName) %>%
  mutate(
    Team_TotalTouches = sum(Touches),
    Team_TotalEPV = sum(TeamEPV),
    Team_TotalxG = sum(xG),
    Team_TotalPasses = sum(Attempted_Passes),
    Team_TotalDuels = sum(Ground_Duels_Total),
    Team_TotalAerials = sum(Aerial_total),
    Team_TotalShots = sum(TotalShots),
    Possession = round((Touches / Team_TotalTouches), 2),
    Pass_Success = round((Successful_Passes / Attempted_Passes), 2),
    Aerial_Success = (Aerial_Won / Aerial_total),
    Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
    On_Ball_Time = round(InPlayTime * Possession,2),
    Team_EPV_P = round((TeamEPV / Team_TotalEPV), 2),
    Team_xG_P = round((xG / Team_TotalxG), 2),
    Team_Duels_P = round((Ground_Duels_Total / Team_TotalDuels), 2),
    Team_Aerial_P = round((Aerial_total / Team_TotalAerials), 2),
    Team_Passes_P = round((Attempted_Passes / Team_TotalPasses), 2),
    Team_Shots_P = round((TotalShots / Team_TotalShots), 2)
  ) %>%
  replace_na(list( Aerial_Success = 0)) %>%
  replace_na(list( Duel_Success = 0)) %>%
  ungroup()

MD_adv_passing <- SeasonData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "TeamName", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = TeamName, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(Recieving_Suc = (Successful_Recieved / Passes_Recieved)) %>%
  replace_na(list(Recieving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, Recieving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

# add all data together
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(MatchdayTableAdvPass, by = c("TeamName" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#work out detailed passing, and touches variables
MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  mutate('xG/Shot' =  xG/TotalShots,
  'Shot Accuracy' = SoT/TotalShots,
  'Shot Quality' = (xGOT - xG)/xG) %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate(Failed_Pass = round(Attempted_Passes - Successful_Passes, 2),
         Failed_Cross = round(Cross_Passes - Successful_Cross, 2),
         Failed_Dribble = round(Dribbles_Total - Dribbles_Won, 2),
         Poss_Gained = round(Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost), 2),
         Poss_Lost = (Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost),
         Posession_Control = (Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost) - (Mis_Control + Dispossessed_Total + UnSuccessful_Passes + UnSuccessful_Cross + Dribbles_Lost  + OFShots + Blocked_Shot + Offside_Lost)),) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))

DefEPVData <- SeasonData %>%
  filter(Corners == 0,
         Short_Corners == 0,
         FreeKicks == 0,
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 107,
           `type/value` == 1 |
           `type/value` == 2 | 
           `type/value` == 3 |
           `type/value` == 4 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "EPV_Def", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(TeamName, playerId, EPVvalue, Defensive_Action, `outcomeType/value`, EPV_Def, role) %>%
  mutate(EPV_Faced = (EPVvalue + EPV_Def),
    Successful_Def_EPV = ifelse(`outcomeType/value` == 1, paste0(EPV_Faced), 0),
         Unsuccessful_Def_EPV = ifelse(`outcomeType/value` == 0, paste0(EPV_Faced), 0), 
         Successful_Def_EPV = as.numeric(Successful_Def_EPV),
         Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

DefEPVData <- DefEPVData %>%
    group_by(playerId, role, TeamName) %>% 
  summarise(EPV_Faced = sum(EPV_Faced),
            EPV_Won = sum(Successful_Def_EPV/EPV_Faced), 
            EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .)) 

MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
  left_join(DefEPVData, by = c('playerId' = 'playerId', 'TeamName' = 'TeamName', 'role' = 'role'), copy = TRUE)


MatchSummaryPLayerSeasonData <- MatchSummaryPLayerSeasonData %>%
    replace_na(list( EPV_Faced = 0, EPV_Won = 0, EPV_Lost = 0)) 


#subset for standard player stats data table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerSeasonData

#subset for detailed player stats data table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerSeasonData

#sub set for player profile plots
MatchSummaryPLayerProfileSeasonData <- MatchSummaryPLayerSeasonData

#data wrangling for general player stat table 1
MatchSummaryPLayerPassingSeasonData <- MatchSummaryPLayerPassingSeasonData %>%
  select(Team = TeamName, 
         Position = role, 
         Name = playerId, 
         Mins = minutes_played, 
         '% of Team Possession' = Possession, 
         xA = MyxA, 
         xT = TeamxT,  
         'Attempted Passes' = Attempted_Passes, 
         'Successful Passes' = Successful_Passes, 
         'Pass Success %' = Pass_Success, Assists, 
         BCs, 
         'Key Passes' = Key_Passes, 
         `Long Ps`  = Long_Passes, 
         `Final 3rd P` = Final_Third_Passes, 
         `Prog Ps` = Prog_Passes, 
         'PK Box P' = PK_Box_Passes, 
         `Pass Received` = Passes_Recieved, 
         `PPs Received` = Prog_Passes_Recieved, 
         `KPs Recieved` = Key_Passes_Recieved, 
         `Recieveing Suc` = Recieving_Suc, 
         `EPV Recieved` = EPV_Recieved, 
         'EPV Created' = TeamEPV, 
         '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerTouchesSeasonData <- MatchSummaryPLayerTouchesSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         Touches, 
         `Def 3rd` = Defensive_Third_Touches, 
         `Mid 3rd` = Middle_Third_Touches, 
         `Final 3rd` = Final_Third_Touches, 
         `PK Box` = PK_Box_Touches, 
         `Total / Min` = `T / Min`, 
         `Def 3rd % TT` = `% T D Third`, 
         `Mid Third % TT` = `% T M Third`, 
         `Final 3rd % TT` = `% T F 3rd`, 
         `PK Box % TT` = `% T PK Box`, 
         `Carries` = Successful_Carries, 
         `% Carries Prog` = `% P Carries`, 
         `% Carries F 3rd` = `% F 3rd Carries`, 
         `% Carries D Prog`)

#data wrangling for detailed player stats table 3
MatchSummaryPLayerShootingSeasonData <- MatchSummaryPLayerShootingSeasonData %>%
    select(Team = TeamName, 
           Position = role, 
           Name = playerId, 
           Mins = minutes_played, 
           'Total Shots' = TotalShots, 
           SoT, 
           '6 yard box' = SixYard_Box_Shots,     
           'PK Box Shot' = PK_Box_Shots, 
           'Out Box Shots' = Out_Box_Shots, 
           'Blocked Shot' = Blocked_Shot,
           Goals, 
           xG, 
           xGOT,
           'xG/Shot',
           'Shot Accuracy',
           'Shot Quality')

#data wrangling for detailed player stats table 4
MatchSummaryPLayerDefensiveSeasonData <- MatchSummaryPLayerDefensiveSeasonData %>%
  select(Team = TeamName, 
         Name = playerId, 
         Position = role, 
         Mins = minutes_played, 
         'Aerials Total' = Aerial_total, 
         'Aerials Won' = Aerial_Won, 
         'Aerial Success %' = Aerial_Success, 
         'Duels Total' = Ground_Duels_Total, 
         'Duels Won' = Ground_Duels_Won, 
         'Duel Success' = Duel_Success,         
         'Tackles Total' = Tackles_Total, 
         'Tackles Won' = Tackles_Won, 
         'Tackles Lost' = Tackles_Lost, 
         'Interceptions Total' = Interceptions_Total, 
         'Recoverys Total' = Recoverys_Total,
         'Clearances Total' = Clearances_Total, #c16
         'Fouls Total' = Fouls_Total, 
         'Fouls Conceeded' = Fouls_Conceeded, 
         'Fouls Received' = Fouls_Received,
         'Offside Won' = Offside_Won, 
         'Offside Lost' = Offside_Lost,
         'EPV Faced' =  EPV_Faced, 
         'EPV Won'  = EPV_Won, 
         'EPV Lost' = EPV_Lost,
         'Possession Control' = Posession_Control)
```


## Row {.tabset}
### Matchstats {.tabset}

```{r}
#| title: Passing stats
#| results: asis
#| label: Home player Passing table

MatchSummaryPLayerPassingTableHome <- MatchSummaryPLayerPassingData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Possession Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "Recieving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

MatchSummaryPLayerPassingTableHome

```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: home player Touches table

MatchSummaryPLayerTouchesTableHome <- 
  MatchSummaryPLayerTouchesData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Touches Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
MatchSummaryPLayerTouchesTableHome

```
```{r}
#| title: Shooting stats
#| results: asis


MatchSummaryPLayerShootingTableHome <- MatchSummaryPLayerShootingData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Shooting Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

MatchSummaryPLayerShootingTableHome
```

```{r}
#| title: Defensive stats
#| results: asis

MatchSummaryPLayerDefensiveTableHome <- MatchSummaryPLayerDefensiveData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Defensive Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

MatchSummaryPLayerDefensiveTableHome
```

### Seasonstats {.tabset}
```{r}
#| title: Passing stats
#| results: asis
#| label: Home player Passing table Season

SeasonSummaryPLayerPassingTableHome <- MatchSummaryPLayerPassingSeasonData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Possession Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "Recieving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Home,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Home, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Home, domain = c(0,20))

SeasonSummaryPLayerPassingTableHome

```
```{r}
#| title: Touches and Carries
#| results: asis
#| label: home player Touches table Season

SeasonSummaryPLayerTouchesTableHome <- 
  MatchSummaryPLayerTouchesSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Touches Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Home, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableHome

```
```{r}
#| title: Shooting stats
#| results: asis


SeasonSummaryPLayerShootingTableHome <- MatchSummaryPLayerShootingSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Shooting Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Home, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Home, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableHome
```

```{r}
#| title: Defensive stats
#| results: asis

SeasonSummaryPLayerDefensiveTableHome <- MatchSummaryPLayerDefensiveSeasonData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Defensive Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Home, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Home, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableHome
```
## Row {.tabset}
### MatchStats {.tabset}
```{r}
#| title: Passing stats
#| results: asis
#| label: Away player Passing tables

MatchSummaryPLayerPassingTableAway <- MatchSummaryPLayerPassingData %>%
  filter(Team == Match_Away) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Possession Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "Recieving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Away, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Away, domain = c(0,20))

MatchSummaryPLayerPassingTableAway
```

```{r}
#| title: Touches and Carries
#| results: asis
#| label: away playertouches table

MatchSummaryPLayerTouchesTableAway <- MatchSummaryPLayerTouchesData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Touches Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Away, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Away, domain = c(0,1)) # % scales
MatchSummaryPLayerTouchesTableAway
```
```{r}
#| title: Shooting stats
#| results: asis

MatchSummaryPLayerShootingTableAway <- MatchSummaryPLayerShootingData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Shooting Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Away, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Away, domain = c(-5,5))# % scales

MatchSummaryPLayerShootingTableAway

```

```{r}
#| title: Defensive stats
#| results: asis

MatchSummaryPLayerDefensiveTableAway <- MatchSummaryPLayerDefensiveData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Defensive Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(21), palette = ColorScale_Away, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Away, domain = c(0,1)) # % scales

MatchSummaryPLayerDefensiveTableAway

```
### Seasonstats {.tabset}
```{r}
#| title: Passing stats
#| results: asis
#| label: Away player Passing table Season

SeasonSummaryPLayerPassingTableAway <- MatchSummaryPLayerPassingSeasonData %>%
  filter(Team == Match_Away) %>%
  gt(groupname_col = "Position", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Possession Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:24), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5, 10, 21, 24),
    decimals = 0
  ) %>%
  fmt_number(
    columns = c(6,7,22,23),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Expected Metrics", columns = c(6:7)) %>%
  tab_spanner(label = "Passes", columns = c(8:17)) %>%
  tab_spanner(label = "Recieving", columns = c(18:24)) %>%
 tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #gt_plt_bar(
  #  'Long Ps',
    #keep_column = TRUE,
  #  labels = TRUE,
  #  color = Color_Away,
  #  scaled = FALSE,
  #) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  #gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Away, domain = c(0,100)) %>%
  gt_color_rows(columns = c(12:13, 16:17), palette = ColorScale_Away, domain = c(0,10)) %>%
  #gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Away, domain = c(0,5)) %>%
  #gt_color_rows(columns = c(5, 21, 22, 23, 24, 26), palette = ColorScale_Away, domain = c(0,20)) %>%
  gt_color_rows(columns = c(5, 10, 21, 24), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(14:15), palette = ColorScale_Away, domain = c(0,20))

SeasonSummaryPLayerPassingTableAway

```
```{r}
#| title: Touches and Carries
#| results: asis
#| label: Away player Touches table Season

SeasonSummaryPLayerTouchesTableAway <- 
  MatchSummaryPLayerTouchesSeasonData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Touches Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:18), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:18), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Away, domain = c(0,3)) %>% # touch/per min
  gt_color_rows(columns = c(12:14, 16:18), palette = ColorScale_Away, domain = c(0,1)) # % scales
SeasonSummaryPLayerTouchesTableAway

```
```{r}
#| title: Shooting stats
#| results: asis


SeasonSummaryPLayerShootingTableAway <- MatchSummaryPLayerShootingSeasonData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(15:16), decimals = 0) %>%
  fmt_number(columns = c(12:14), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Shooting Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:16), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:16), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(5:11), palette = ColorScale_Away, domain = c(0,5)) %>% # shots
  gt_color_rows(columns = c(15), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(16), palette = ColorScale_Away, domain = c(-5, 5)) # % scales# % scales

SeasonSummaryPLayerShootingTableAway
```

```{r}
#| title: Defensive stats
#| results: asis

SeasonSummaryPLayerDefensiveTableAway <- MatchSummaryPLayerDefensiveSeasonData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "Name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  fmt_percent(columns = c(7, 10, 23:24), decimals = 0) %>%
  fmt_number(columns = c(22), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Defensive Summary"),
    subtitle = paste0("Up to - ", Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:25), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "Defensive Threat", columns = c(22:24)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Defensive Threat'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(22), palette = ColorScale_Away, domain = c(0,2)) %>% # epv faced
  gt_color_rows(columns = c(7, 10, 23, 24), palette = ColorScale_Away, domain = c(0,1)) # % scales

SeasonSummaryPLayerDefensiveTableAway
```

## Row
```{r}
#| output: false
#| label: dribbles and duels data setup

heatmapdata <- plottingData 

Dribblesmapdata <- heatmapdata %>%
  filter(Dribbles_Total == 1) %>%
  mutate(DribblesFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DribblesFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(TeamName, teamId, playerId, player_shirt, playerNumber, role,  x, y, DribblesFinalX, DribblesFinalY, outcome, Game_Period )


#duels aerial and ground data
Duelsmapdata <- heatmapdata
  
Duelsmapdata <- heatmapdata %>%
  filter(Ground_Duels_Total == 1 |
           Aerial_total == 1) %>%
  mutate(DuelsFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DuelsFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(TeamName, teamId, playerId, player_shirt, playerNumber, role, x, y, DuelsFinalX, DuelsFinalY, outcome, Game_Period )


#Liverpool duels data
HomeDuelsmapdata <- Duelsmapdata %>%
  filter(TeamName == Match_Home)

#Away duels data
AwayDuelsmapdata <- Duelsmapdata %>%
  filter(TeamName == Match_Away)

#Home Dribbles Data
HomeDribblesmapdata <- Dribblesmapdata %>%
  filter(TeamName == Match_Home)

#Away Dribbles Data
AwayDribblesmapdata <- Dribblesmapdata %>%
  filter(TeamName == Match_Away)

#PLayer touch data 
TouchDataHome <- plottingData %>%
  filter(TeamName == Match_Home)

TouchDataAway <- plottingData %>%
  filter(TeamName == Match_Away)

#Home TEAM Touch zones
TouchData <- plottingData %>%
  filter(
    Corners == 0,
    Short_Corners == 0,
    Attempted_Passes == 1,
    FreeKicks == 0,
    `type/value` %in% c(1, 2, 3, 13, 14, 15, 16, 42, 50, 61))

HomeTeamTouchData <- TouchData %>%
  filter(TeamName == Match_Home)

AwayTeamTouchData <- TouchData %>%
  filter(TeamName == Match_Away)

```

## Row  {.flow}
```{r}
#| label: home player touch plot
#| height: 100%
#| message: false

HomeconvexPlot1stsubs <- TouchPlayerPlot_AI(TouchDataHome,  title = Match_Home,
                                    plot_start = 00, plot_finish = firstSubHome, color = Color_Home, text_color = Color_Home_Text, method = "mad",
                                    subtitle = paste0(Match_Fixture, " Up to 1st subs"))
HomeconvexPlot1stsubs


```

### column {.tabset}
```{r}
#| title: On ball touch plot 1st subs
#| label: home team touch plot 1st subs
#| height: 100%
#| message: false

HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomeTeamTouchData,  title = paste0(Match_Home, " Team On Ball Touch"),
                                     plot_start = 00, plot_finish = firstSubHome, color = Color_Home, logo = "", method = "mad",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Home Team On Ball Touch Zones 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: On ball touch plot 1st Half
#| label: home team touch plot 1st half
#| height: 100%

HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomeTeamTouchData,  title = paste0(Match_Home, " Team On Ball Touch"),
                                     plot_start = 00, plot_finish = 45, color = Color_Home, logo = "", method = "mad",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Home Team On Ball Touch Zones 1st half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: On ball touch plot 2nd Half
#| label: home team touch plot 2nd half
#| height: 100%

HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomeTeamTouchData,  title = paste0(Match_Home, " Team On Ball Touch"),
                                     plot_start = 50, plot_finish = 110, color = Color_Home, logo = "", method = "mad",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Home Team On Ball Touch Zones 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

## Row {.flow}

```{r}
#| label: away player touch plot
#| height: 100%
#| message: false
#team touch plots Away
AwayconvexPlot1stSubs <- TouchPlayerPlot_AI(TouchDataAway,  title = Match_Away,
                                     plot_start = 00, plot_finish = firstSubAway,  color = Color_Away, text_color = Color_Away_Text, method = "mad",
                                     subtitle = paste0(Match_Fixture, " Up to 1st subs"))
AwayconvexPlot1stSubs

```
### column {.tabset}
```{r}
#| title: On ball touch plot 1st subs
#| label: away team touch plot 1st subs
#| height: 100%
#| message: false

AwaytouchPlot1Sub <- TouchTeamPlot_OPTA(AwayTeamTouchData,  title = paste0(Match_Away, " Team On Ball Touch"),
                                       plot_start = 00, plot_finish = firstSubAway, color = Color_Away, method = "mad",
                                       subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
AwaytouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Away Team On Ball Touch Zones 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: On ball touch plot 1st Half
#| label: away team touch plot 1st half
#| height: 100%

AwaytouchPlot1Sub <- TouchTeamPlot_OPTA(AwayTeamTouchData,  title = paste0(Match_Away, " Team On Ball Touch"),
                                       plot_start = 00, plot_finish = 45, palette =, color = Color_Away, method = "mad",
                                       subtitle = paste0(Match_Fixture, " 1st Half"))
AwaytouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Away Team On Ball Touch Zones 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: On ball touch plot 2nd Half
#| label: away team touch plot 2nd half
#| height: 100%

AwaytouchPlot1Sub <- TouchTeamPlot_OPTA(AwayTeamTouchData,  title = paste0(Match_Away, " Team On Ball Touch"),
                                       plot_start = 50, plot_finish = 110, palette =, color = Color_Away, method = "mad",
                                       subtitle = paste0(Match_Fixture, " 2nd Half"))
AwaytouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Away Team On Ball Touch Zones 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


## Row {.flow}
### column {.tabset}
```{r}
#| title: Dribbles by Game Period
#| height: 100%
HomeDribblesPlotT <- HomeDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Home, " ", DribblesTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDribblesPlotT
```

```{r}
#| title: Dules by Game Period
#| height: 100%
HomeDulesPlotT <- HomeDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  #  facet_grid(Game_Period ~ playerId) +
  labs(title = paste0(Match_Home, " ", DuelsTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDulesPlotT
```

### column {.tabset}

```{r}
#| title: Dribbles by Game Period
#| height: 100%
AwayDribblesPlotT <- AwayDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Away, " ", DribblesTitle_text, " by game period "), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDribblesPlotT

```
```{r}
#| title: Duels by Game Period
#| height: 100%
AwayDulesPlotT <- AwayDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Away, " ", DuelsTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
theme(plot.title = element_markdown(),
      plot.caption = element_markdown(),
      panel.background = element_rect(colour = "snow", fill = "snow"),
      plot.background = element_rect(fill = "snow", color = "snow"),
      plot.subtitle = element_text(colour = "black", size = 1),
      legend.position = "none",
      strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
      strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDulesPlotT

```

## Row {.flow}
### column {.tabset}
```{r}
#| height: 100%
#| title: Dribbles by Player
HomeDribblesPlotP <- HomeDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 5) +
  
  labs(title = paste0(Match_Home, " ", DribblesTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))
HomeDribblesPlotP

```


```{r}
#| height: 100%
#| title: Duels by Player
#| label: Home Duels plot by player
#canvas
HomeDulesPlotP <- HomeDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 6) +
  
  labs(title = paste0(Match_Home, " ", DuelsTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDulesPlotP
```
### column {.tabset}
```{r}
#| height: 100%
#| title: Dribbles by Player
AwayDribblesPlotP <- AwayDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 5) +
  
  labs(title = paste0(Match_Away, " ", DribblesTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDribblesPlotP
```

```{r}
#| height: 100%
#| title: Duels by Player
AwayDulesPlotP <- AwayDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 6) +
  
  labs(title = paste0(Match_Away, " ", DuelsTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))
AwayDulesPlotP

```

## Row {.flow}
### column {.tabset}
```{r}
#| title: Whole Team

Player_Summary_Plot_Home <- Player_Summary_data_Home %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Match_Home, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 4, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 3, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Home

```

```{r}
#| title: Defenders

Player_Summary_Plot_Home <- Player_Summary_data_Home %>% 
  filter(role == "Defender") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +
  force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Match_Home, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")

Player_Summary_Plot_Home

```
```{r}
#| title: Midfielders

Player_Summary_Plot_Home <- Player_Summary_data_Home %>% 
  filter(role == "Midfielder") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +
  force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Match_Home, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")

Player_Summary_Plot_Home

```
```{r}
#| title: Forwards

Player_Summary_Plot_Home <- Player_Summary_data_Home %>% 
  filter(role == "Forward") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +
  force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Match_Home, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")

Player_Summary_Plot_Home

```

### column {.tabset}
```{r}
#| title: Whole team
#| out-height: 100%
#| out-width: 100%


Player_Summary_Plot_Away <- Player_Summary_data_Away %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~factor(role, levels = c(
                                      "Keeper", 
                                      "Defender", 
                                      "Midfielder", 
                                      "Forward"
                                      )) + Name, ncol = 6) +

  guides(fill = guide_colorsteps(
      barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 4, colour = "black"))) +
  
  labs(title = paste0(Match_Away, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 4, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 3, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")
        

Player_Summary_Plot_Away

```
```{r}
#| title: Defenders

Player_Summary_Plot_Away <- Player_Summary_data_Away %>% 
  filter(role == "Defender") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +

  guides(fill = guide_colorsteps(
      barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 4, colour = "black"))) +
  
  labs(title = paste0(Match_Away, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")
        

Player_Summary_Plot_Away

```
```{r}
#| title: Midfielders
#| out-height: 100%
#| out-width: 100%


Player_Summary_Plot_Away <- Player_Summary_data_Away %>%
  filter(role == "Midfielder") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +

  guides(fill = guide_colorsteps(
      barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 4, colour = "black"))) +
  
  labs(title = paste0(Match_Away, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")
        

Player_Summary_Plot_Away

```
```{r}
#| title: Forwards
#| out-height: 100%
#| out-width: 100%


Player_Summary_Plot_Away <- Player_Summary_data_Away %>% 
  filter(role == "Forward") %>%
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~Name, ncol = 4) +

  guides(fill = guide_colorsteps(
      barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 4, colour = "black"))) +
  
  labs(title = paste0(Match_Away, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 6, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 6, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 6),
        legend.position = "top")
        

Player_Summary_Plot_Away

```
## Column {.flow}
```{r}

#| out-height: 100%
#| out-width: 100%

Player_Summary_data_A_MOM <- Player_Summary_data_Home %>% 
  filter(Name == HMOM)
  
Player_Summary_Plot_Home <- Player_Summary_data_A_MOM %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  #facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  #force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Player_Summary_data_A_MOM$Name, " Player Match Profile"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 8, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 8, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Home

```

```{r}

#| out-height: 100%
#| out-width: 100%

Player_Summary_data_MOM <- Player_Summary_data_Away %>% 
  filter(Name == AMOM)
  
Player_Summary_Plot_Away <- Player_Summary_data_MOM %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  #facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  #force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Player_Summary_data_MOM$Name, " Player Match Profile"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, \nDot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 8, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 8, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Away

```

# Threat Analysis
```{r}
#| output: false
#| label: EPV Time Data setup
#| echo: false
#set final plot data frame

#EPV over time line plot Opta data
#data wrangling
EPVPlotData <- plottingData %>%
    mutate(Home_EPV = ifelse(TeamName == Match_Home & `outcomeType/value` == 1, EPVvalue, 0)) %>%
  mutate(Home_Cumalative_EPV = cumsum(Home_EPV))

EPVPlotData <- EPVPlotData %>%
  filter(TeamName == Match_Home) %>%
  filter(!Own_Goals == 1 & TeamName == Match_Home) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Home_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
          Goal_point_Y = round(Goal_point_Y,2),
         Home_Cumalative_EPV = round(Home_Cumalative_EPV,2),
         Home_Cumalative_xG = cumsum(xG),
         Home_Cumalative_xG = round(Home_Cumalative_xG,2)) %>%
  select(TeamName, expandedMinute, minute, type, Home_Cumalative_EPV, TeamEPV, EPVvalue, Goal_point_Y, Goal_point_X, Cumalative_EPV, Home_Cumalative_EPV, Home_Cumalative_xG, Successful_Passes,Successful_Carries)

EPVdfHome <- EPVPlotData %>%
  arrange(expandedMinute) %>%
  mutate(EPV_Conversion = (Home_Cumalative_xG/Home_Cumalative_EPV)*100) %>%
  mutate(
    EPV_roll5 = slide_dbl(Home_Cumalative_EPV,
                           mean,
                           .before = 10,   
                           .complete = TRUE),
    EPV_Conversion_roll5 = slide_dbl(EPV_Conversion,
                           mean,
                           .before = 10,   
                           .complete = TRUE)) %>%    
  mutate(across(everything(), ~replace_na(., 0)))


AwayEPVPlotData <- plottingData %>%
    mutate(Away_EPV = ifelse(TeamName == Match_Away & `outcomeType/value` == 1, EPVvalue, 0)) %>%
  mutate(Away_Cumalative_EPV = cumsum(Away_EPV))

AwayEPVPlotData <- AwayEPVPlotData %>%
  filter(TeamName == Match_Away) %>%
  filter(!Own_Goals == 1 & TeamName == Match_Away) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Away_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Goal_point_Y = round(Goal_point_Y,2),
         Away_Cumalative_EPV = round(Away_Cumalative_EPV,2),
         Away_Cumalative_xG = cumsum(xG),
         Away_Cumalative_xG = round(Away_Cumalative_xG,2)) %>%
  select(TeamName, expandedMinute, minute, type, Away_Cumalative_EPV, TeamEPV, EPVvalue, Goal_point_Y, Goal_point_X, Cumalative_EPV, Away_Cumalative_EPV, Away_Cumalative_xG, Successful_Passes, Successful_Carries)


EPVdfAway <- AwayEPVPlotData %>%
  arrange(expandedMinute) %>%
  mutate(EPV_Conversion = (Away_Cumalative_xG/Away_Cumalative_EPV)*100) %>%
  mutate(
    EPV_roll5 = slide_dbl(Away_Cumalative_EPV,
                           mean,
                           .before = 10,   
                           .complete = TRUE),
    EPV_Conversion_roll5 = slide_dbl(EPV_Conversion,
                           mean,
                           .before = 10,   
                           .complete = TRUE)) %>%   
  mutate(across(everything(), ~replace_na(., 0)))
```


```{r}
#| output: false
#| echo: false
#| label: EPV Area Setup
#EPV Development area  plot Opta data
#data wrangling
EPVAreaPlotData <- plottingData

EPVAreaPlotData <- EPVAreaPlotData %>%
  filter(TeamName == Match_Home)

#set final plot data frame
EPVAreaPlotData <- EPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1 & TeamName == Match_Home) %>%
  #mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = sum(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Goal_point_Y = round(Goal_point_Y,2))

#Away EPV Development area  plot Opta data
#data wrangling
AwayEPVAreaPlotData <- plottingData

AwayEPVAreaPlotData <- AwayEPVAreaPlotData %>%
  filter(TeamName == Match_Away)

#set final plot data frame
AwayEPVAreaPlotData <- AwayEPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1 & TeamName == Match_Away) %>%
  #mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = sum(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Goal_point_Y = round(Goal_point_Y,2))


```

## Row {.flow}
```{r}
#| height: 100%
EPVTimePlot <- EPVPlotData %>%
#canvas
  ggplot(aes(x = expandedMinute, y = Home_Cumalative_EPV)) +
  
#geometrics
  
  # smoothed lines
  geom_smooth(data = EPVdfHome, aes(x = expandedMinute, y = EPV_roll5), linewidth = 1.2, color = Color_Home, fill = "snow") +
  #geom_line(size = 1.5, colour = Color_Home) +
  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +    
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute, " EPV:", Goal_point_Y)), size = 2) +
  
#formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 0.5)) +
  labs(title = paste(Match_Home, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match time (Mins)",
         caption = My_caption,
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

EPVTimePlot

```

```{r} 
#| height: 100%
#set final plot data frame
AwayEPVTimePlot <- AwayEPVPlotData %>%
  
  #canvas
  ggplot(aes(x = expandedMinute, y = Away_Cumalative_EPV)) +
  
  # smoothed lines
  geom_smooth(data = EPVdfAway, aes(x = expandedMinute, y = EPV_roll5), linewidth = 1.2, color = Color_Away, fill = "snow") +

  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +   
  
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute, " EPV:", Goal_point_Y)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 0.5)) +
  labs( title = paste0(Match_Away, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match time (Mins)",
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
AwayEPVTimePlot

```

## Row {.flow}
```{r}
#| height: 100%
#canvas
HomeEPVConversionPlot <- EPVPlotData %>%
  
  #canvas
  ggplot(aes(x = expandedMinute, y = EPV_Conversion)) +
  
  # smoothed lines
  geom_smooth(data = EPVdfHome, aes(x = expandedMinute, y = EPV_Conversion_roll5), linewidth = 1.2, color = Color_Home, fill = "snow") +

  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +   
  
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute, " EPV:", Goal_point_Y)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, 25)) +
  labs( title = paste0(Match_Home, " EPV Conversion"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match time (Mins)",
         y = "EPV Conversion %") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
HomeEPVConversionPlot
```

```{r EVP away Conversion}
#| height: 100%
#canvas
AwayEPVConversionPlot <- AwayEPVPlotData %>%
  
  #canvas
  ggplot(aes(x = expandedMinute, y = EPV_Conversion)) +
  
  # smoothed lines
  geom_smooth(data = EPVdfAway, aes(x = expandedMinute, y = EPV_Conversion_roll5), linewidth = 1.2, color = Color_Away, fill = "snow") +

  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +   
  
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute, " EPV:", Goal_point_Y)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, 25)) +
  labs( title = paste0(Match_Away, " EPV Conversion"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match time (Mins)",
         y = "EPV Conversion %") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
AwayEPVConversionPlot

```

## Row

```{r}  
#| output: false
EPVHeatMapData <- plottingData %>%
  filter(TeamName == Match_Home) %>%
  filter(Corners == 0,
         FreeKicks == 0,
         Cross_Passes == 0,
         Successful_Passes == 1,
         Successful_Carries == 1, 
         Successful_Touches == 1,
             !if_any(matches("^qualifiers/\\d+/type/value$"),
            ~ coalesce(.x == 107, FALSE)))

#set time period
EPVHeatMapDataFT <- EPVHeatMapData

# Calculate average player position
      Average_PlayerFT <- EPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPVFT <- sum(EPVHeatMapDataFT$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFT$zone_x <- cut(EPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFT$zone_y <- cut(EPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFT <- EPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFT,3)) 

#calculate for combined tile and heat map
average_epvNZFT <- average_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZFT <- average_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPVFT,2)))  


```

```{r}
#Away EPV heat plots
#| output: false
AwayEPVHeatMapData <- plottingData %>%
  filter(TeamName == Match_Away) %>%
  filter(Corners == 0,
         FreeKicks == 0,
         Cross_Passes == 0,
         Successful_Passes == 1,
         Successful_Carries == 1, 
         Successful_Touches == 1,
             !if_any(matches("^qualifiers/\\d+/type/value$"),
            ~ coalesce(.x == 107, FALSE)))


#set for time period
AwayEPVHeatMapDataFT <- AwayEPVHeatMapData

# Calculate average player position
      AwayAverage_PlayerFT <- AwayEPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPVFT <- sum(AwayEPVHeatMapDataFT$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataFT$zone_x <- cut(AwayEPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataFT$zone_y <- cut(AwayEPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvFT <- AwayEPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVFT,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZFT <- Awayaverage_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZFT <- Awayaverage_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPVFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
EPVHeatMapplotFT <- EPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
    #plot player positions
  geom_point(data = AwayAverage_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  # add zone percentage numbers
  geom_text(data = average_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
    
  #plot player names
  geom_text(data = AwayAverage_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
    #set scales
   scale_fill_paletteer_c(ColorScale_HomeC) +
   scale_color_paletteer_d(ColorScale_Home) +

  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map \nFull Game"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

EPVHeatMapplotFT
```

```{r}
#| height: 100%
AwayEPVHeatMapplotFT <- AwayEPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerFT, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map \nFull Game"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplotFT

```


```{r} 
#| output: false
#up to first subs map
#set time period
EPVHeatMapData1sub <- EPVHeatMapData %>%
  filter(expandedMinute <= firstSubHome)

# Calculate average player position
      Average_Player1Sub <- EPVHeatMapData1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))


#set EPV total for time period
HomeEPV1sub <- sum(EPVHeatMapData1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1sub$zone_x <- cut(EPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1sub$zone_y <- cut(EPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1sub <- EPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1sub,3)) 

#calculate for combined tile and heat map
average_epvNZ1sub <- average_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1sub <- average_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1sub,2)))  
```

```{r} 
#| output: false
#Post first subs map
#set time period
EPVHeatMapDataP1sub <- EPVHeatMapData %>%
  filter(expandedMinute > firstSubHome)

# Calculate average player position
      Average_PlayerP1Sub <- EPVHeatMapDataP1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPVP1sub <- sum(EPVHeatMapDataP1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapDataP1sub$zone_x <- cut(EPVHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataP1sub$zone_y <- cut(EPVHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvP1sub <- EPVHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVP1sub,3)) 

#calculate for combined tile and heat map
average_epvNZP1sub <- average_epvP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZP1sub <- average_epvNZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPVP1sub,2)))  
```

```{r}
#| output: false
#first subs
#set for time period
AwayEPVHeatMapData1sub <- AwayEPVHeatMapData %>%
  filter(expandedMinute <= firstSubAway)

# Calculate average player position
      AwayAverage_Player1Sub <- AwayEPVHeatMapData1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV1sub <- sum(AwayEPVHeatMapData1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData1sub$zone_x <- cut(AwayEPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData1sub$zone_y <- cut(AwayEPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv1sub <- AwayEPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV1sub,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ1sub <- Awayaverage_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ1sub <- Awayaverage_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV1sub,2)))  
```

```{r}
#| output: false
#post first subs
#set for time period
AwayEPVHeatMapDataP1sub <- AwayEPVHeatMapData %>%
  filter(expandedMinute > firstSubAway)

# Calculate average player position
      AwayAverage_PlayerP1Sub <- AwayEPVHeatMapDataP1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPVP1sub <- sum(AwayEPVHeatMapDataP1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataP1sub$zone_x <- cut(AwayEPVHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataP1sub$zone_y <- cut(AwayEPVHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvP1sub <- AwayEPVHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVP1sub,3)) 


#calculate for combined tile and heat map
Awayaverage_epvNZP1sub <- Awayaverage_epvP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZP1sub <- Awayaverage_epvNZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPVP1sub,2)))  
```




## Row {.flow}
```{r} 
#| output: false
#first half EPV Mao
#set time period
EPVHeatMapData1H <- EPVHeatMapData %>%
  filter(period == 1)

# Calculate average player position
      Average_Player1H <- EPVHeatMapData1H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))


#set EPV total for time period
HomeEPV1H <- sum(EPVHeatMapData1H$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1H$zone_x <- cut(EPVHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1H$zone_y <- cut(EPVHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1H <- EPVHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1H,3)) 

#calculate for combined tile and heat map
average_epvNZ1H <- average_epv1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1H <- average_epvNZ1H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1H,2)))  
```

```{r}  
#| output: false

#Second half EPV Map
#set time period
EPVHeatMapData2H <- EPVHeatMapData %>%
  filter(period == 2)

# Calculate average player position
      Average_Player2H <- EPVHeatMapData2H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPV2H <- sum(EPVHeatMapData2H$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData2H$zone_x <- cut(EPVHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData2H$zone_y <- cut(EPVHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv2H <- EPVHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV2H,3)) 

#calculate for combined tile and heat map
average_epvNZ2H <- average_epv2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ2H <- average_epvNZ2H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV2H,2))) 

```

```{r}
#| output: false
#first half
#set for time period
AwayEPVHeatMapData1H <- AwayEPVHeatMapData %>%
  filter(period == 1)

# Calculate average player position
      AwayAverage_Player1H <- AwayEPVHeatMapData1H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV1H <- sum(AwayEPVHeatMapData1H$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData1H$zone_x <- cut(AwayEPVHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData1H$zone_y <- cut(AwayEPVHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv1H <- AwayEPVHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV1H,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ1H <- Awayaverage_epv1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ1H <- Awayaverage_epvNZ1H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV1H,2)))  

```

```{r}
#| output: false
#Second half
#set for time period
AwayEPVHeatMapData2H <- AwayEPVHeatMapData %>%
  filter(period == 2)

# Calculate average player position
      AwayAverage_Player2H <- AwayEPVHeatMapData2H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV2H <- sum(AwayEPVHeatMapData2H$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData2H$zone_x <- cut(AwayEPVHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData2H$zone_y <- cut(AwayEPVHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv2H <- AwayEPVHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV2H,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ2H <- Awayaverage_epv2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ2H <- Awayaverage_epvNZ2H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV2H,2)))  
```
### column {.tabset}
```{r}
#| height: 100%
#| title: Threat 1st Half

EPVHeatMapplot1H <- EPVHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
      
  #set scales
   scale_fill_paletteer_c(ColorScale_HomeC) +
   scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map \nFirst Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1H

#save Plot
ggsave(path = Vizlocation, "Home EPV Heat Map 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| title: Threat 2nd Half

EPVHeatMapplot2H <- EPVHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player2H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ2H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player2H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_c(ColorScale_HomeC) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map \nSecond Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot2H

#save Plot
ggsave(path = Vizlocation, "Home EPV Heat Map 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

### column {.tabset}
```{r}
#| height: 100%
#| title: Threat 1st Half
AwayEPVHeatMapplot1H <- AwayEPVHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
    
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ1H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map \nFirst Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot1H

#save Plot
ggsave(path = Vizlocation, "Away EPV Heat Map 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| title: Threat 2nd Half
AwayEPVHeatMapplot2H <- AwayEPVHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  #geometrics
  #plot player positions
  geom_point(data = Average_Player2H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
    
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ2H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player2H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map \nSecond Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot2H

#save Plot
ggsave(path = Vizlocation, "Away EPV Heat Map 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
## Row {.flow}
### column {.tabset}
```{r}
#| height: 100%
#| title: Threat to 1st Sub
EPVHeatMapplot1sub <- EPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_c(ColorScale_HomeC) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map \nUp to first subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1sub

#save Plot
ggsave(path = Vizlocation, "Home EPV Heat Map 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| height: 100%
#| title: Threat Post 1st Sub
EPVHeatMapplotP1sub <- EPVHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
 annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerP1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZP1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_c(ColorScale_HomeC) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map \nPost 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplotP1sub

```

### column {.tabset}
```{r}
#| height: 100%
#| title: Threat to 1st Sub
AwayEPVHeatMapplot1sub <- AwayEPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map \nUp to 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot1sub

#save Plot
ggsave(path = Vizlocation, "Away EPV Heat Map 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| height: 100%
#| title: Threat Post 1st Sub
AwayEPVHeatMapplotP1sub <- AwayEPVHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerP1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZP1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map \nPost 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplotP1sub
```
```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#set for time period
AwayEPVHeatMapDataFTW <- AwayEPVHeatMapData

#set EPV total for time period
AwayEPVFTW <- sum(AwayEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
AwayEPVFTGP <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataFTW$zone_x <- cut(AwayEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataFTW$zone_y <- cut(AwayEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvFTW <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVFTW,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZFTW <- Awayaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  left_join(AwayEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  

  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.8, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
AwayEPVHeatMapplotFTW <- AwayEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.8, adjust = 0.75, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayEPVHeatMapplotFTW
```
## Column {.tabset}
```{r}
#| title: EPV Passing Events - Top 5 Home
#| label: Home Event tables T5
#| results: asis

EPVPassEventsTop5TableHome <- EPVPassEvents %>%
  filter(`Successful Passes` == 1,
    Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
      slice_max(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Top 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVPassEventsTop5TableHome
```
```{r}
#| title: EPV Passing Events - Bottom 5 Home
#| label: Home Event tables B5
#| results: asis

EPVPassEventsBottom5TableHome <- EPVPassEvents %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
      slice_min(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Bottom 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVPassEventsBottom5TableHome
```
```{r}
#| title: EPV Carry Events - Top 5 Home
#| label: Home Carry Event tables T5
#| results: asis

EPVCarrieEventsTop5TableHome <- EPVCarrieEvents %>%
  filter(`Successful Carries` == 1,
         Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
      slice_max(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(10,11),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Top 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVCarrieEventsTop5TableHome
```
```{r}
#| title: EPV Carry Events - Bottom 5 Home
#| label: Home Carry Event tables B5
#| results: asis

EPVCarrieEventsBottom5TableHome <- EPVCarrieEvents %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
      slice_min(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(10,11),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Bottom 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVCarrieEventsBottom5TableHome
```
## Column {.tabset}
```{r}
#| title: EPV Passing Events - Top 5 Away
#| label: Away Event tables t5
#| results: asis

EPVPassEventsTop5TableAway <- EPVPassEvents %>%
    filter(`Successful Passes` == 1,
           Receiver_Team == Match_Away, 
         Passer_Team == Match_Away) %>%
        slice_max(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Top 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVPassEventsTop5TableAway
```
```{r}
#| title: EPV Passing Events - Bottom 5 Away
#| label: Away Event tables b5
#| results: asis

EPVPassEventsBottom5TableAway <- EPVPassEvents %>%
    filter(Receiver_Team == Match_Away, 
         Passer_Team == Match_Away) %>%
        slice_min(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(14,15),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Bottom 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVPassEventsBottom5TableAway
```
```{r}
#| title: EPV Carry Events - Top 5 Away
#| label: Away Carry Event tables t5
#| results: asis

EPVCarrieEventsTop5TableAway <- EPVCarrieEvents %>%
    filter(`Successful Carries` == 1,
           Receiver_Team == Match_Away, 
         Passer_Team == Match_Away) %>%
      slice_max(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(10,11),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Top 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVCarrieEventsTop5TableAway
```
```{r}
#| title: EPV Carry Events - Bottom 5 Away
#| label: Away Carry Event tables b5
#| results: asis

EPVCarrieEventsBottom5TableAway <- EPVCarrieEvents %>%
  filter(Receiver_Team == Match_Away, 
         Passer_Team == Match_Away) %>%
      slice_min(order_by = EPV, n = 5) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_number(
    columns = c(10,11),
    decimals = 3
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Threat Events")),
    subtitle = paste0(Match_Fixture, " Bottom 5 Events")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

EPVCarrieEventsBottom5TableAway
```

# Off Ball Analysis
## Row
```{r}
#| output: false
#| echo: false
#| warning: false
#| message: false
#| label: PPDA setup
HomePPDAPlotData <- plottingData

HomePPDAPlotData <- HomePPDAPlotData %>%
  filter(TeamName == Match_Home) %>%
  filter(!Own_Goals == 1  & TeamName == Match_Home) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Home_PPDA_Cumalative), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Home_PPDA_Cumalative = round(Home_PPDA_Cumalative,2)) %>% 
  select(expandedMinute, Home_PPDA_Cumalative, TeamName, Goal_point_X, Goal_point_Y, isGoal, type, minute)

dfHome <- HomePPDAPlotData %>%
  arrange(expandedMinute) %>%
  mutate(
    PPDA_roll5 = slide_dbl(Home_PPDA_Cumalative,
                                 mean,
                                 .before = 10,   
                                 .complete = TRUE))  %>%   
  mutate(across(everything(), ~replace_na(., 0)))

AwayPPDAPlotData <- plottingData

AwayPPDAPlotData <- AwayPPDAPlotData %>%
  filter(TeamName == Match_Away) %>%
  filter(!Own_Goals == 1  & TeamName == Match_Away) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Away_PPDA_Cumalative), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Away_PPDA_Cumalative = round(Away_PPDA_Cumalative,2)) %>% 
  select(expandedMinute, Away_PPDA_Cumalative, TeamName, Goal_point_X, Goal_point_Y, isGoal, type, minute)

dfAway <- AwayPPDAPlotData %>%
  arrange(expandedMinute) %>%
  mutate(
    PPDA_roll5 = slide_dbl(Away_PPDA_Cumalative,
                           mean,
                           .before = 10,   
                           .complete = TRUE)) %>%   
  mutate(across(everything(), ~replace_na(., 0)))

```

```{r}
#| label: PPDA over time plot Home
#| height: 100%
#| warning: false
#| message: false

HomePPDATimePlot <- HomePPDAPlotData %>%
  #canvas
  ggplot(aes(x = expandedMinute, y = Home_PPDA_Cumalative)) +
  # smoothed lines
  geom_smooth(data = dfHome, aes(x = expandedMinute, y = PPDA_roll5), linewidth = 1.2, color = Color_Home, fill = "snow") +
  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 1)) +
  labs(title = paste(Match_Home, " PPDA Development"),
       subtitle = paste0(Match_Fixture),
       x = "Match time (Mins)",
       caption = My_caption,
       y = "PPDA") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

HomePPDATimePlot
```

``` {r}
#| label: PPDA over time plot Away
#| height: 100%
#| warning: false
#| message: false

AwayPPDATimePlot <- AwayPPDAPlotData %>%
  #canvas
  ggplot(aes(x = expandedMinute, y = Home_PPDA_Cumalative)) +

  # smoothed lines
  geom_smooth(data = dfAway, aes(x = expandedMinute, y = PPDA_roll5), linewidth = 1.2, color = Color_Away, fill = "snow") +
  # plot goals by ball image
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +
  # annotate with goal details
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 1)) +
  labs(title = paste(Match_Away, " PPDA Development"),
       subtitle = paste0(Match_Fixture),
       x = "Match time (Mins)",
       caption = My_caption,
       y = "PPDA") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

AwayPPDATimePlot

```

## Row

```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(TeamName == Match_Home) %>%
  filter(Defensive_Action == 1)

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(TeamName == Match_Away) %>%
  filter(Defensive_Action == 1)

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +

  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map \nFull Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerFT, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map \nFull Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```


```{r} 
#| output: false
#up to first subs map
#set time period
HomePPDAHeatMapData1sub <- HomePPDAHeatMapData %>%
  filter(expandedMinute <= firstSubHome)


#set PPDA total for time period
HomePPDA1sub <- sum(HomePPDAHeatMapData1sub$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData1sub$zone_x <- cut(HomePPDAHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData1sub$zone_y <- cut(HomePPDAHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA1sub <- HomePPDAHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA1sub,3)) 

#calculate for combined tile and heat map
average_PPDANZ1sub <- average_PPDA1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ1sub <- average_PPDANZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA1sub,2)))  
```

```{r} 
#| output: false
#Post first subs map
#set time period
HomePPDAHeatMapDataP1sub <- HomePPDAHeatMapData %>%
  filter(expandedMinute > firstSubHome)


#set PPDA total for time period
HomePPDAP1sub <- sum(HomePPDAHeatMapDataP1sub$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataP1sub$zone_x <- cut(HomePPDAHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataP1sub$zone_y <- cut(HomePPDAHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAP1sub <- HomePPDAHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAP1sub,3)) 

#calculate for combined tile and heat map
average_PPDANZP1sub <- average_PPDAP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZP1sub <- average_PPDANZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAP1sub,2)))  
```

```{r}
#| output: false
#| label: first subs away ppda
#set for time period
AwayPPDAHeatMapData1sub <- AwayPPDAHeatMapData %>%
  filter(expandedMinute <= firstSubAway)


#set PPDA total for time period
AwayPPDA1sub <- sum(AwayPPDAHeatMapData1sub$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData1sub$zone_x <- cut(AwayPPDAHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData1sub$zone_y <- cut(AwayPPDAHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA1sub <- AwayPPDAHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA1sub,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ1sub <- Awayaverage_PPDA1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ1sub <- Awayaverage_PPDANZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA1sub,2)))  
```

```{r}
#| output: false
#post first subs
#set for time period
AwayPPDAHeatMapDataP1sub <- AwayPPDAHeatMapData %>%
  filter(expandedMinute > firstSubAway)

#set PPDA total for time period
AwayPPDAP1sub <- sum(AwayPPDAHeatMapDataP1sub$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataP1sub$zone_x <- cut(AwayPPDAHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataP1sub$zone_y <- cut(AwayPPDAHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAP1sub <- AwayPPDAHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAP1sub,3)) 


#calculate for combined tile and heat map
Awayaverage_PPDANZP1sub <- Awayaverage_PPDAP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZP1sub <- Awayaverage_PPDANZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAP1sub,2)))  
```



## Row {.flow}
### column {.tabset}
```{r}
#| title: Defensive actions to 1st Sub
#| height: 100%
HomePPDAHeatMapplot1sub <- HomePPDAHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map \nUp to first subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot1sub
```

```{r}
#| height: 100%
#| title: Defensive actions Post 1st Sub
HomePPDAHeatMapplotP1sub <- HomePPDAHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerP1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZP1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map \nPost 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplotP1sub

```
### column {.tabset}
```{r}
#| height: 100%
#| title: Defensive actions to 1st Sub
AwayPPDAHeatMapplot1sub <- AwayPPDAHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map \nUp to 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot1sub
```

```{r}
#| height: 100%
#| title: Defensive actions Post 1st Sub
AwayPPDAHeatMapplotP1sub <- AwayPPDAHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerP1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZP1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map \nPost 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotP1sub
```

## Row {.flow}
```{r} 
#| output: false
#first half PPDA Mao
#set time period
HomePPDAHeatMapData1H <- HomePPDAHeatMapData %>%
  filter(period == 1)

#set PPDA total for time period
HomePPDA1H <- sum(HomePPDAHeatMapData1H$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData1H$zone_x <- cut(HomePPDAHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData1H$zone_y <- cut(HomePPDAHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA1H <- HomePPDAHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA1H,3)) 

#calculate for combined tile and heat map
average_PPDANZ1H <- average_PPDA1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ1H <- average_PPDANZ1H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA1H,2)))  
```

```{r}  
#| output: false

#Second half PPDA Map
#set time period
HomePPDAHeatMapData2H <- HomePPDAHeatMapData %>%
  filter(period == 2)

#set PPDA total for time period
HomePPDA2H <- sum(HomePPDAHeatMapData2H$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData2H$zone_x <- cut(HomePPDAHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData2H$zone_y <- cut(HomePPDAHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA2H <- HomePPDAHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA2H,3)) 

#calculate for combined tile and heat map
average_PPDANZ2H <- average_PPDA2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ2H <- average_PPDANZ2H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA2H,2))) 

```

```{r}
#| output: false
#first half
#set for time period
AwayPPDAHeatMapData1H <- AwayPPDAHeatMapData %>%
  filter(period == 1)

#set PPDA total for time period
AwayPPDA1H <- sum(AwayPPDAHeatMapData1H$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData1H$zone_x <- cut(AwayPPDAHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData1H$zone_y <- cut(AwayPPDAHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA1H <- AwayPPDAHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA1H,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ1H <- Awayaverage_PPDA1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ1H <- Awayaverage_PPDANZ1H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA1H,2)))  

```

```{r}
#| output: false
#| label: Second half away PPDA

#set for time period
AwayPPDAHeatMapData2H <- AwayPPDAHeatMapData %>%
  filter(period == 2)

#set PPDA total for time period
AwayPPDA2H <- sum(AwayPPDAHeatMapData2H$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData2H$zone_x <- cut(AwayPPDAHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData2H$zone_y <- cut(AwayPPDAHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA2H <- AwayPPDAHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA2H,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ2H <- Awayaverage_PPDA2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ2H <- Awayaverage_PPDANZ2H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA2H,2)))  
```
### column {.tabset}
```{r}
#| title: Defensive actions 1st Half
#| height: 100%

HomePPDAHeatMapplot1H <- HomePPDAHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ1H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map \nFirst Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot1H

#save Plot
ggsave(path = Vizlocation, "Home DA Heat map 1st half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: Defensive actions 2nd Half
#| height: 100%

HomePPDAHeatMapplot2H <- HomePPDAHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player2H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ2H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player2H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map \nSecond Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot2H

#save Plot
ggsave(path = Vizlocation, "Home DA Heat map 2nd half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

### column {.tabset}
```{r}
#| title: Defensive actions 1st Half
#| height: 100%
AwayPPDAHeatMapplot1H <- AwayPPDAHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ1H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map \nFirst Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot1H

#save Plot
ggsave(path = Vizlocation, "Away DA Heat map 1st half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| title: Defensive actions 2nd Half
#| height: 100%
AwayPPDAHeatMapplot2H <- AwayPPDAHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player2H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ2H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player2H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map \nSecond Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot2H

#save Plot
ggsave(path = Vizlocation, "Away DA Heat map 2nd half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup

#filter by da following pass or carries for both team
Post_DA_Action <- plottingData %>%
  mutate(Out_of_play = ifelse(eventId == 5 | eventId == 6, 1, 0)) %>%
  select(period, period_displayName, TeamName, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd, Defensive_Third, Attacking_Third, Middle_Third , Out_of_play)

Post_DA_Action <- Post_DA_Action %>%
  filter(Prev_Defensive_Action == 1
  ) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

Post_DA_Action <- shift_column(data = Post_DA_Action, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
Post_DA_Action <- shift_column(data = Post_DA_Action, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Post_DA_Action <- shift_column(data = Post_DA_Action, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)
Post_DA_Action <- shift_column(data = Post_DA_Action, columns = "Out_of_play", new_names = "Post_DA_Out", len = 1, up = TRUE)

Post_DA_Action <- Post_DA_Action %>%
  filter(Out_of_play == 0, Post_DA_Out == 0) %>%
  mutate(Successful_DA = ifelse(receiver_team == TeamName, 1, 0)) 

#Create home and away unsuccessful Da recovery data sets
Home_Post_DA_Action <- Post_DA_Action %>%
  filter(TeamName == Match_Home)

Away_Post_DA_Action <- Post_DA_Action  %>%
  filter(TeamName == Match_Away)


Home_Unsuccessful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Away,
         TeamName == Match_Home)

Away_Unsuccessful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Home,
         TeamName == Match_Away)

Home_Unsuccessful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Away,
         TeamName == Match_Home)

Away_Unsuccessful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Home,
         TeamName == Match_Away)

#create successful DA recovery home and away

Home_Successful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Home,
         TeamName == Match_Home)

Away_Successful_Post_DA_Action <- Post_DA_Action %>%
  filter(receiver_team == Match_Away,
         TeamName == Match_Away)

#set values

#totals
HomePPDAFT <- sum(Home_Post_DA_Action$Home_Defensive_Action)
HomePPDAFT_S <- sum(Home_Successful_Post_DA_Action$Prev_Defensive_Action)
HomePPDAFT_UN <- sum(Home_Unsuccessful_Post_DA_Action$Prev_Defensive_Action)

AwayPPDAFT <- sum(Away_Post_DA_Action$Away_Defensive_Action)
AwayPPDAFT_S <- sum(Away_Successful_Post_DA_Action$Prev_Defensive_Action)
AwayPPDAFT_UN <- sum(Away_Unsuccessful_Post_DA_Action$Prev_Defensive_Action)

# Successful actions by half
HomePPDAFT_S_1 <- sum(Home_Successful_Post_DA_Action$Prev_Defensive_Action[
  Home_Successful_Post_DA_Action$period == 1
], na.rm = TRUE)

HomePPDAFT_S_2 <- sum(Home_Successful_Post_DA_Action$Prev_Defensive_Action[
  Home_Successful_Post_DA_Action$period == 2
], na.rm = TRUE)


# Unsuccessful actions by half
HomePPDAFT_UN_1 <- sum(Home_Unsuccessful_Post_DA_Action$Prev_Defensive_Action[
  Home_Unsuccessful_Post_DA_Action$period == 1
], na.rm = TRUE)

HomePPDAFT_UN_2 <- sum(Home_Unsuccessful_Post_DA_Action$Prev_Defensive_Action[
  Home_Unsuccessful_Post_DA_Action$period == 2
], na.rm = TRUE)


# Successful actions
AwayPPDAFT_S_1 <- sum(Away_Successful_Post_DA_Action$Prev_Defensive_Action[
  Away_Successful_Post_DA_Action$period == 1
], na.rm = TRUE)

AwayPPDAFT_S_2 <- sum(Away_Successful_Post_DA_Action$Prev_Defensive_Action[
  Away_Successful_Post_DA_Action$period == 2
], na.rm = TRUE)

# Unsuccessful actions
AwayPPDAFT_UN_1 <- sum(Away_Unsuccessful_Post_DA_Action$Prev_Defensive_Action[
  Away_Unsuccessful_Post_DA_Action$period == 1
], na.rm = TRUE)

AwayPPDAFT_UN_2 <- sum(Away_Unsuccessful_Post_DA_Action$Prev_Defensive_Action[
  Away_Unsuccessful_Post_DA_Action$period == 2
], na.rm = TRUE)


# overall percentage wins
HomePPDAFT_S_1_WP <- HomePPDAFT_S_1/HomePPDAFT_S
HomePPDAFT_S_2_WP <- HomePPDAFT_S_2/HomePPDAFT_S

AwayPPDAFT_S_1_WP <- AwayPPDAFT_S_1/AwayPPDAFT_S
AwayPPDAFT_S_2_WP <- AwayPPDAFT_S_2/AwayPPDAFT_S

#preparedata for tables

Home_Successful_DA_table <-Home_Successful_Post_DA_Action %>%
  group_by(Half = period_displayName) %>%
  summarise(Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE), Defensive_Third_DA = sum(Defensive_Third, na.rm = TRUE), Middle_Third_DA = sum(Middle_Third, na.rm = TRUE), Attacking_Third_DA = sum(Attacking_Third, na.rm = TRUE))%>%
  mutate(
    Defensive_Third_DA = round((Defensive_Third_DA / Total_DA) * 100,0),
    Middle_Third_DA    = round((Middle_Third_DA / Total_DA) * 100, 0),
    Attacking_Third_DA = round((Attacking_Third_DA / Total_DA) * 100,0)
  ) %>% select(Half, 'Total DAs' = Total_DA, '% Defensive Third' = Defensive_Third_DA, '% Middle Third' = Middle_Third_DA, '% Attacking Third' = Attacking_Third_DA)

Home_UnSuccessful_DA_table <-Home_Unsuccessful_Post_DA_Action %>%
  group_by(Half = period_displayName) %>%
  summarise(Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE), Defensive_Third_DA = sum(Defensive_Third, na.rm = TRUE), Middle_Third_DA = sum(Middle_Third, na.rm = TRUE), Attacking_Third_DA = sum(Attacking_Third, na.rm = TRUE))%>%
  mutate(
    Defensive_Third_DA = round((Defensive_Third_DA / Total_DA) * 100,0),
    Middle_Third_DA    = round((Middle_Third_DA / Total_DA) * 100, 0),
    Attacking_Third_DA = round((Attacking_Third_DA / Total_DA) * 100,0)
  ) %>% select(Half, 'Total DAs' = Total_DA, '% Defensive Third' = Defensive_Third_DA, '% Middle Third' = Middle_Third_DA, '% Attacking Third' = Attacking_Third_DA)

Away_Successful_DA_table <-Away_Successful_Post_DA_Action %>%
  group_by(Half = period_displayName) %>%
  summarise(Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE), Defensive_Third_DA = sum(Defensive_Third, na.rm = TRUE), Middle_Third_DA = sum(Middle_Third, na.rm = TRUE), Attacking_Third_DA = sum(Attacking_Third, na.rm = TRUE))%>%
  mutate(
    Defensive_Third_DA = round((Defensive_Third_DA / Total_DA) * 100,0),
    Middle_Third_DA    = round((Middle_Third_DA / Total_DA) * 100, 0),
    Attacking_Third_DA = round((Attacking_Third_DA / Total_DA) * 100,0)
  ) %>% select(Half, 'Total DAs' = Total_DA, '% Defensive Third' = Defensive_Third_DA, '% Middle Third' = Middle_Third_DA, '% Attacking Third' = Attacking_Third_DA)

Away_UnSuccessful_DA_table <-Away_Unsuccessful_Post_DA_Action %>%
  group_by(Half = period_displayName) %>%
  summarise(Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE), Defensive_Third_DA = sum(Defensive_Third, na.rm = TRUE), Middle_Third_DA = sum(Middle_Third, na.rm = TRUE), Attacking_Third_DA = sum(Attacking_Third, na.rm = TRUE)) %>%
  mutate(
    Defensive_Third_DA = round((Defensive_Third_DA / Total_DA) * 100,0),
    Middle_Third_DA    = round((Middle_Third_DA / Total_DA) * 100, 0),
    Attacking_Third_DA = round((Attacking_Third_DA / Total_DA) * 100,0)
  ) %>% select(Half, 'Total DAs' = Total_DA, '% Defensive Third' = Defensive_Third_DA, '% Middle Third' = Middle_Third_DA, '% Attacking Third' = Attacking_Third_DA)


Home_Successful_DA_table_PP <-Home_Successful_Post_DA_Action %>%
  group_by(playerId, receiver) %>%
  summarise(Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE), Defensive_Third_DA = sum(Defensive_Third, na.rm = TRUE), Middle_Third_DA = sum(Middle_Third, na.rm = TRUE), Attacking_Third_DA = sum(Attacking_Third, na.rm = TRUE))%>%
  mutate(
    Defensive_Third_DA = round((Defensive_Third_DA / Total_DA) * 100,0),
    Middle_Third_DA    = round((Middle_Third_DA / Total_DA) * 100, 0),
    Attacking_Third_DA = round((Attacking_Third_DA / Total_DA) * 100,0),
    #Successful_DA = round((Successful_DA / Total_DA) * 100, 0),
  ) %>% select(playerId, receiver, 'Total DAs' = Total_DA, '% Defensive Third' = Defensive_Third_DA, '% Middle Third' = Middle_Third_DA, '% Attacking Third' = Attacking_Third_DA)



#DA data for tables and plots home team

# 1. Player-level totals
player_totals <- Home_Post_DA_Action %>%
  group_by(playerId) %>%
  summarise(
    Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE),
    Total_UnSuccessful_DA = sum(receiver_team == Match_Away, na.rm = TRUE), 
    Total_Successful_DA = sum(receiver_team == Match_Home, na.rm = TRUE),
    `% Total Successful DA`     = round((Total_Successful_DA       / Total_DA) * 100, 0),
    `% Total Unsuccessful DA`   = round((Total_UnSuccessful_DA     / Total_DA) * 100, 0),
    .groups = "drop"
  )

# 2. Player + receiver breakdown
player_receiver <- Home_Successful_Post_DA_Action %>%
  group_by(playerId, receiver) %>%
  summarise(
    Defensive_Third_DA  = sum(Defensive_Third, na.rm = TRUE),
    Middle_Third_DA     = sum(Middle_Third, na.rm = TRUE),
    Attacking_Third_DA  = sum(Attacking_Third, na.rm = TRUE),
    Successful_DA       = sum(Successful_DA, na.rm = TRUE),
    .groups = "drop"
  )

# 3. Join totals back onto receiver breakdown
Home_Successful_DA_table_PP <- player_receiver %>%
  left_join(player_totals, by = "playerId") %>%
  mutate(
    `% Defensive Third`   = round((Defensive_Third_DA  / Total_DA) * 100, 0),
    `% Middle Third`      = round((Middle_Third_DA     / Total_DA) * 100, 0),
    `% Attacking Third`   = round((Attacking_Third_DA  / Total_DA) * 100, 0),
    `% Successful DA`     = round((Successful_DA       / Total_DA) * 100, 0),
  ) %>%
  select(
    playerId, Total_DA, `% Total Unsuccessful DA`, `% Total Successful DA`, receiver, `% Successful DA`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
  )

#DA data for plots and tables Away team

# 1. Player-level totals
player_totals <- Away_Post_DA_Action %>%
  group_by(playerId) %>%
  summarise(
    Total_DA = sum(Prev_Defensive_Action, na.rm = TRUE),
    Total_UnSuccessful_DA = sum(receiver_team == Match_Home, na.rm = TRUE), 
    Total_Successful_DA = sum(receiver_team == Match_Away, na.rm = TRUE),
    `% Total Successful DA`     = round((Total_Successful_DA       / Total_DA) * 100, 0),
    `% Total Unsuccessful DA`   = round((Total_UnSuccessful_DA     / Total_DA) * 100, 0),
    .groups = "drop"
  )

# 2. Player + receiver breakdown
player_receiver <- Away_Successful_Post_DA_Action %>%
  group_by(playerId, receiver) %>%
  summarise(
    Defensive_Third_DA  = sum(Defensive_Third, na.rm = TRUE),
    Middle_Third_DA     = sum(Middle_Third, na.rm = TRUE),
    Attacking_Third_DA  = sum(Attacking_Third, na.rm = TRUE),
    Successful_DA       = sum(Successful_DA, na.rm = TRUE),
    .groups = "drop"
  )

# 3. Join totals back onto receiver breakdown
Away_Successful_DA_table_PP <- player_receiver %>%
  left_join(player_totals, by = "playerId") %>%
  mutate(
    `% Defensive Third`   = round((Defensive_Third_DA  / Total_DA) * 100, 0),
    `% Middle Third`      = round((Middle_Third_DA     / Total_DA) * 100, 0),
    `% Attacking Third`   = round((Attacking_Third_DA  / Total_DA) * 100, 0),
    `% Successful DA`     = round((Successful_DA       / Total_DA) * 100, 0),
  ) %>%
  select(
    playerId, Total_DA, `% Total Unsuccessful DA`, `% Total Successful DA`, receiver, `% Successful DA`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
  )

#Aerials and ground duels calculations

Post_AD_Action <- plottingData %>%
  mutate(Out_of_play = ifelse(eventId == 5 | eventId == 6, 1, 0),
         Prev_Aerial = lag(Aerial_total, default = FALSE)) %>%
  
  select(period, period_displayName, TeamName, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd, Defensive_Third, Attacking_Third, Middle_Third, Aerial_total, Aerial_Won, Aerial_Lost, Out_of_play, Prev_Aerial)

Post_AD_Action <- Post_AD_Action %>%
  filter(Prev_Aerial == 1,
  ) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

Post_AD_Action <- shift_column(data = Post_AD_Action, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
Post_AD_Action <- shift_column(data = Post_AD_Action, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Post_AD_Action <- shift_column(data = Post_AD_Action, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)
Post_AD_Action <- shift_column(data = Post_AD_Action, columns = "Out_of_play", new_names = "Post_AD_Out", len = 1, up = TRUE)

#filter and setup for main tables and plots

Post_AD_Action <- Post_AD_Action %>%
  filter(Out_of_play == 0, Post_AD_Out == 0) %>%
  mutate(Successful_AD = ifelse(receiver_team == TeamName, 1, 0))

#creat home and away data splits AD

Home_Post_AD_Action <- Post_AD_Action %>%
  filter(TeamName == Match_Home)

Away_Post_AD_Action <- Post_AD_Action  %>%
  filter(TeamName == Match_Away)


Home_Unsuccessful_Post_AD_Action <- Post_AD_Action %>%
  filter(receiver_team == Match_Away,
         TeamName == Match_Home)

Away_Unsuccessful_Post_AD_Action <- Post_AD_Action %>%
  filter(receiver_team == Match_Home,
         TeamName == Match_Away)

#create successful AD recovery home and away

Home_Successful_Post_AD_Action <- Post_AD_Action %>%
  filter(receiver_team == Match_Home,
         TeamName == Match_Home)

Away_Successful_Post_AD_Action <- Post_AD_Action %>%
  filter(receiver_team == Match_Away,
         TeamName == Match_Away)

#set values

#totals
HomePPDAFT <- sum(Home_Post_AD_Action$Aerial_total)
HomePPDAFT_S <- sum(Home_Successful_Post_AD_Action$Aerial_Won)
HomePPDAFT_UN <- sum(Home_Unsuccessful_Post_AD_Action$Aerial_Lost)

AwayPPDAFT <- sum(Away_Post_AD_Action$Aerial_total)
AwayPPDAFT_S <- sum(Away_Successful_Post_AD_Action$Aerial_Won)
AwayPPDAFT_UN <- sum(Away_Unsuccessful_Post_AD_Action$Aerial_Lost)

#set home data for tables and plots

Home_Season_AD_table <-Home_Post_AD_Action %>%
  filter(Out_of_play == 0, Post_AD_Out == 0) %>%
  group_by(playerId) %>%
  summarise(Total_AD = sum(Prev_Aerial, na.rm = TRUE), UnSuccessful_AD = sum(Aerial_Lost, na.rm = TRUE), Successful_AD = sum(Aerial_Won, na.rm = TRUE), Defensive_Third_AD = sum(Defensive_Third, na.rm = TRUE), Middle_Third_AD = sum(Middle_Third, na.rm = TRUE), Attacking_Third_AD = sum(Attacking_Third, na.rm = TRUE), Home_Regain = sum(receiver_team == Match_Home, na.rm = TRUE), Away_Regain = sum(receiver_team == Match_Away, na.rm = TRUE), 
            )%>%
  mutate(
    Defensive_Third_AD = round((Defensive_Third_AD / Total_AD) * 100,0),
    Middle_Third_AD    = round((Middle_Third_AD / Total_AD) * 100, 0),
    Attacking_Third_AD = round((Attacking_Third_AD / Total_AD) * 100,0),
    Successful_AD = round((Successful_AD / Total_AD) * 100, 0),
    UnSuccessful_AD = round((UnSuccessful_AD / Total_AD) * 100, 0),
    Home_Regain = round((Home_Regain / Total_AD) * 100, 0),
    Away_Regain = round((Away_Regain / Total_AD) * 100, 0),
  ) %>% select(playerId, #receiver, 
               'Total ADs' = Total_AD,
               '% Home Regain' = Home_Regain, 
               '% Away Regain' = Away_Regain,
               #'% Successful' = Successful_AD, 
               #'% UnSuccessful' = UnSuccessful_AD, 
               '% Defensive Third' = Defensive_Third_AD, '% Middle Third' = Middle_Third_AD, '% Attacking Third' = Attacking_Third_AD)

# 1. Player-level totals
Home_player_totals <- Home_Post_AD_Action %>%
  group_by(playerId) %>%
  summarise(
    Total_AD = sum(Prev_Aerial, na.rm = TRUE),
    #Total_UnSuccessful_AD = sum(Aerial_Lost, na.rm = TRUE), 
    #Total_Successful_AD = sum(Aerial_Won, na.rm = TRUE),
    Home_Regain = sum(receiver_team == Match_Home, na.rm = TRUE), 
    Away_Regain = sum(receiver_team == Match_Away, na.rm = TRUE),
    #`% Total Successful AD`     = round((Total_Successful_AD       / Total_AD) * 100, 0),
    #`% Total Unsuccessful AD`   = round((Total_UnSuccessful_AD     / Total_AD) * 100, 0),
    `% Home Regains`     = round((Home_Regain       / Total_AD) * 100, 0),
    `% Away Regains`   = round((Away_Regain     / Total_AD) * 100, 0),
    .groups = "drop"
  )

# 2. Player + receiver breakdown
Home_player_receiver <- Home_Successful_Post_AD_Action %>%
  group_by(playerId, receiver) %>%
  summarise(
    Defensive_Third_AD  = sum(Defensive_Third, na.rm = TRUE),
    Middle_Third_AD     = sum(Middle_Third, na.rm = TRUE),
    Attacking_Third_AD  = sum(Attacking_Third, na.rm = TRUE),
    Successful_AD       = sum(Successful_AD, na.rm = TRUE),
    .groups = "drop"
  )

# 3. Join totals back onto receiver breakdown
Home_Successful_AD_table_PP <- Home_player_receiver %>%
  left_join(Home_player_totals, by = "playerId") %>%
  mutate(
    `% Defensive Third`   = round((Defensive_Third_AD  / Home_Regain) * 100, 0),
    `% Middle Third`      = round((Middle_Third_AD     / Home_Regain) * 100, 0),
    `% Attacking Third`   = round((Attacking_Third_AD  / Home_Regain) * 100, 0),
    `% Successful AD`     = round((Successful_AD       / Home_Regain) * 100, 0),
    #`% Unsuccessful DA`   = round((UnSuccessful_DA     / Total_DA) * 100, 0)
  ) %>%
  select(
    playerId, Total_AD, 
    `% Home Regains`, 
    `% Away Regains`,
    receiver, `% Successful AD`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
    #`% Unsuccessful DA`
  )

#AD away data for plots and tables

Away_Season_AD_table <- Away_Post_AD_Action %>%
  filter(Out_of_play == 0, Post_AD_Out == 0) %>%
  group_by(playerId) %>%
  summarise(Total_AD = sum(Prev_Aerial, na.rm = TRUE), UnSuccessful_AD = sum(Aerial_Lost, na.rm = TRUE), Successful_AD = sum(Aerial_Won, na.rm = TRUE), Defensive_Third_AD = sum(Defensive_Third, na.rm = TRUE), Middle_Third_AD = sum(Middle_Third, na.rm = TRUE), Attacking_Third_AD = sum(Attacking_Third, na.rm = TRUE), Home_Regain = sum(receiver_team == Match_Away, na.rm = TRUE), Away_Regain = sum(receiver_team == Match_Home, na.rm = TRUE), 
            )%>%
  mutate(
    Defensive_Third_AD = round((Defensive_Third_AD / Total_AD) * 100,0),
    Middle_Third_AD    = round((Middle_Third_AD / Total_AD) * 100, 0),
    Attacking_Third_AD = round((Attacking_Third_AD / Total_AD) * 100,0),
    Successful_AD = round((Successful_AD / Total_AD) * 100, 0),
    UnSuccessful_AD = round((UnSuccessful_AD / Total_AD) * 100, 0),
    Home_Regain = round((Home_Regain / Total_AD) * 100, 0),
    Away_Regain = round((Away_Regain / Total_AD) * 100, 0),
  ) %>% select(playerId, #receiver, 
               'Total ADs' = Total_AD,
               '% Home Regain' = Home_Regain, 
               '% Away Regain' = Away_Regain,
               #'% Successful' = Successful_AD, 
               #'% UnSuccessful' = UnSuccessful_AD, 
               '% Defensive Third' = Defensive_Third_AD, '% Middle Third' = Middle_Third_AD, '% Attacking Third' = Attacking_Third_AD)

# 1. Player-level totals
Away_player_totals <- Away_Post_AD_Action %>%
  group_by(playerId) %>%
  summarise(
    Total_AD = sum(Prev_Aerial, na.rm = TRUE),
    #Total_UnSuccessful_AD = sum(Aerial_Lost, na.rm = TRUE), 
    #Total_Successful_AD = sum(Aerial_Won, na.rm = TRUE),
    Home_Regain = sum(receiver_team == Match_Away, na.rm = TRUE), 
    Away_Regain = sum(receiver_team == Match_Home, na.rm = TRUE),
    #`% Total Successful AD`     = round((Total_Successful_AD       / Total_AD) * 100, 0),
    #`% Total Unsuccessful AD`   = round((Total_UnSuccessful_AD     / Total_AD) * 100, 0),
    `% Home Regains`     = round((Home_Regain       / Total_AD) * 100, 0),
    `% Away Regains`   = round((Away_Regain     / Total_AD) * 100, 0),
    .groups = "drop"
  )

# 2. Player + receiver breakdown
Away_player_receiver <- Away_Successful_Post_AD_Action %>%
  group_by(playerId, receiver) %>%
  summarise(
    Defensive_Third_AD  = sum(Defensive_Third, na.rm = TRUE),
    Middle_Third_AD     = sum(Middle_Third, na.rm = TRUE),
    Attacking_Third_AD  = sum(Attacking_Third, na.rm = TRUE),
    Successful_AD       = sum(Successful_AD, na.rm = TRUE),
    .groups = "drop"
  )

# 3. Join totals back onto receiver breakdown
Away_Successful_AD_table_PP <- Away_player_receiver %>%
  left_join(Away_player_totals, by = "playerId") %>%
  mutate(
    `% Defensive Third`   = round((Defensive_Third_AD  / Home_Regain) * 100, 0),
    `% Middle Third`      = round((Middle_Third_AD     / Home_Regain) * 100, 0),
    `% Attacking Third`   = round((Attacking_Third_AD  / Home_Regain) * 100, 0),
    `% Successful AD`     = round((Successful_AD       / Home_Regain) * 100, 0),
    #`% Unsuccessful DA`   = round((UnSuccessful_DA     / Total_DA) * 100, 0)
  ) %>%
  select(
    playerId, Total_AD, 
    `% Away Regains`,
    `% Home Regains`, 
    receiver, `% Successful AD`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
    #`% Unsuccessful DA`
  )

```
### column {.tabset}
```{r}
#| title: Post DA 1st Half
#| label: Home Post DA Plot 1st Half


HomePostPPDAHeatMapplot1st <- Home_Successful_Post_DA_Action %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  #plot next pass or carrie
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplot1st

HomeSuccessful_DA_table <- Home_Successful_DA_table %>%
  gt(groupname_col = "Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Gained Post Defensive Action - Thirds Breakdown**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeSuccessful_DA_table


#save Plot
ggsave(path = Vizlocation, "Home Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| title: Post DA 2nd Half
#| label: Home Post DA Plot 2nd Half


HomePostPPDAHeatMapplot2nd <- Home_Successful_Post_DA_Action %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  #plot next pass or carrie
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplot2nd

HomeSuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Home Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

### column {.tabset}
```{r}
#| title: Post DA 1st Half
#| label: Away Post DA Plot 1st Half

AwayPostPPDAHeatMapplot1st <- Away_Successful_Post_DA_Action %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

  
  #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  #plot next pass or carrie
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplot1st

AwaySuccessful_DA_table<- Away_Successful_DA_table %>%
  gt(groupname_col = "Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Gained Post Defensive Action - Thirds Breakdown**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

AwaySuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Away Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| title: Post DA 2nd Half
#| label: Away Post DA Plot 2nd Half

AwayPostPPDAHeatMapplot2nd <- Away_Successful_Post_DA_Action %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot next pass or carrie
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplot2nd

AwaySuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Away Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
## Row
### column {.tabset}
```{r}
#| title: Oppo Post DA 1st Half
#| label: Home Post DA Plot 1st Half unsuccessful

HomeUNPostPPDAHeatMapplot_1st <- Home_Unsuccessful_Post_DA_Action %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot next pass or carrie
  scale_x_reverse() +
   
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Oppo Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomeUNPostPPDAHeatMapplot_1st

HomeUnSuccessful_DA_table <- Home_UnSuccessful_DA_table %>%
  gt(groupname_col = "Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Lost Post Defensive Action - Thirds Breakdown**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeUnSuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Home Post PD Oppo 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| title: Oppo Post DA 2nd Half
#| label: Home Post DA Plot 2nd Half unsuccessful

HomeUNPostPPDAHeatMapplot2nd <- Home_Unsuccessful_Post_DA_Action %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  #geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  #plot next pass or carrie
  scale_x_reverse() +
   
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Oppo Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomeUNPostPPDAHeatMapplot2nd

HomeUnSuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Home Post PD OPPO 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

### column {.tabset}
```{r}
#| title: Oppo Post DA 1st Half
#| label: Away Post DA Plot 1st Half unsuccessful

AwayPostPPDAHeatMapplot1st <- Away_Unsuccessful_Post_DA_Action %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +

  
  #geometrics
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
    #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #plot next pass or carrie
  scale_x_reverse() +
   
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #formatting
  labs(title = paste(Match_Away,"Oppo Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplot1st

AwayUnSuccessful_DA_table<- Away_UnSuccessful_DA_table %>%
  gt(groupname_col = "Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Lost Post Defensive Action - Thirds Breakdown**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

AwayUnSuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Away Post PD Oppo 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

```{r}
#| title: Oppo Post DA 2nd Half
#| label: Away Post DA Plot 2nd Half unsuccessful

AwayPostPPDAHeatMapplot2nd <- Away_Unsuccessful_Post_DA_Action %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  #geometrics
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #plot next pass or carrie
  scale_x_reverse() +
   
  geom_link(aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(aes(x = finalX, y = finalY, color = Prog_Action),  fill = Color_Home,  size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +

  
  #formatting
  labs(title = paste(Match_Away,"Oppo Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplot2nd

AwayUnSuccessful_DA_table

#save Plot
ggsave(path = Vizlocation, "Away Post PD Oppo 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```
## Row
```{r}
group <- Home_Successful_DA_table_PP$receiver
subgroup <- Home_Successful_DA_table_PP$playerId
value <- Home_Successful_DA_table_PP$`% Successful DA`

PostDAHomePlot <- Home_Successful_DA_table_PP %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, "\n", value, "%"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 13,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_HomeC) + 
  labs(title = paste0(Match_Home, " Successful Post DAs (Tackles, Turnovers, Interceptions, Recoverys, Clearances, Fouls, Challenges) - Possession Regains"), 
       subtitle = paste0(Match_Fixture," Darker color = Number of DAs, \n Number & Name = % of DA Winners Total Received by Player, Large Name =  DA Winner"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PostDAHomePlot

```
```{r}
group <- Away_Successful_DA_table_PP$receiver
subgroup <- Away_Successful_DA_table_PP$playerId
value <- Away_Successful_DA_table_PP$`% Successful DA`

PostDAAwayPlot <- Away_Successful_DA_table_PP %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, "\n", value, "%"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 13,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_AwayC) + 
  labs(title = paste0(Match_Away, " Successful Post DAs (Tackles, Turnovers, Interceptions, Recoverys, Clearances, Fouls, Challenges) - Possession Regains"), 
       subtitle = paste0(Match_Fixture," Darker color = Number of DAs, \n Number & Name = % of DA Winners Total Received by Player, Large Name =  DA Winner"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PostDAAwayPlot

```

## Row
```{r}
group <- Home_Successful_AD_table_PP$receiver
subgroup <- Home_Successful_AD_table_PP$playerId
value <- Home_Successful_AD_table_PP$`% Successful AD`

PostADHomePlot <- Home_Successful_AD_table_PP %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, "\n", value, "%"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 11,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_HomeC) + 
  labs(title = paste0(Match_Home, " Successful Post Aerial - Possession Regains"), 
       subtitle = paste0(Match_Fixture, " Out of Play AD excluded, Darker color = Number of ADs, \n Number & Name = % of AD Winners Total Received by Player, Large Name =  AD Winner"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PostADHomePlot

Home_AD_Regain_table<- Home_Successful_AD_table_PP %>%
    select(
    playerId, Total_AD, 
    `Total % Oppo Regains` = `% Away Regains`,
    `Total % Regains` = `% Home Regains`, 
    receiver, `% of Successful AD` = `% Successful AD`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
  ) %>%
  gt(groupname_col = "playerId") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Post Aerial Duel Success**"),
    subtitle = paste0(Match_Fixture)) %>%
  fmt_percent(
    columns = c(5:6),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

Home_AD_Regain_table

```
```{r}
group <- Away_Successful_AD_table_PP$receiver
subgroup <- Away_Successful_AD_table_PP$playerId
value <- Away_Successful_AD_table_PP$`% Successful AD`

PostADAwayPlot <- Away_Successful_AD_table_PP %>%
  
  #geometrics
  ggplot(aes(area = value, fill = value, subgroup = subgroup,
             label = paste(group, "\n", value, "%"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "black",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 11,
                    grow = FALSE) +
  #formatting
  theme(legend.position = "none",
        plot.background = element_rect(colour = "black", fill = "#E5E5E5"),
        panel.background = element_blank()) +
  scale_fill_paletteer_c(ColorScale_AwayC) + 
  labs(title = paste0(Match_Away, " Successful Post Aerial - Possession Regains"), 
       subtitle = paste0(Match_Fixture, " Out of Play AD excluded,Darker color = Number of ADs, \n Number & Name = % of AD Winners Total Received by Player, Large Name =  AD Winner"),
       caption = my_socials) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

PostADAwayPlot

Away_AD_Regain_table <- Away_Successful_AD_table_PP %>%
    select(
    playerId, Total_AD, 
    `Total % Oppo Regains` = `% Away Regains`,
    `Total % Regains` = `% Home Regains`, 
    receiver, `% of Successful AD` = `% Successful AD`,
    `% Defensive Third`, `% Middle Third`,
    `% Attacking Third`
  ) %>%
  
  gt(groupname_col = "playerId") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Possession Post Aerial Duel Success**"),
    subtitle = paste0(Match_Fixture)) %>%
  fmt_percent(
    columns = c(5:6),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

Away_AD_Regain_table
```

## Row {.flow}
### column {.tabset}
```{r}
#| label: home team off ball touch plot subs
#| title: Off ball touch map to 1st subs


HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomePPDAHeatMapData,  title = paste0(Match_Home, " Team Off Ball Touch"),
                                     plot_start = 00, plot_finish = firstSubHome, color = Color_Home, logo = "",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Home Team Off Ball Touch Zones 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| label: home team off ball touch plot 1st half
#| title: Off ball touch map to 1st half


HometouchPlot1half <- TouchTeamPlot_OPTA(HomePPDAHeatMapData,  title = paste0(Match_Home, " Team Off Ball Touch"),
                                     plot_start = 00, plot_finish = 45, color = Color_Home, logo = "",
                                     subtitle = paste0(Match_Fixture, " 1st Half"))
HometouchPlot1half

#save Plot
ggsave(path = Vizlocation, "Home Team Off Ball Touch Zones 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| label: home team off ball touch plot 2 half
#| title: Off ball touch map to 2nd half


HometouchPlot2half <- TouchTeamPlot_OPTA(HomePPDAHeatMapData,  title = paste0(Match_Home, " Team Off Ball Touch"),
                                     plot_start = 50, plot_finish = 110, color = Color_Home,  logo = "",
                                     subtitle = paste0(Match_Fixture, " 2nd half"))
HometouchPlot2half

#save Plot
ggsave(path = Vizlocation, "Home Team Off Ball Touch Zones 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

### column {.tabset}
```{r}
#| label: Away team off ball touch plot subs
#| title: Off ball touch map to 1st subs

AwaytouchPlot1Sub <- TouchTeamPlot_OPTA(AwayPPDAHeatMapData,  title = paste0(Match_Away, " Team Off Ball Touch"),
                                     plot_start = 00, plot_finish = firstSubAway, color = Color_Away,  logo = "",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
AwaytouchPlot1Sub

#save Plot
ggsave(path = Vizlocation, "Away Team Off Ball Touch Zones 1st Sub.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| label: Away team off ball touch plot 1 half
#| title: Off ball touch map to 1st Half

AwaytouchPlot1half <- TouchTeamPlot_OPTA(AwayPPDAHeatMapData,  title = paste0(Match_Away, " Team Off Ball Touch"),
                                     plot_start = 00, plot_finish = 45, color = Color_Away,  logo = "",
                                     subtitle = paste0(Match_Fixture, " 1st Half"))
AwaytouchPlot1half

#save Plot
ggsave(path = Vizlocation, "Away Team Off Ball Touch Zones 1st half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
```{r}
#| label: Away team off ball touch plot 2 half
#| title: Off ball touch map 2nd Half

AwaytouchPlot2half <- TouchTeamPlot_OPTA(AwayPPDAHeatMapData,  title = paste0(Match_Away, " Team Off Ball Touch"),
                                     plot_start = 50, plot_finish = 110, color = Color_Away,  logo = "",
                                     subtitle = paste0(Match_Fixture, " 2nd Half"))
AwaytouchPlot2half

#save Plot
ggsave(path = Vizlocation, "Away Team Off Ball Touch Zones 2nd half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

# xG & Shot Analysis
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: xG setup

#Load home data
dashboard_data <- plottingData

dashboard_data <- dashboard_data %>%
  filter(TeamName == Match_Home) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1  & TeamName == Match_Home) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, OTShots, minute, expandedMinute, result = type, player = playerId, period, Game_Period)

#Load away data
Awaydashboard_data <- plottingData

Awaydashboard_data <- Awaydashboard_data %>%
  filter(TeamName == Match_Away) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1  & TeamName == Match_Away) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, OTShots, minute, expandedMinute, result = type, player = playerId, period, Game_Period)

```


## Row

```{r home xG line}

# Line Plot

  xGLinePlot <- dashboard_data %>%
    ggplot() +
  #Geometrics
  #xg line
  geom_line(aes(x = expandedMinute, y = TotalxG), linewidth = 2, colour = Color_Home) +
  
  #npXg line
  geom_line(aes(x = expandedMinute, y = TotalNPxG), linewidth = 1, colour = Color_Home, linetype = "dashed") +
  
  #xGOT line
  geom_line(aes(x = expandedMinute, y = TotalxGOT), linewidth = 1, colour = "ivory4") +
  
  #add ball image for goals
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(result, " Min:", expandedMinute, "\nxG:", xG)), size = 2) +

  #formatting
  expand_limits(x = 0, y = 0) +
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 0.2)) +
  labs(x = "Match Time (mins)", 
       y = "xG, NPxG, xGOT",
       title = paste0(Match_Home, " ", xGlineTitle_text),
       caption = My_caption,
       subtitle = paste0(Match_Fixture))  +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        plot.title.position = "plot",
        plot.subtitle = element_text(size = 12),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(size = 8),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none",
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

xGLinePlot

```

```{r away xG line}
# Line Plot
#canvas
xGLinePlotAway <- Awaydashboard_data %>%
  ggplot() +
  
  #Geometrics
  #plot xg line
  geom_line(aes(x = expandedMinute, y = TotalxG), linewidth = 2, colour = Color_Away) +
  
  #npXg line
  geom_line(aes(x = expandedMinute, y = TotalNPxG), linewidth = 1, colour = Color_Away, linetype = "dashed") +
  
  #xGOT line
  geom_line(aes(x = expandedMinute, y = TotalxGOT), linewidth = 1, colour = "ivory4") +
  
  #add ball image for goals
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Documents/Dropbox files/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(result, " Min:", expandedMinute, "\nxG:", xG)), size = 2) +
  

  #formatting
  expand_limits(x = 0, y = 0) +
  scale_x_continuous(breaks = seq(0, 135, 15)) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 0.2)) +
  labs(x = "Match Time (mins)", 
       y = "xG, NPxG, xGOT",
       title = paste0(Match_Away, " ", AwayxGlineTitle_text), 
       caption = My_caption,
       subtitle = paste0(Match_Fixture))  +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        plot.title.position = "plot",
        plot.subtitle = element_text(size = 12),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(size = 8),
        text = element_text(color = "gray12", family = "Arial"),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

xGLinePlotAway
```

## Row

```{r home density plot}

# Density Shot Map
#canvas
xGDensityPlot <- dashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture, "\nDarker Colour + Tighter Lines = Higher xG"),
       fill = "xG Level",
       color = "xG Level",
       caption = My_caption,
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        legend.position = "none",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

#xGDensityPlot_I
xGDensityPlot

```

```{r away density plot}

# Density Shot Map

#canvas
xGDensityPlotAway <- Awaydashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
          annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) + 
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture, "\nDarker Colour + Tighter Lines = Higher xG"),
       fill = "xG Level",
       color = "xG Level",
       caption = My_caption,
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),        
        plot.caption = element_markdown(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

xGDensityPlotAway_I <- ggplotly(xGDensityPlotAway, tooltip = "text")

xGDensityPlotAway_I <- xGDensityPlotAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

#xGDensityPlotAway_I
xGDensityPlotAway
```



## Row

```{r home bubble plot}

ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  filter(TeamName == Match_Home)

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 5)) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, 1)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
#xGBubble_Plot
```

```{r away bubble plot}

AwayShotBubblexG_data <- plottingData 

AwayShotBubblexG_data <- AwayShotBubblexG_data %>%
  filter(TeamName == Match_Away)

AwayShotBubblexG_data <- AwayShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGAwayBubblePlot_data <- AwayShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGAwayBubblePlot_data <- xGAwayBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGAwayBubblePlot_data_pivot <- xGAwayBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  AwayxGBubble_Plot <- xGAwayBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 5)) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, 1)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

AwayxGBubble_Plot_I  <- ggplotly(AwayxGBubble_Plot, tooltip = "text")

AwayxGBubble_Plot_I <- AwayxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
AwayxGBubble_Plot_I
#AwayxGBubble_Plot

```

## Row
### column {.tabset}
```{r}
#| title: Full Time xG Situation
#| label: Home Situation plot ft
# Bar Plot

xGSituationBarData <- dashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I
#xGSituationBar

```
```{r}
#| title: 1st Half xG Situation
#| label: Home Situation plot 1h
# Bar Plot

xGSituationBarData <- dashboard_data %>%
    filter(period == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I
#xGSituationBar

```

```{r}
#| title: 2nd Half xG Situation
#| label: Home Situation plot 2h
# Bar Plot

xGSituationBarData <- dashboard_data %>%
  filter(period == 2) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I
#xGSituationBar

```

### column {.tabset}
```{r}
#| title: Full Time xG Situation
#| label: Away Situation plot ft
# Bar Plot
xGSituationBarAwayData <- Awaydashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarAway <- xGSituationBarAwayData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarAway_I <- ggplotly(xGSituationBarAway, tooltip = "xG")

xGSituationBarAway_I <- xGSituationBarAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarAway_I
#xGSituationBarAway
```
```{r}
#| title: 1st Half  xG Situation
#| label: Away Situation plot 1h
# Bar Plot
xGSituationBarAwayData <- Awaydashboard_data %>%
  filter(period == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarAway <- xGSituationBarAwayData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarAway_I <- ggplotly(xGSituationBarAway, tooltip = "xG")

xGSituationBarAway_I <- xGSituationBarAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarAway_I
#xGSituationBarAway
```

```{r}
#| title: 2nd Half xG Situation
#| label: Away Situation plot 2nd
# Bar Plot
xGSituationBarAwayData <- Awaydashboard_data %>%
  filter(period == 2) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarAway <- xGSituationBarAwayData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarAway_I <- ggplotly(xGSituationBarAway, tooltip = "xG")

xGSituationBarAway_I <- xGSituationBarAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarAway_I
#xGSituationBarAway
```
## Row {.flow}
### column {.tabset}
```{r}
#| title: Overall shot map
#| height: 200%
#| out-height: 200%
#| out-width: 100%

#shot map
Home_S_plot <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team", mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

#save Plot
ggsave(path = Vizlocation, "Home Team Shot Map.png", width = 2500, height = 2150, units = "px", dpi = 400)

Home_S_plot_I <- ggplotly(Home_S_plot, tooltip = "text")

Home_S_plot_I <- Home_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

Home_S_plot_I
#Home_S_plot

```
```{r}
#| title: Shot Map by player
#| height: 200%
#| out-height: 200%
#| out-width: 100%

Home_S_plotW <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team", mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Player")

Home_S_plotW_I <- ggplotly(Home_S_plotW, tooltip = "text")
Home_S_plotW_I <- Home_S_plotW_I %>%
    config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
 Home_S_plotW_I 
#Home_S_plotW
```

```{r}
#| title: Shot Map by time
#| height: 200%
#| out-height: 200%
#| out-width: 100%

Home_S_plotWT <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team", mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

Home_S_plotWT_I <- ggplotly(Home_S_plotWT, tooltip = "text")
Home_S_plotWT_I <- Home_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Home_S_plotWT_I
#Home_S_plotWT
```

### column {.tabset}
```{r}
#| title: Overall Shot Map
#| height: 200%
#| out-height: 200%
#| out-width: 100%
Away_S_plot <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team",  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

#save Plot
ggsave(path = Vizlocation, "Away Team Shot Map.png", width = 2500, height = 2150, units = "px", dpi = 400)

Away_S_plot_I <- ggplotly(Away_S_plot, tooltip = "text")


Away_S_plot_I <- Away_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Away_S_plot_I
#Away_S_plot

```

```{r}
#| title: Shot Map by player
#| height: 200%
#| out-height: 200%
#| out-width: 100%

Away_S_plotW <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team",  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Player")

Away_S_plotW_I <- ggplotly(Away_S_plotW, tooltip = "text")
Away_S_plotW_I <- Away_S_plotW_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
#Away_S_plotW
Away_S_plotW_I

```

```{r}
#| title: Shot Map by time
#| height: 200%
#| out-height: 200%
#| out-width: 100%

Away_S_plotWT <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = "Team",  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

Away_S_plotWT_I <- ggplotly(Away_S_plotWT, tooltip = "text")
Away_S_plotWT_I <- Away_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Away_S_plotWT_I
#Away_S_plotWT
```
