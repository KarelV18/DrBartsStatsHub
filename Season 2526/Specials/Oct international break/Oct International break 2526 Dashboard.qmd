---
title: "Oct International Break 2526"
author: "Dr Phil Barter"
format: 
  dashboard:
      scrolling: true
      logo: https://anfieldindex.com/wp-content/uploads/2016/09/AI-Under-Pressure.png
      nav-buttons: 
                  - icon: github
                    href: https://github.com/Barts78
                  - icon: linkedin
                    href: https://www.linkedin.com/in/phil-barter-55500122/
                  - icon: twitter
                    href: https://twitter.com/Barts78
                    
      theme: 
        - Lux
        - Matchdash.scss
      type: default 
---

```{r}
#' Simulate Football Match Outcomes Based on xG
#'
#' @param home_xg_vector Numeric vector of xG values for each home team shot
#' @param away_xg_vector Numeric vector of xG values for each away team shot
#' @param runs Number of simulations to perform (default: 10000)
#' @param seed Random seed for reproducibility (default: 1111)
#'
#' @return A list containing:
#' - `prob_matrix`: A matrix of scoreline probabilities
#' - `long_prob_matrix`: Data frame for plotting with ggplot
#' - `simulation_results`: Data frame of simulated outcomes


simulate_match_outcomes <- function(
  home_xg_vector, 
  away_xg_vector, 
  runs = 10000, 
  seed = 1111,
  actual_home_goals = NULL,
  actual_away_goals = NULL
) {
  set.seed(seed)

  safe_simulate_goals <- function(xg_vector, runs) {
    # Flatten in case it's a list (like from dplyr::select)
    xg_vector <- unlist(xg_vector)

    if (length(xg_vector) == 0) return(rep(0, runs))

    # Clean and clip to [0, 1]
    xg_vector <- as.numeric(xg_vector)
    xg_vector <- xg_vector[!is.na(xg_vector)]
    xg_vector <- pmin(pmax(xg_vector, 0), 1)

    if (length(xg_vector) == 0) return(rep(0, runs))

    draws <- rbinom(length(xg_vector) * runs, size = 1, prob = rep(xg_vector, each = runs))
    goals_matrix <- matrix(draws, nrow = runs, byrow = FALSE)
    rowSums(goals_matrix)
  }

  home_goals <- safe_simulate_goals(home_xg_vector, runs)
  away_goals <- safe_simulate_goals(away_xg_vector, runs)

  simulation_results <- data.frame(Home = home_goals, Away = away_goals)
  prob_matrix <- table(simulation_results$Home, simulation_results$Away) / runs

  long_prob_matrix <- as.data.frame(as.table(prob_matrix))
  colnames(long_prob_matrix) <- c("Home", "Away", "Probability")
  long_prob_matrix <- long_prob_matrix %>%
    mutate(Probability = round(Probability * 100, 2))

  goal_summary <- NULL
  if (!is.null(actual_home_goals) && !is.null(actual_away_goals)) {
    exact_count <- sum(home_goals == actual_home_goals & away_goals == actual_away_goals)
    at_least_home <- sum(home_goals >= actual_home_goals)
    at_least_away <- sum(away_goals >= actual_away_goals)

    goal_summary <- list(
      actual_score = paste(actual_home_goals, "-", actual_away_goals),
      exact_occurrences = exact_count,
      exact_percentage = round(100 * exact_count / runs, 2),
      home_goals_at_least = at_least_home,
      away_goals_at_least = at_least_away,
      home_goals_at_least_pct = round(100 * at_least_home / runs, 2),
      away_goals_at_least_pct = round(100 * at_least_away / runs, 2)
    )
  }

  return(list(
    prob_matrix = prob_matrix,
    long_prob_matrix = long_prob_matrix,
    simulation_results = simulation_results,
    goal_summary = goal_summary
  ))
}


```

```{r}
#| label: Team season sumary function 

# Reusable function to compute team summary metrics
compute_season_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV)) %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(Match_day = first(Match_day),
              n_matches = n_distinct(game_name),
              across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
),
        ~ sum(.x, na.rm = TRUE) / n_matches
      ),
      #.groups = "drop"
    ) %>%
    #select(-n_matches) %>%
    mutate(
      In_play_time = round(In_play_time / 60, 1),
      Possession   = round((Touches / (sum(Touches))) * 100, 1),
      Field_Tilt   = round((Final_Third_Touches / (sum(Final_Third_Touches))) * 100, 1),
      Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
      Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
      Long_Pass_Rate    = round((Long_Passes / Attempted_Passes) * 100, 2),
      Cross_Success     = round((Successful_Cross / Cross_Passes) * 100, 2),
      Failed_Pass    = Attempted_Passes - Successful_Passes,
      Failed_Cross   = Cross_Passes - Successful_Cross,
      Failed_Dribble = Dribbles_Total - Dribbles_Won,
      Poss_Gained = Interceptions_Total + Recoverys_Total +
                    (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
      Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble +
                  OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
      Posession_Control =
        Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
        (Aerial_Won - Aerial_Lost) -
        (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
         UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
      `EPV % xG Con.`   = round((xG   / TeamEPV) * 100, 1),
      `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1)
    ) %>%
    mutate(across(everything(), ~ replace_na(.x, 0))) %>%
    mutate(dplyr::across(where(is.numeric), ~ round(.x, 2)))
}

```

```{r}
#| label: Team sumary function 

# Reusable function to compute team summary metrics
compute_summary <- function(data, group_vars) {
  data %>%
    mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0),
           TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), EPVvalue, 0),
           TeamEPV = as.numeric(TeamEPV)) %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(Match_day = first(Match_day), 
              across(c(Goals, In_play_time, Touches, UnSuccessful_Touches, PK_Box_Touches,
                       Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches,
                       Mis_Control, Dispossessed_Total, Dribbles_Total, Dribbles_Won, Dribbles_Lost,
                       TotalShots, OFShots, Blocked_Shot, OTShots, SixYard_Box_Shots,
                       PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, 
                       Attempted_Passes,
                       Successful_Passes, 
                       UnSuccessful_Passes, 
                       Long_Passes, 
                       Successful_Long_Passes,
                       Corners, 
                       Short_Corners, 
                       Cross_Passes, 
                       Successful_Cross, 
                       UnSuccessful_Cross,
                       Tackles_Total, 
                       Tackles_Won, 
                       Tackles_Lost, 
                       Fouls_Total, 
                       Fouls_Conceeded,
                       Fouls_Received, 
                       Aerial_Won, 
                       Aerial_Lost,
                       Clearances_Total,
                       Interceptions_Total,
                       Recoverys_Total, 
                       Offside_Won, 
                       Offside_Lost, 
                       TeamEPV, 
                       Defensive_Third_Touches, 
        Middle_Third_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries,
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        MyxA,
        TeamxT,
        Aerial_total, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost,
        ),
                 sum, na.rm = TRUE)) %>%
    mutate(In_play_time = round(In_play_time / 60, 1),
           Possession = round((Touches/(sum(Touches)))*100,1),
           Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1),
           Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
           Long_Pass_Success = round((Successful_Long_Passes / Long_Passes) * 100, 1),
           Long_Pass_Rate = round((Long_Passes / Attempted_Passes) * 100, 2),
           Cross_Success = round((Successful_Cross / Cross_Passes) * 100, 2),
           Failed_Pass = Attempted_Passes - Successful_Passes,
           Failed_Cross = Cross_Passes - Successful_Cross,
           Failed_Dribble = Dribbles_Total - Dribbles_Won,
           Poss_Gained = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) + (Aerial_Won - Aerial_Lost),
           Poss_Lost = Mis_Control + Failed_Pass + Failed_Cross + Failed_Dribble + OFShots + Blocked_Shot + Dispossessed_Total + Offside_Lost,
           Posession_Control = Interceptions_Total + Recoverys_Total + (Tackles_Won - Tackles_Lost) +
                               (Aerial_Won - Aerial_Lost) -
                               (Mis_Control + Dispossessed_Total + UnSuccessful_Passes +
                               UnSuccessful_Cross + Dribbles_Lost + OFShots + Blocked_Shot + Offside_Lost),
           `EPV % xG Con.` = round((xG / TeamEPV) * 100, 1),
           `EPV % NPxG Con.` = round((NPxG / TeamEPV) * 100, 1),
           ) %>%
    
    mutate(across(everything(), ~replace_na(.x, 0))) 
  
}

```

``` {r}
#| label: Shift column function
# Shift column funtion, this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

```

```{r}
#| output: false
#| label: touch area function Quantiles
#' Function for plotting Player touch areas
#' Function for plotting Team touch areas - set at 75%

#calculate touch area of player - set at 75% using quantiles
touch_area_shape_quantiles <- function(data) {
  
  x_low <- quantile(data$x, 0.15)
  x_high <- quantile(data$x, 0.85)
  
  y_low <- quantile(data$y, 0.15)
  y_high <- quantile(data$y, 0.85)
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}
```
```{r}

#| output: false
#| label: touch area function Mad
#' Function for plotting Player touch areas using 1.5 MAD( 75% of data) Mediands
touch_area_shape_mad <- function(data) {
  
  x_median <- median(data$x)
  y_median <- median(data$y)
  
  x_mad <- median(abs(data$x - x_median))/0.6745
  y_mad <- median(abs(data$y - y_median))/0.6745
  
  x_low <- x_median - 1.5*x_mad
  x_high <- x_median + 1.5*x_mad
  
  y_low <- y_median - 1.5*y_mad
  y_high <- y_median + 1.5*y_mad
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

```


```{r}
#| output: false
#| label: Enhanced TouchPlayerPlot_AI with method selection and dynamic faceting
TouchPlayerPlot_AI <- function(
  data,
  color = "firebrick4",
  text_color = "",
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "quantile",  # or "mad"
  facet_by = "playerId"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    filter(`type/value` %in% c(1, 2, 3, 4, 7, 8, 9, 10:16, 41, 42, 44, 45, 50, 52, 54, 61, 73, 74),
           `outcomeType/value` == 1) %>%
    drop_na(playerId, x, y) %>%
    filter(between(expandedMinute, plot_start, plot_finish))

  list_data <- split(data, data$playerId)

  # Use appropriate shape function
  shape_fn <- if (method == "mad") touch_area_shape_mad else touch_area_shape_quantiles
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    na.omit()

  teamtitle <- paste(title, "Player Touch Areas")

  player_touch_map <- ggplot(touch_area_data) +
    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
    
    geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey") +
    geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey") +
    geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey") +
    
    geom_point(data = data, aes(x = x, y = y), alpha = 0.5, colour = "black", size = 1) +
    geom_polygon(aes(x = x, y = y), colour = color, alpha = 0.2, fill = color, size = 0.4) +
    geom_point(data = PlayerPos, aes(x = x, y = y), colour = color, alpha = 0.8, shape = 19, size = 2) +
    facet_wrap(as.formula(paste("~", facet_by)), ncol = 5) +
    labs(
      title = teamtitle,
      x = "",
      subtitle = paste(subtitle, "
Area = 75% of activity, Team Colour Dot = Player Average Position"),
      caption = My_caption
    ) +
    theme(
      legend.position = "none",
      plot.background = element_rect(colour = "snow", fill = "snow"),
      panel.background = element_rect(colour = "snow", fill = "snow"),
      strip.background = element_rect(fill = color, color = "black", linetype = "solid", linewidth = 1),
      strip.text = element_text(size = 8, colour = text_color),
      plot.title = element_text(colour = "black", size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_blank()
    )

  if (logo == "Yes") {
    player_touch_mapAI <- ggdraw() +
      draw_plot(player_touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.445, y = 0.438, scale = 0.12)
  } else {
    player_touch_mapAI <- player_touch_map
  }

  return(player_touch_mapAI)
}
```

```{r}
#| output: false
#| lable: Enhanced TouchTeamPlot_OPTA with method selection
TouchTeamPlot_OPTA <- function(
  data,
  color = "#E74C3C",
  palette = NULL,
  title = "",
  subtitle = "",
  plot_start = 0,
  plot_finish = 45,
  logo = "",
  method = "mad"  # or "quantile"
) {
  required_cols <- c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "file_name", "role")
  if (nrow(data) == 0 || !all(required_cols %in% names(data))) {
    stop("The dataset has insufficient columns and/or insufficient data.")
  }

  data <- data %>%
    drop_na(playerId, x, y) %>%
    filter(dplyr::between(expandedMinute, plot_start, plot_finish))

  shape_fn <- if (method == "quantile") touch_area_shape_quantiles else touch_area_shape_mad
  list_data <- split(data, data$playerId)
  touch_area_data <- purrr::map(list_data, shape_fn) %>% purrr::reduce(dplyr::full_join)

  PlayerPos <- touch_area_data %>%
    group_by(playerId) %>%
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    tidyr::drop_na()

  # ---- NEW: build palette from `palette` or default white -> color ramp ----
  players <- sort(unique(as.character(touch_area_data$playerId)))
  n <- length(players)

  build_palette <- function(players, palette, color) {
    n <- length(players)

    # 1) Named vector mapping playerId -> color
    if (is.character(palette) && !is.null(names(palette))) {
      if (!all(players %in% names(palette))) {
        warning("Named palette does not cover all players; missing players will be auto-colored.")
      }
      cols <- palette[players]
      # fill any NAs (uncovered players) from a white->color ramp
      if (anyNA(cols)) {
        fill_cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(sum(is.na(cols)))
        cols[is.na(cols)] <- fill_cols
      }
      names(cols) <- players
      return(cols)
    }

    # 2) Paletteer "pkg::pal" string
    if (is.character(palette) && length(palette) == 1 && grepl("::", palette, fixed = TRUE)) {
      if (requireNamespace("paletteer", quietly = TRUE)) {
        cols <- as.character(paletteer::paletteer_d(palette, n))
        names(cols) <- players
        return(cols)
      } else {
        warning("paletteer not installed; falling back to white -> color ramp.")
      }
    }

    # 3) Plain vector of colors to interpolate
    if (is.character(palette) && length(palette) >= 1) {
      cols <- grDevices::colorRampPalette(palette)(n)
      names(cols) <- players
      return(cols)
    }

    # Default: white -> color ramp (keeps your 'min = white' feel)
    cols <- grDevices::colorRampPalette(c("#FFFFFF", color))(n)
    if (n == 1) cols <- color
    names(cols) <- players
    cols
  }

  pal <- build_palette(players, palette, color)

  # lock factor levels
  touch_area_data <- touch_area_data %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  PlayerPos <- PlayerPos %>%
    mutate(playerId = factor(as.character(playerId), levels = players))
  # -------------------------------------------------------------------------

  teamtitle <- paste(title, "Areas")

  touch_map <- ggplot(touch_area_data) +
    
    # use the palette (discrete by player)
    scale_fill_manual(values = pal) +
    scale_colour_manual(values = pal) +

    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
    annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9),
             x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83),
             y = 0, yend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    #plot player touch area
    geom_polygon(aes(x = x, y = y, fill = playerId, colour = playerId), alpha = 0.15, size = 0.5) +
    #plot player average position
    geom_point(data = PlayerPos, aes(x = x, y = y, fill = playerId, colour = playerId),
               alpha = 0.7, shape = 21, size = 3, stroke = 0.5) +
    # plot player name
    geom_text(data = PlayerPos, aes(x = x, y = y + 4, label = playerId, colour = playerId), size = 3) +
    labs(
      title = teamtitle,
      subtitle = paste(subtitle, "\nArea = 75% of activity, Dot = Player Average Position"),
      caption = My_caption,
      x = ""
    ) +
    theme(
      strip.background = element_rect(fill = "#E5E5E5", 
      colour = NA), strip.text = element_text(colour = "black", size = 10), 
      plot.title = element_text(colour = "black", 
      size = 14, face = "bold"),
      plot.subtitle = element_text(colour = "black", size = 10),
      plot.caption = element_markdown(),
      axis.title.x = element_text(colour = "black", size = 12, face = "bold"),
      legend.position = "none"
    )

  if (logo == "Yes") {
    touch_mapAI <- ggdraw() +
      draw_plot(touch_map, x = 0, y = 0, width = 1, scale = 1) +
      draw_image(logo_AI, x = 0.4, y = 0.45, scale = 0.07)
  } else {
    touch_mapAI <- touch_map
  }

  return(touch_mapAI)
}

```

```{r shot map function}
#| output: false

#' Function for plotting shots for a team

plot_shot_AI <- function(data, type = "", teamColor = "#B22222", text_color = "", bins = 30, highlight_goals = "", average_location = "", matchFixture = "", mapName = "", mapType = "", matchDate = "", dataSource = "", logo = "", wrap = "") {
  
  # Checking data frame   
  if ((nrow(data) > 0) &&
      sum(c("minute", "X", "Y", "xG", "result", "player") %in% names(data)) == 6) {

    # set plot names
    if (dataSource == "UnderStat") {
      
      if (mapType == "Home") {
      
        home_team <- (data$home_team[nrow(data)])
        
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "Away") {
      
        away_team <- (data$away_team[nrow(data)]) 
        
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
    
      } else if (mapType == "Player") {  
      
        last <- sub(".* ", "", data$player[nrow(data)])
        first <- sub(" .*", "", data$player[nrow(data)])
        player_name <- paste(first, last)
      
        #shot_map_name <- paste(player_name, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
      
    } else if (dataSource == "FotMob") {
      if (mapType == "Home") {
        
        home_team <- (data$home_team[nrow(data)]) 
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$away_team[nrow(data)]) 
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        last <- (data$last_name[nrow(data)])
        first <- (data$first_name[nrow(data)])
        player_name <- paste(first, last)
        
        #shotshot_map_name_name <- paste(player_name, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
        
    } else if (dataSource == "Opta") {
      if (mapType == "Home") {
        
        home_team <- (data$TeamName[nrow(data)]) 
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$TeamName[nrow(data)]) 
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        player_name <- (data$playerId[nrow(data)])
        
        #shot_map_name <- paste(player, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
    }
      
    fixture_name <- paste(matchFixture, "(",dataSource,")")
  

    # set Plot Colours and scale
    fill_b <- "#E5E5E5"
    color_b <- "black"
    colorLine <- "#95A5A6"
    colorText <- "black"
    fill_Goal <- c("No Goal" = fill_b, "Goal" = teamColor)
    
    # Data Wrangling 
    if (dataSource == "UnderStat") {
      data <- data %>%
        mutate(X = 100 * X) %>%
        mutate(Y = 100 * Y)
      
     } else if (dataSource == "FotMob") {
        data <- data %>%
             mutate(X = (X * 0.941050375),
                    Y = (Y * 1.464079972))
        
     } else if (dataSource == "Opta") {
        data <- data 
      }
    
    if (nrow(data) >= 1) {
      data <- data %>%
        mutate(xG = round(xG,2)) %>%
        mutate(isGoal = ifelse(result == "Goal", "Goal", "No Goal")) %>%
        mutate('Game_Period' = ifelse(minute < 16, "0 - 15",
                                      ifelse(minute < 31 & minute > 15, "16 - 30",
                                             ifelse(minute < 46 & minute > 30, "31 - 45",
                                                    ifelse(minute < 61 & minute > 45, "46 - 60",
                                                           ifelse(minute < 76 & minute > 60, "61 - 75",
                                                                  ifelse(minute < 91 & minute > 75, "76 - 90",
                                                                         ifelse(minute > 90, "90 +", "Extra Time"))))))))

              # set the pitch up
              plot <- data %>%
                ggplot() +
                annotate_pitch(dimensions = pitch_opta, colour = color_b, fill = fill_b) +
                theme_pitch() +
                geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                
                # add zone numbers
                geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE)
              
              # geometrics 
              if (average_location == TRUE || average_location == "") {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") { ## Don't highlight goals ----
                    plot  <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = "",
                      )
                  } else if (highlight_goals == TRUE) { ## Highlight goals ----
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, fill = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), color = color_b, shape = 21, alpha = 0.7, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") { ## DENSITY ----
                  plot <- plot +
                    stat_density_2d(data = data, aes(x = X, y = Y, fill = ..level..), geom = "polygon", alpha = 0.7) +
                    scale_fill_gradient(high = teamColor, low = "#01141D") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                    theme(legend.position = "none")
                  
                } else if (type == "hexbin") { ## HEXBIN ----
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                    labs(
                      fill = "Count of Shots"
                    )
                }
              } else if (average_location == FALSE) {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") {
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } else if (highlight_goals == TRUE) {
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, fill = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), color = color_b, shape = 21, alpha = 0.7, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") {
                  plot <- plot +
                    stat_density_2d(data = data, aes(x = X, y = Y, fill = ..level..), geom = "polygon", alpha = 0.7) +
                    scale_fill_gradient(high = teamColor, low = "#01141D") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(fill = "xG")
                  
                  
                } else if (type == "hexbin") {
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(
                      fill = "Count of Shots")
                } 
              }
              # Make Half pitch  
              plot <- plot +
                coord_flip(xlim = c(50, 100),
                           ylim = c(100, 0))
              # formatting  
              plot <- plot +
                labs(title = shot_map_name, 
                     subtitle = fixture_name,
                     caption = My_caption) +
                
                theme(legend.position = "none",
                      legend.direction = "horizontal",
                      legend.background = element_rect(fill = "snow"),
                      legend.title = element_text(colour = colorText, face = "bold"),
                      legend.text = element_text(colour = colorText, size = 10),
                      legend.key = element_rect(fill = "snow"),
                      plot.title = element_markdown(),
                      plot.caption = element_markdown(),
                      plot.background = element_rect(colour = "snow", fill = "snow"),
                      panel.background = element_rect(colour = "snow", fill = "snow"),
                      plot.subtitle = element_text(colour = colorText, hjust = 0, size = 10))
              
              # wrap or not
              if (wrap == "Player") {
                #divide stats by player
                player_stats <- data %>%
                  group_by(player) %>%
                  summarize(
                    total_xG = sum(xG),
                    total_goal = sum(result == "Goal"),
                    xg_sot = total_xG / n(),
                    total_shots = n(),
                    SOT = sum(result == "Goal" | result == "SavedShot")
                  )

                plot <- plot +
                  facet_wrap(~player) +
                  theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                        strip.text = element_text(size = 10, colour = text_color))
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                
                } else if (wrap == "Time") {
                  
                  #divide stats by time period
                  GPeriod_stats <- data %>%
                    group_by(Game_Period) %>%
                    summarize(
                      total_xG = sum(xG),
                      total_goal = sum(result == "Goal"),
                      xg_sot = total_xG / n(),
                      total_shots = n(),
                      SOT = sum(result == "Goal" | result == "SavedShot")
                    )
                  
                  
                    plot <- plot +
                      
                      facet_wrap(~ Game_Period) +
                      theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                            strip.text = element_text(size = 10, colour = text_color)) 
                    
                    plot <- plot +
                    geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                  
              } else if (wrap == "") {
                total_xG <- sum(data$xG)
                total_goal <- sum(data$result == "Goal")
                xg_sot <- total_xG / nrow(data)
                total_shots <- nrow(data)
                SOT <- sum(data$result == "Goal" | data$result == "SavedShot")
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 89.45, label = format(round(total_xG, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 89.45, label = "Total xG", color = colorText, size = 3) +
                  geom_point(x = 54, y = 71.05, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 71.05, label = format(round(SOT, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 71.05, label = "SOT", color = colorText, size = 3) +
                  geom_point(x = 54, y = 50, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 50, label = format(round(total_shots, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 50, label = "Total Shots", color = colorText, size = 3) +  
                  geom_point(x = 54, y = 28.95, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 28.95, label = format(round(xg_sot, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 28.95, label = "xG/Shot", color = colorText, size = 3) +
                  geom_point(x = 54, y = 10.55, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 10.55, label = format(round(total_goal, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 10.55, label = "Goals", color = colorText, size = 3)
              
                Finalplot <- plot
              }
              
              # logo or not
              if (logo == "Yes") {
                
                # annotate plot
                Finalplot <- ggdraw() +
                  draw_plot(plot, x = 0, y = 0, width = 1, height = , scale = 1) +
                  draw_image(logo_AI,  x = 0.42, y = 0.45, scale = 0.07) 
                
              } else if (logo == "") {
                
                Finalplot <- plot
              }
              
              return(Finalplot)
              
             } else 
               {
              ## add WARNING that there were no rows in the data frame passed into function??
              return(plot)
    }
    }
  }

```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: Pass network function
#' Function for plotting pass networks

plot_passnet_AI <- function(data, team_name, scale_stat = "EPV", 
                         scale_color = "firebrick2", text_color = "white", subtitle = "", plot_start = "00", plot_finish = "45", logo = "", pitch = "", wrap = "", pressmap = "", passes = "2") {
  
    # Checking data frame 
    
    if ((nrow(data) > 0) &&
        sum(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "player_shirt", "Successful_Passes") %in% names(data)) == 12) {
    } else {
      print(c("x", "y", "finalX", "finalY", "TeamName", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "player_shirt", "Successful_Passes"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
    
    # Generate error messages
    
    if (is.character(data$playerId) == FALSE) {
      stop("The playerId column is supposed to contain player names.")
    }
    
    if (is.character(data$TeamName) == FALSE) {
      stop("The TeamName column is supposed to contain team names.")
    }
  
    # full Pitch or half Pitch

    if  (pitch == "Half") { 
      data <- data %>%
        filter(x >= 50)
    
    }else if (pitch == "Full") {
      data <- data
    }
  # exclude set pieces and throw ins
  Pass_data <- data %>%
    filter(Attempted_Passes == 1)

      # Stat calculation
    
    if (scale_stat == "xT") {
      
      df <- Pass_data %>%
        calculate_threat(type = "opta")
      
      df <- df %>%
        mutate(xT = xTEnd - xTStart) %>%
        select(xT)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$xT
      
      leg_title <- "xT"
      
    } else if (scale_stat == "EPV") {
      
      df <- Pass_data %>%
        calculate_epv(type = "opta")
      
      df <- df %>%
        mutate(EPV = EPVEnd - EPVStart) %>%
        select(EPV)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$EPV
      
      leg_title <- "EPV"
      
    }
    
  # Calculate Pass percentage
  Pass_data <- Pass_data %>%
  replace_na(list(Attempted_Passes = 0, Successful_Passes = 0)) %>%
  mutate(stat = as.numeric(stat)) %>%
 replace_na(list(stat = 0))

  Pass_data <- Pass_data %>%
  mutate(Pass_Suc = if_else(Attempted_Passes > 0,
                                   Successful_Passes / Attempted_Passes, NA_real_))
  
  #set title text
    PassNetTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network</span>"))
  
  PassNetTitle_textD <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network & </span><span style='font-family:\"Arial\";color:gray12;font-size:14px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:14px;'>Unsuccessful</span><span style='color:gray12;font-size:14px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:14px;'>Successful</span><span style='color:gray12;font-size:14px;'>)</span>"))
  
    # wrap or not
    if (wrap == "Yes") {
      
      #calculate pressing date

if (pressmap == "Yes") {
  PressData <- data %>%
    filter(TeamName == team_name, Defensive_Action == 1)
}

plotCaption <- paste0(
  glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line = </span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
       <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span>"))

# ---- Data wrangling --------------------------------------------------------
data1 <- Pass_data %>%
  filter(TeamName == team_name) %>%
  filter(!is.na(playerId))

# If you still want the "receiver" column by next event within period:
data1 <- data1 %>%
  arrange(Game_Period, expandedMinute) %>%
  group_by(Game_Period) %>%
  mutate(receiver = dplyr::lead(playerId, n = 1)) %>%
  ungroup()

# ---- Nodes: player averages per period (DROP groups) -----------------------
nodes <- data1 %>% 
  group_by(playerId, player_shirt, Game_Period) %>% 
  summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# ---- Edgelist: successful passes per period ------------------
edgelist <- data1 %>%
  filter(Successful_Passes == 1) %>%
  select(from = playerId, to = receiver, Game_Period) %>%
  filter(!is.na(to)) %>%
  group_by(from, to, Game_Period) %>%
  summarise(n = dplyr::n(), .groups = "drop")

# ---- Coordinates for pass lines -----------------
coords <- nodes %>%
  ungroup() %>%
  select(playerId, Game_Period, x, y)

# Join coords for 'from' and 'to' WITH Game_Period
edges <- edgelist %>%
  left_join(coords, by = c("from" = "playerId", "Game_Period" = "Game_Period")) %>%
  left_join(coords, by = c("to"   = "playerId", "Game_Period" = "Game_Period"),
            suffix = c("", ".to")) %>%
  mutate(xend = x.to, yend = y.to)

# Collapse to undirected pairs *within period*, keep one geometry per pair
edges <- edges %>%
  mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  group_by(player1, player2, Game_Period) %>%
  summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"
  ) %>%
  filter(Total_Passes >= passes)

# ---- Final tidy on nodes ---------------------------------------------------
nodes <- nodes %>%
  arrange(Game_Period) %>%
  mutate(playerId = ifelse(grepl(" ", playerId), sub(".*\\s", "", playerId), playerId),
         playerId_short = if_else(grepl(" ", playerId),
                                         sub(".*\\s", "", playerId),
                                         playerId))

# Plot the passnetwork
      
      plot_passnet <- ggplot() +
        
        #setup the pitch
        annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
        theme_pitch() +
        annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
        
        #set scale and color gradient
        scale_colour_gradientn(
          colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        scale_size_continuous(range = c(0.5, 3)) +
        
        scale_fill_manual(values = c("#0000FF",  "red2"))
      
      if (pressmap == "Yes") {
        
        #plot pressing data
        plot_passnet <- plot_passnet +
          geom_point(data = PressData, aes(x = x, y = y, group = Game_Period, fill = outcome), shape = 21, size = 1, show.legend = FALSE)
        
      } else if (pressmap == "") {
        
        plot_passnet <- plot_passnet
      }
      
        #plot player connections
        plot_passnet <- plot_passnet +
          geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25)), colour = "black", alpha = 0.8, show.legend = FALSE) +

        #plot player positions
          new_scale_color() +
          new_scale_fill() +
          geom_point(data = nodes, aes(x, y, fill = stat), size = 3, shape = 21, colour = "black", stroke = 0.5) +

        #plot player Numbers
        geom_text(data = nodes, aes(x, y, label = player_shirt), colour = "black", size = 1) +
        
        # set scale and colors
        scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
        
        #formatting
          labs(title = PassNetTitle_text,
               subtitle = plotCaption,
             x = "",
             colour = leg_title,
             caption = My_caption) +
          
            theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            #axis.title.x = element_text(colour = "black", size = 6)
            axis.title.x = element_blank()) +

        #Wrap the plots
          facet_wrap(~Game_Period, ncol = 4) +
          theme(strip.text.x = element_text(face = "bold", size = 10, colour = text_color),
              strip.background.x = element_rect(fill = scale_color, color = "black", linetype = "solid", linewidth = 1))

    } else if (wrap == "") {
      
      #calculate pressing date
      
      if (pressmap == "Yes") {
        
        data <- data %>%
          filter(between(expandedMinute, plot_start, plot_finish))
        
        PressData <- data %>%
          filter(TeamName == team_name) 
        
        PressData <- PressData %>%
          filter(Defensive_Action == 1)

      } else if (pressmap == "") {
        
      }
      
      plotCaption <- paste0(
  glue("
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><br>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>Line = </span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span>
    <span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes, Larger Circle = More Passes</span>"))

#            plotCaption <- paste0(
#              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes, Larger Circle = More Passes</span>"))
            
            plotTag <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span"))
            
            plotExplaination <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Line =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Thicker Line = More Passes</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Darker Circle Colour = Higher Threat (EPV)</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;', Darker Line = Higher Pass Completion, Direction of Attack Right to Left</span>"))

# Data Wrangling 
      
# Team + valid IDs
data1 <- Pass_data %>%
  dplyr::filter(TeamName == team_name) %>%
  dplyr::filter(!is.na(playerId))

# Create Receiver data
  data1 <- data1 %>%
  mutate(receiver = dplyr::lead(playerId, n = 1))

# Restrict time window (ensure plot_start/finish are numeric)
data1 <- data1 %>%
  dplyr::filter(dplyr::between(expandedMinute, as.numeric(plot_start), as.numeric(plot_finish)))

# Nodes (per player)
nodes <- data1 %>%
  dplyr::group_by(playerId, player_shirt) %>%
  dplyr::summarise(
    x = mean(x, na.rm = TRUE),
    y = mean(y, na.rm = TRUE),
    events = dplyr::n(),
    stat   = sum(stat, na.rm = TRUE),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"
  )

# Edgelist (successful passes between players)
edgelist <- data1 %>%
  dplyr::filter(Successful_Passes == 1) %>%
  dplyr::select(from = playerId, to = receiver) %>%
  dplyr::group_by(from, to) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%  
  tidyr::drop_na()

# Join coordinates
coords <- nodes %>% dplyr::ungroup() %>% dplyr::select(playerId, x, y)

edges <- edgelist %>%
  dplyr::left_join(coords, by = c("from" = "playerId")) %>%
  dplyr::rename(x = x, y = y) %>%
  dplyr::left_join(coords, by = c("to"   = "playerId"), suffix = c("", ".to")) %>%
  dplyr::rename(xend = x.to, yend = y.to)

# Collapse to undirected pairs
edges <- edges %>%
  dplyr::mutate(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    Total_Passes = sum(n, na.rm = TRUE),
    x    = dplyr::first(x),
    y    = dplyr::first(y),
    xend = dplyr::first(xend),
    yend = dplyr::first(yend),
    .groups = "drop"                         
  ) %>%
  dplyr::filter(Total_Passes >= passes)

# Pass % per connection
PassStats <- data1 %>%
  dplyr::select(player1 = playerId, player2 = receiver,
                Successful_Passes, Attempted_Passes) %>%
  dplyr::group_by(player1, player2) %>%
  dplyr::summarise(
    n = dplyr::n(),
    Successful_Passes = sum(Successful_Passes, na.rm = TRUE),
    Attempted_Passes  = sum(Attempted_Passes,  na.rm = TRUE),
    .groups = "drop"                
  ) %>%
  tidyr::drop_na() %>%
  dplyr::mutate(Pass_Suc = dplyr::if_else(Attempted_Passes > 0,
                                          Successful_Passes / Attempted_Passes, NA_real_)) %>%
  tidyr::replace_na(list(Pass_Suc = 0))

edges <- edges %>%
  dplyr::left_join(PassStats %>% dplyr::select(player1, player2, Pass_Suc),
                   by = c("player1", "player2")) %>%
  tidyr::replace_na(list(Pass_Suc = 1))

# Final tidy on nodes
nodes <- nodes %>%
  dplyr::arrange(events) %>%
  dplyr::mutate(
    playerId_short = dplyr::if_else(grepl(" ", playerId),
                                    sub(".*\\s", "", playerId),
                                    playerId)
  )

      #set range for text to change on player circle
      EPVRange <- (max(nodes$stat)) * 0.7
      
      # Plot

    plot_passnet <- ggplot() +
      
      #setup the pitch
      annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
      theme_pitch() +
      annotate("segment", y = c(21.1, 36.8, 63.2, 78.9), yend = c(21.1, 36.8, 63.2, 78.9), x = 0, xend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      annotate("segment", x = c(17, 33.2, 50, 66.4, 83), xend = c(17, 33.2, 50, 66.4, 83), y = 0, yend = 100, linetype = "longdash", linewidth = 0.3, colour = "#95A5A6") +
      
      # add zone numbers
      geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
      
      #set scale and color gradient
      scale_fill_manual(values = c("#0000FF",  "red2"), labels = c("Won", "Lost"), name = "")

      
    if (pressmap == "Yes") {
      
      #plot pressing data
      plot_passnet <- plot_passnet +
        geom_point(data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1.5, stroke = 0.5, show.legend = FALSE)

    } else if (pressmap == "") {
     
      plot_passnet <- plot_passnet
      
    }
      
      #plot player connections
    plot_passnet <- plot_passnet +
      new_scale_fill() +
      
      geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, linewidth = (Total_Passes*0.25), colour = Pass_Suc)) +
      guides(linewidth = "none") +

      #plot player positions
      geom_point(data = nodes, aes(x, y, fill = stat, size = Attempted_Passes), shape = 21, colour = "black", stroke = 0.5) +
      
      # set colour
      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)),
        breaks = c(0, .25, .5, .75, 1),
        labels = scales::label_percent(accuracy = 1),
        name   = "Line Color = Passing Success") +
      
      scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 0.5)), 
        breaks = scales::breaks_width(0.1), 
        name = "Circle Colour = Threat (EPV)") +
      
      # set scale
      scale_size_continuous(range = c(2, 10),
                        name = "Attempted Passes",
        guide = "none")
      
      plot_passnet <- plot_passnet +
      new_scale_color() +
      
      #plot player Numbers
      geom_text(data = nodes,
          aes(x, y, label = player_shirt,
              color = stat > EPVRange,
              size = Successful_Passes/4),
          show.legend = FALSE) +
      
      # set scale    
      scale_color_manual(values = c("TRUE" = "white", "FALSE" = "black"), guide = "none") +
      
      #formatting
      labs(title = PassNetTitle_text,
           subtitle = plotCaption,
           #tag = plotTag,
           x = "",
           colour = leg_title,
           caption = My_caption) +
      theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.tag = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            #axis.title.x = element_text(colour = "black", size = 6)
            axis.title.x = element_blank())
    }
    
    # If half pitch
    
    if (pitch == "Half") {
      
      plot_passnet <- plot_passnet +
        coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
        labs(y = " ") +
        theme(axis.title.y = element_blank(),
              axis.title.x = element_blank())
      
    } else if (pitch == "Full") {
      
      plot_passnet <- plot_passnet
      
    }
    
    # Press or not formatting
    
    if (pressmap == "Yes") {
      
      plot_passnet <- plot_passnet +

        #formatting
        labs(title = PassNetTitle_textD,
             x = "",
             colour = leg_title)
      
    } else if (pressmap == "") {
      
      plot_passnet <- plot_passnet
    }

    # logo or not
  
    if (logo == "Yes") {
    
    # annotate plot
    Finalplot_passnet <- plot_passnet +
    annotation_custom(AI_Logo, xmin = 90, xmax = 100, ymin = 105, ymax = 115) +
      coord_cartesian(clip = "off") +
      theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    
    } else if (logo == "") {
      
      Finalplot_passnet <- plot_passnet +
        theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    }

  return(Finalplot_passnet)
  #return(list(plot = Finalplot_passnet, nodes = nodes, edges = edges))

}
```


``` {r}
#| label: Dashboard Setup
#| echo: false
#| output: false
#| warning: false

library(tidyverse)
library(shiny)
library(gifski)
library(magick)
library(systemfonts)
library(sysfonts)
library(fontawesome)
library(glue)
library(worldfootballR)
library(gganimate)
library(ggsoccer)
#library(viridis)
library(paletteer)
#library(RColorBrewer)
library(ggpointdensity)
library(ggthemes)
library(ggtext)
library(ggiraph)
#library(ggiraphExtra)
library(ggimage)
library(gt)
library(gtExtras)
library(grid)
library(ggdensity)
library(treemapify)
library(magick)
#library(ggpubr)
#library(cowplot)
library(readxl)
library(writexl)
#library(webshot2)
library(chromote)
library(ggrepel)
library(png)
library(patchwork)
library(plotly)
library(reshape)
library(psych)
library(ggshakeR)
#library(xtable)
library(tidyquant)
library(gfonts)
library(extrafont)
library(extrafontdb)
library(ggnewscale)
library(stringr)
library(ggh4x)
library(ggh4x)
library(ggforce)

#load logos
AI_Logo <- image_read("~/Documents/Dropbox files/AI LFC data/Icons/UP logo.png")
logo_AI <- image_read("~/Documents/Dropbox files/AI LFC data/Icons/UP logo.png")
Soccerball  <- image_read("~/Documents/Dropbox files/AI LFC data/Icons/ball1.png")
Football  <- image_read("~/Documents/Dropbox files/AI LFC data/Icons/ball2.png")


#load fonts
#set fonts
font_add("Awesome", regular = "/Library/Fonts/Font Awesome 7 Brands-Regular-400.otf")

#set viz location for camcorder
Vizlocation <- paste0("~/Documents/Dropbox files/AI LFC data/R files/AI UP/Scripts/Viz Pack/Season 2526/Specials/Oct International break")

#set oppo
Match_Away <- paste("All Oppo")

#set oppo color
Color_Away <- paste("blue4")

#set oppo text
Color_Away_Text <- paste("white")

#Set LFC
Match_Home <- paste("Liverpool")

#set Home color
Color_Home <- paste("red4")

#set home text color
Color_Home_Text <- paste("white")

#set home color scale
ColorScale_Away <- paste("ggsci::blue_material")

#set away color scale
ColorScale_Home <- paste("ggsci::red_material")

#set home color scale con
ColorScale_AwayC <- paste("ggthemes::Classic Blue")

#set away color scale con
ColorScale_HomeC <- paste("ggthemes::Classic Red")

#set match date
Game_date1 <- paste("17-08-2025 to 06-10-2025")
Game_date2 <- paste("07-10-2025 to 22-05-2026")

#set data type (EPL opta and Understat, CL opta, Fa cup Opta)
Data_type <- paste("(Opta data)")

#set Home h/a
HomeHA <- paste("Home")

#set Away h/a
AwayHA <- paste("Away") 

# set home and away teams
Away_T = Match_Away
Home_T = Match_Home

#set home and away colors
Away_Color = Color_Away
Home_Color = Color_Home

#set fixture
Match_Fixture <- paste0(Match_Home, " vs ", Match_Away)

#set Game name
GameName <- paste("AllComp_LFC_Games_2526")

#set league points
League_Points <- 18
AFC_League_Points <- 17 
MC_League_Points <- 17

#set Waves titles
WavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

AwayWavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

#set xg line titles 
xGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

AwayxGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

#set dribbles title
DribblesTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Dribbles (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set duels title
DuelsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set PPs title
PPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

AwayPPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))


##new socials
social_caption <- function(twitter="@Barts78",
                           github = "Barts78",
                           linkedin= "Phil-barter",
                           mastodon= "@DrBarts",
                           threads = "Barts78",
                           data = "OPTA",
                           icon_color="black",
                           font_color="#454545",
                           bg_color="snow",
                           font_family="sans-serif"){
  
  icons = list(
    twitter = "&#xe61a",
    github = "&#xf09b",
    linkedin = "&#xf08c",
    mastodon = "&#xf4f6",
    threads = "&#xe618",
    data = "&#xf16b"
  )   
  
  social = list(threads = threads, linkedin = linkedin, twitter = twitter, mastodon = mastodon, github = github, data = data)
  social = social[!is.na(social)]
  
  caption = ""
  for (name in names(social)) {
    icon = icons[name]
    info = social[name]
    html = glue("<span style='font-family:\"Font Awesome 7 Brands\";color:{icon_color};font-size:8px;'>{icon};</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>
                <span style='font-family:{font_family};color:{font_color};font-size:8px;'>{info}</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>")
    
    
    caption = paste0(caption,html)
  }
  
  caption
}

#create social caption
my_socials <- social_caption(twitter = "@Barts78",
                             github = "Barts78",
                             linkedin = "Phil-barter",
                             mastodon = "@DrBarts",
                             threads = NA,
                             data = "OPTA",
                             icon_color = "#454545",
                             font_color = "#454545",
                             bg_color = "snow",
                             font_family = "sans-serif")

my_datasource <- paste0('<span style="font-family:\'Font Awesome 7 Free\', Arial, sans-serif;color:#454545;font-size:8px;">&#x1F4BE;</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>',
                        '<span style="font-family:sans-serif;color:#454545;font-size:8px;">OPTA</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>')

My_caption <- paste0(my_socials)
```

```{r}
#| output: false
#| warning: false
#load in data frames

fileName <- paste0("~/Documents/Dropbox files/AI LFC data/Data Sets/WhoScored/Databases/", GameName, ".xlsx")
plottingData <- read_xlsx(fileName)

#set summary values
Total_EPV <- sum(plottingData$Cumalative_EPV)
GameTime <- max(plottingData$expandedMinute)
OutofPlayTime <- round(sum(plottingData$Out_of_play_time)/60,2)
InPlayTime <- round(sum(plottingData$In_play_time)/60,2)
Possession <- round(sum(plottingData$Touches),2)
HomePossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName == Match_Home))/Possession)*100),2)
AwayPossession <- round((((sum(plottingData$Touches == 1 & plottingData$TeamName != Match_Home))/Possession)*100),2)
HomeEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPV <- round(sum(plottingData$EPVvalue[plottingData$TeamName != Match_Home & plottingData$`outcomeType/value` == 1]),2)
HomeEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPVA <- round(sum(plottingData$TeamEPV[plottingData$TeamName != Match_Home & plottingData$`outcomeType/value` == 1]),2)
HomexG <- round(sum(plottingData$xG[plottingData$TeamName == Match_Home]),2)
AwayxG <- round(sum(plottingData$xG[plottingData$TeamName != Match_Home]),2)
HomeNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName == Match_Home]),2)
AwayNPxG <- round(sum(plottingData$NPxG[plottingData$TeamName != Match_Home]),2)
HomeBCs <- round(sum(plottingData$BCs[plottingData$TeamName == Match_Home]),0)
AwayBCs <- round(sum(plottingData$BCs[plottingData$TeamName != Match_Home]),0)
Final_Third_Possession <- round(sum(plottingData$Final_Third_Touches),2)
HomeFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName == Match_Home))/Final_Third_Possession)*100),2)
AwayFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$TeamName != Match_Home))/Final_Third_Possession)*100),2)
HomeDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName == Match_Home]),0)
AwayDActions <- round(sum(plottingData$Defensive_Action[plottingData$TeamName != Match_Home]),0)
HomePasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName == Match_Home]),0)
AwayPasses <- round(sum(plottingData$Attempted_Passes[plottingData$TeamName != Match_Home]),0)
HomePPDA <- round(sum(AwayPasses/HomeDActions),2)
AwayPPDA <- round(sum(HomePasses/AwayDActions),2)
HomeProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName == Match_Home]),2)
AwayProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$TeamName != Match_Home]),2)
HomeCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName == Match_Home]),2)
HomeProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName == Match_Home]),2)
AwayCarries <- round(sum(plottingData$Successful_Carries[plottingData$TeamName != Match_Home]),2)
AwayProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$TeamName != Match_Home]),2)
HomeGoals <- round(sum(plottingData$Home_Goals),0)
HomeSOT <- round(sum(plottingData$OTShots[plottingData$TeamName == Match_Home]),0)
HomeShootingP <- round(sum(HomeGoals/HomeSOT), 2)
AwayGoals <- round(sum(plottingData$Away_Goals),0)
AwaySOT <- round(sum(plottingData$OTShots[plottingData$Team_Group == Match_Away]),0)
AwayShootingP <- round(sum(AwayGoals/AwaySOT), 2)
HomePPDO <- round(sum(HomeShootingP + (1 - AwayShootingP))*1000, 0)
AwayPPDO <- round(sum(AwayShootingP + (1 - HomeShootingP))*1000, 0)

#prepare first sub time data (min before sub) 
firstSubHome <- plottingData %>%
  filter(TeamName == Match_Home, SubTime != 0) %>%
  summarise(firstsubhome = min(SubTime)) %>%
  pull(firstsubhome)

firstSubAway <- plottingData %>%
  filter(TeamName == Match_Away, SubTime != 0) %>%
  summarise(firstsubaway = min(SubTime)) %>%
  pull(firstsubaway)

# set-up data frame from main variables above for summary tables
PossessionTable <- data.frame(
  TeamName = c(Match_Home, Match_Away),
  Possession = c(HomePossession, AwayPossession))

PossessionTable <- PossessionTable %>%
  mutate(Possession = round(Possession,2))
          
EPVTable <- data.frame(
  TeamName = c(Match_Home, Match_Away),
  EPV = c(HomeEPV, AwayEPV)
)

EPVTable <- EPVTable %>%
  mutate(EPV = round(EPV,2))

FieldTiltTable <- data.frame(
  TeamName = c(Match_Home, Match_Away),
 Field_Tilt = c(HomeFieldTilt, AwayFieldTilt))

FieldTiltTable <- FieldTiltTable %>%
  mutate(Field_Tilt = round(Field_Tilt,2))

PPDOTable <- data.frame(TeamName = c(Match_Home, Match_Away),
                         PPDO = c(HomePPDO, AwayPPDO))
#set game block dates
plottingData <- plottingData %>%
  #mutate(Game_date = as.Date(Game_date, format = "%d-%m-%y")) %>%
  mutate(Game_Block = case_when(
    Game_date >= as.Date("01-08-2025", format = "%d-%m-%Y") & Game_date <= as.Date("31-08-2025", format = "%d-%m-%Y") ~ 1,
    Game_date >= as.Date("01-09-2025", format = "%d-%m-%Y") & Game_date <= as.Date("31-10-2025", format = "%d-%m-%Y") ~ 2,

    TRUE ~ NA_integer_
  ))

#add all oppo tag
plottingData <- plottingData %>%
  mutate(Team_Group = ifelse(TeamName == Match_Home, Match_Home, Match_Away))

plottingDataB1 <- plottingData %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

plottingDataB2 <- plottingData %>%
  filter(Game_State == "Draw")

plottingDataB3 <- plottingData %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")


```



# Season Summary
``` {r}
#| output: false
#| label: summary table setup
#posession and goals by team
MatchSummarySeasonData <- compute_season_summary(plottingData, group_vars = c("Team_Group")) 

MatchSummarySeasonData <- MatchSummarySeasonData %>%
  select('Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonHalfData <- compute_season_summary(plottingData %>% mutate(Half = case_when(
  period == 1 ~ "First Half",
  period == 2 ~ "Second Half",
  period == 3 ~ "First Half Extra Time",
  period == 4 ~ "Second Half Extra Time",
  TRUE ~ "Injury Time")
), group_vars = c("Half", "Team_Group"))

MatchSummarySeasonHalfData <- MatchSummarySeasonHalfData %>%
  select(Half, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonPeriodData <- compute_season_summary(plottingData, group_vars = c("Game_Period", "Team_Group"))

MatchSummarySeasonPeriodData <- MatchSummarySeasonPeriodData %>%
  select(Game_Period, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummarySeasonGameStateData <- compute_season_summary(plottingData, group_vars = c("Game_State", "Team_Group"))

MatchSummarySeasonGameStateData <- MatchSummarySeasonGameStateData %>%
  select(Game_State, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryData <- compute_summary(plottingData, group_vars = c("Team_Group")) 

MatchSummaryData <- MatchSummaryData %>%
  select('Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryHalfData <- compute_summary(plottingData %>% mutate(Half = case_when(
  period == 1 ~ "First Half",
  period == 2 ~ "Second Half",
  period == 3 ~ "First Half Extra Time",
  period == 4 ~ "Second Half Extra Time",
  TRUE ~ "Injury Time")
), group_vars = c("Half", "Team_Group"))

MatchSummaryHalfData <- MatchSummaryHalfData %>%
  select(Half, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryPeriodData <- compute_summary(plottingData, group_vars = c("Game_Period", "Team_Group"))

MatchSummaryPeriodData <- MatchSummaryPeriodData %>%
  select(Game_Period, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryGameStateData <- compute_summary(plottingData, group_vars = c("Game_State", "Team_Group"))

MatchSummaryGameStateData <- MatchSummaryGameStateData %>%
  select(Game_State, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

MatchSummaryGameNameData <- compute_summary(plottingData, group_vars = c("game_name", "Team_Group"))

MatchSummaryGameNameData <- MatchSummaryGameNameData %>%
  select('Fixture' = game_name, Match_day, 'Team' = Team_Group, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % xG Con.', 'Attempted Passes' = Attempted_Passes,  'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Long Passes' = Long_Passes, 'Long Ball Rate' = Long_Pass_Rate,  'Crosses' = Cross_Passes, 'Cross Success %' = Cross_Success, Corners, 'Short Corners' = Short_Corners, 'Possession Control' = Posession_Control, 'EPV % NPxG Con.')

```
## Row {.flow}
### row {.tabset}
```{r}
#| results: asis
#| fig-height: 10
#| title: Summary tables - Average
#| label: Summary tables a
MatchSummarySeasonTable <- MatchSummarySeasonData %>%
  gt(groupname_col = "Team") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - Full Games**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(3, 14:17),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(2, 6, 19, 22, 24, 26, 30),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = Match_Away)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = Match_Home)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "#B22222",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 
MatchSummarySeasonTable
```

```{r}
#| results: asis
#| fig-height: 10
#| title: Summary tables - Totals
#| label: Summary tables t
MatchSummaryTable <- MatchSummaryData %>%
  gt(groupname_col = "Team") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - Full Games**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(3, 14:17),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(2, 6, 19, 22, 24, 26, 30),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = Match_Away)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = Match_Home)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "#B22222",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 
MatchSummaryTable
```
## Row {.flow}
### Row {.tabset}
```{r}
#| results: asis
#| fig-height: 10
#| title: Match Summary by Half - Averages
MatchSummarySeasonHalfsTable <- MatchSummarySeasonHalfData %>%
  gt(rowname_col = "Team", groupname_col = "Half") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Half**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryHalfData$Half)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryHalfData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryHalfData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonHalfsTable
```

```{r}
#| results: asis
#| fig-height: 10
#| title: Match Summary by Half - Totals
MatchSummaryHalfsTable <- MatchSummaryHalfData %>%
  gt(rowname_col = "Team", groupname_col = "Half") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Half**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryHalfData$Half)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryHalfData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryHalfData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryHalfsTable
```
## Row {.flow}
### row {.tabset}
``` {r}  
#| results: asis
#| fig-height: 10
#| label: Match summary by time period - a
#| title: Match summary by time period - Averages
#possession and goals by time period
MatchSummarySeasonPeriodTable <- MatchSummarySeasonPeriodData %>%
  gt(rowname_col = "Team", groupname_col = "Game_Period") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game Period**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryPeriodData$Game_Period)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryPeriodData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryPeriodData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonPeriodTable
```

``` {r}  
#| results: asis
#| fig-height: 10
#| label: Match summary by time period t
#| title: Match summary by time period - Totals
#possession and goals by time period
MatchSummaryPeriodTable <- MatchSummaryPeriodData %>%
  gt(rowname_col = "Team", groupname_col = "Game_Period") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game Period**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryPeriodData$Game_Period)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryPeriodData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryPeriodData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryPeriodTable
```

## Row {.flow}
### row {.tabset}
``` {r}  
#| results: asis
#| title: Match Summary by Game State - Averages

#possession and goals by time period
MatchSummarySeasonGameStateTable <- MatchSummarySeasonGameStateData %>%
  gt(rowname_col = "Team", groupname_col = "Game_State") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game State**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(5, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryGameStateData$Game_State)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameStateData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameStateData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummarySeasonGameStateTable
```

``` {r}  
#| results: asis
#| title: Match Summary by Game State - Totals

MatchSummaryGameStateTable <- MatchSummaryGameStateData %>%
  gt(rowname_col = "Team", groupname_col = "Game_State") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Game State**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(5, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 23, 25, 27, 31),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_row_groups(groups = unique(MatchSummaryGameStateData$Game_State)),
    style = cell_text(weight = "bold", size = 16, color = "white")
  ) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameStateData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameStateData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryGameStateTable
```
## Row {.flow}
``` {r}  
#| results: asis
#| label: Match sumary by game

MatchSummaryGameNameData <- MatchSummaryGameNameData %>%
  mutate(Match_day = as.numeric(Match_day)) %>%
  filter(!Match_day == 0) %>%
  arrange(Match_day)
  
  MatchSummaryGameNameTable <- MatchSummaryGameNameData %>%
  gt(rowname_col = "Team", groupname_col = "Match_day") %>%
  cols_hide('On Ball Time') %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Season Summary - By Match Day**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(6, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(4, 8, 21, 24, 26, 28, 32),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:22)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  #tab_style(
  #  locations = cells_row_groups(groups = unique(MatchSummaryGameNameData$Match_day)),
  #  style = cell_text(weight = "bold", size = 16, color = "white")
  #) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameNameData$Team == Away_T)),
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text))) %>%
  tab_style(
    locations = cells_stub(rows = c(MatchSummaryGameNameData$Team == Home_T)),
    style = list(cell_fill(color = Color_Home),
                cell_text(size = 16,  weight = "bold", color = Color_Home_Text))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryGameNameTable
```

```{r}
#| output: false
#| label: Match MC setup
#Load data
dashboard_data <- plottingData

#Dashboard data wrangling all data
dashboard_data <- dashboard_data %>%
  filter(Team_Group == Match_Home) %>%
      filter(period != 5) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, expandedMinute, type, period, Game_Block, Game_State, Match_day)

#Oppo dashboard

Oppodashboard_data <- plottingData

Oppodashboard_data <- Oppodashboard_data %>%
  filter(Team_Group == Match_Away) %>%
      filter(period != 5) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, expandedMinute, type, period, Game_Block, Game_State, Match_day)

WinDashboard_data <- dashboard_data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead") %>%
    filter(!period == 5) %>%
  filter(!Match_day == 0)
  

DrawDashboard_data <- dashboard_data %>%
  filter(Game_State == "Draw") %>%
    filter(period != 5) %>%
  filter(!Match_day == 0)

GTimeDashboard_data <- dashboard_data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time") %>%
    filter(period != 5) %>%
  filter(!Match_day == 0)

WinOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead") %>%
    filter(period != 5) %>%
  filter(!Match_day == 0)

DrawOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Draw") %>%
    filter(period != 5) %>%
  filter(!Match_day == 0)

GTimeOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time") %>%
    filter(period != 5) %>%
  filter(!Match_day == 0)


HomexGMC <- HomeShots <- dashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- Oppodashboard_data %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(dashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(Oppodashboard_data$type == "Goal", 1, NA)))
```

```{r}


# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMC$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMC$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrix <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrix <- as.data.frame(as.table(prob_matrix))
colnames(long_prob_matrix) <- c("Home", "Away", "Probability")

long_prob_matrix <- long_prob_matrix %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false
#| label: Match probablity calculations

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrix[upper.tri(prob_matrix)])*100)
Home_wins_prob <- (sum(prob_matrix[lower.tri(prob_matrix)])*100)
tie_prob <- (sum(diag(prob_matrix))*100)

# Create a data frame for bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability,2))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#calculate match actual goals
#Matchday MC
HomexGMC <- HomeShots <- dashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- Oppodashboard_data %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(dashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(Oppodashboard_data$type == "Goal", 1, NA)))


#run MC for Match outcomes and Match Score proablity
sim_results <- simulate_match_outcomes(home_xg_vector = HomexGMC, away_xg_vector = AwayxGMC, seed = 1111, runs = 10000, actual_home_goals = HomeTotalGoals, actual_away_goals = AwayTotalGoals)

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(sim_results$prob_matrix[upper.tri(sim_results$prob_matrix)])*100)
Home_wins_prob <- (sum(sim_results$prob_matrix[lower.tri(sim_results$prob_matrix)])*100)
tie_prob <- (sum(diag(sim_results$prob_matrix))*100)

# Create a data frame for Match outcome bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability, 2))

#create data frame for Match score tile plot
long_prob_matrix <- sim_results$long_prob_matrix

#redo factor to numeric the score probablity
long_prob_matrix <- long_prob_matrix %>%
  mutate(Home = as.numeric(as.character(Home)),
         Away = as.numeric(as.character(Away)))


# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```


```{r}
#Matchday MC
HomexGMCB1 <- HomeShots <- WinDashboard_data %>%

  select(xG)
AwayxGMCB1 <- AwayShots <- WinOppoDashboard_data %>%

  select(xG)

HomeTotalGoals <- sum(!is.na(ifelse(WinDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(WinOppoDashboard_data$type == "Goal", 1, NA)))

# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrixB1 <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrixB1 <- as.data.frame(as.table(prob_matrixB1))
colnames(long_prob_matrixB1) <- c("Home", "Away", "Probability")

long_prob_matrixB1 <- long_prob_matrixB1 %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false
#| label: Match probablity calculations block 1

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrixB1[upper.tri(prob_matrixB1)])*100)
Home_wins_prob <- (sum(prob_matrixB1[lower.tri(prob_matrixB1)])*100)
tie_prob <- (sum(diag(prob_matrixB1))*100)

# Create a data frame for bar chart
outcome_probB1 <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_probB1 <- outcome_probB1 %>%
  mutate(Probability = round(Probability,2))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

## Column {.flow}
## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```

```{r}
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black", size = 4) + 
  labs(title = "Probabilities of Match Outcome (1000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#MD_MC_Result_Plot
```


```{r}
#| label: Match Result Probablity Plot
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot

#save Plot
ggsave(path = Vizlocation, "Match Result Probablity Plot.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


``` {r}
#| output: false
#MC Season calculations for top three
#load data

LFCShotsALL <- dashboard_data

OppoShotsALL <- Oppodashboard_data

OppoShotsB1 <- OppoShotsALL 

LFCShotsB1 <- LFCShotsALL 

#set total goals for and against
TotalGoals <- sum(!is.na(ifelse(LFCShotsALL$result == "Goal", 1, NA)))
TotalGA <- sum(!is.na(ifelse(OppoShotsALL$result == "Goal", 1, NA)))
TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsALL$result == "OwnGoal", 1, NA)))
TotalGA_OG <- sum(!is.na(ifelse(OppoShotsALL$result == "OwnGoal", 1, NA)))

B1TotalGoals <- sum(!is.na(ifelse(LFCShotsB1$result == "Goal", 1, NA)))
B1TotalGA <- sum(!is.na(ifelse(OppoShotsB1$result == "Goal", 1, NA)))
B1TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsB1$result == "OwnGoal", 1, NA)))
B1TotalGA_OG <- sum(!is.na(ifelse(OppoShotsB1$result == "OwnGoal", 1, NA)))



#set final goal total

Season_G <- sum(TotalGoals + TotalGA_OG)
Season_GA <- sum(TotalGA + TotalGoals_OG)

B1_G <- sum(B1TotalGoals + B1TotalGA_OG)
B1_GA <- sum(B1TotalGA + B1TotalGoals_OG)



#filter for just xg and xga
OppoShotsSeason <- OppoShotsALL %>%
  select(xGA = xG)

LFCShotsSeason <- LFCShotsALL %>%
  select(xG)

OppoB1Shots <- OppoShotsB1 %>%
  select(xGA = xG)

LFCB1Shots <- LFCShotsB1 %>%
  select(xG)


color_mapping <- c("xG" = Color_Home, "xGA" = Color_Away) 


MC_Title_text <- paste0(
            glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Liverpool Expected Goals </span>
                 <span style='color:gray12;font-size:16px;'>(</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>For</span>
                 <span style='font-family:\"Arial\";color:gray12;font-size:16px;'>and</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Against</span>
                 <span style='color:gray12;font-size:16px;'>)</span>"))

#Season MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoShotsSeason$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- Season_GA # set number of goals you want proportion for

number_goals <- sum(SeasonxGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxGA_output >= goals) # at least that many goals

table(SeasonxGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCShotsSeason$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- Season_G # set number of goals you want proportion for

number_goals <- sum(SeasonxG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxG_output >= goals) # at least that many goals

table(SeasonxG_output)

# create data frame from the MC output, so converting vector into data frame
SeasonMC_Output <- data.frame(SeasonxGA_output, SeasonxG_output)



#Block 1 MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoB1Shots$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- B1_GA # set number of goals you want proportion for

number_goals <- sum(B1xGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xGA_output >= goals) # at least that many goals

table(B1xGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCB1Shots$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- B1_G # set number of goals you want proportion for

number_goals <- sum(B1xG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xG_output >= goals) # at least that many goals

table(B1xG_output)

# create data frame from the MC output, so converting vector into data frame
B1MC_Output <- data.frame(B1xGA_output, B1xG_output)

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
x <- c(SeasonxG_output, SeasonxGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_SeasonxG <- data.frame(x, group = group)


x <- c(B1xG_output, B1xGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_B1xG <- data.frame(x, group = group)

B1_Histogram_xG <- df_B1xG %>%
  ggplot(aes(x = x, fill = group, color = group)) + 
  geom_histogram(
    binwidth = 1, 
    alpha = 0.5, 
    position = "identity") +
  scale_x_continuous(breaks = seq(0, max(x), 4)) +
  
  #formatting
  scale_fill_manual(values = color_mapping) +
  scale_color_manual(values = color_mapping) +
  labs(title = paste(MC_Title_text),
       subtitle = paste("1000 sims"),
       x="Goals",
       y="Count", 
       caption = My_caption) +
    theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        panel.grid.major.y = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

B1_Histogram_xG

```


```{r}
#Matchday MC
HomexGMCB1 <- HomeShots <- WinDashboard_data %>%

  select(xG)
AwayxGMCB1 <- AwayShots <- WinOppoDashboard_data %>%

  select(xG)

HomeTotalGoals <- sum(!is.na(ifelse(WinDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(WinOppoDashboard_data$type == "Goal", 1, NA)))

# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrixB1 <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrixB1 <- as.data.frame(as.table(prob_matrixB1))
colnames(long_prob_matrixB1) <- c("Home", "Away", "Probability")

long_prob_matrixB1 <- long_prob_matrixB1 %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrixB1[upper.tri(prob_matrixB1)])*100)
Home_wins_prob <- (sum(prob_matrixB1[lower.tri(prob_matrixB1)])*100)
tie_prob <- (sum(diag(prob_matrixB1))*100)

# Create a data frame for bar chart
outcome_probB1 <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_probB1 <- outcome_probB1 %>%
  mutate(Probability = round(Probability,2))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```

```{r}
#calculate match actual goals
#Matchday MC
HomexGMC <- HomeShots <- WinDashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- WinOppoDashboard_data %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(WinDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(WinOppoDashboard_data$type == "Goal", 1, NA)))


#run MC for Match outcomes and Match Score proablity
sim_results <- simulate_match_outcomes(home_xg_vector = HomexGMC, away_xg_vector = AwayxGMC, seed = 1111, runs = 10000, actual_home_goals = HomeTotalGoals, actual_away_goals = AwayTotalGoals)

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(sim_results$prob_matrix[upper.tri(sim_results$prob_matrix)])*100)
Home_wins_prob <- (sum(sim_results$prob_matrix[lower.tri(sim_results$prob_matrix)])*100)
tie_prob <- (sum(diag(sim_results$prob_matrix))*100)

# Create a data frame for Match outcome bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability, 2))

#create data frame for Match score tile plot
long_prob_matrix <- sim_results$long_prob_matrix

#redo factor to numeric the score probablity
long_prob_matrix <- long_prob_matrix %>%
  mutate(Home = as.numeric(as.character(Home)),
         Away = as.numeric(as.character(Away)))


# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#| label: Match Result Probablity Plot win
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot

```


```{r}
MD_MC_Result_PlotB1 <- ggplot(outcome_probB1) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
  labs(title = "Probabilities of Match Outcome (1000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#MD_MC_Result_PlotB1

```

``` {r}
#| output: false
#MC Season calculations for top three
#load data

LFCShotsALL <- WinDashboard_data

OppoShotsALL <- WinOppoDashboard_data

OppoShotsB1 <- OppoShotsALL 

LFCShotsB1 <- LFCShotsALL 


#set total goals for and against
TotalGoals <- sum(!is.na(ifelse(LFCShotsALL$result == "Goal", 1, NA)))
TotalGA <- sum(!is.na(ifelse(OppoShotsALL$result == "Goal", 1, NA)))
TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsALL$result == "OwnGoal", 1, NA)))
TotalGA_OG <- sum(!is.na(ifelse(OppoShotsALL$result == "OwnGoal", 1, NA)))

B1TotalGoals <- sum(!is.na(ifelse(LFCShotsB1$result == "Goal", 1, NA)))
B1TotalGA <- sum(!is.na(ifelse(OppoShotsB1$result == "Goal", 1, NA)))
B1TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsB1$result == "OwnGoal", 1, NA)))
B1TotalGA_OG <- sum(!is.na(ifelse(OppoShotsB1$result == "OwnGoal", 1, NA)))



#set final goal total

Season_G <- sum(TotalGoals + TotalGA_OG)
Season_GA <- sum(TotalGA + TotalGoals_OG)

B1_G <- sum(B1TotalGoals + B1TotalGA_OG)
B1_GA <- sum(B1TotalGA + B1TotalGoals_OG)



#filter for just xg and xga
OppoShotsSeason <- OppoShotsALL %>%
  select(xGA = xG)

LFCShotsSeason <- LFCShotsALL %>%
  select(xG)

OppoB1Shots <- OppoShotsB1 %>%
  select(xGA = xG)

LFCB1Shots <- LFCShotsB1 %>%
  select(xG)


color_mapping <- c("xG" = Color_Home, "xGA" = Color_Away) 


MC_Title_text <- paste0(
            glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Liverpool Expected Goals </span>
                 <span style='color:gray12;font-size:16px;'>(</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>For</span>
                 <span style='font-family:\"Arial\";color:gray12;font-size:16px;'>and</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Against</span>
                 <span style='color:gray12;font-size:16px;'>)</span>"))

#Season MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoShotsSeason$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- Season_GA # set number of goals you want proportion for

number_goals <- sum(SeasonxGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxGA_output >= goals) # at least that many goals

table(SeasonxGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCShotsSeason$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- Season_G # set number of goals you want proportion for

number_goals <- sum(SeasonxG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxG_output >= goals) # at least that many goals

table(SeasonxG_output)

# create data frame from the MC output, so converting vector into data frame
SeasonMC_Output <- data.frame(SeasonxGA_output, SeasonxG_output)



#Block 1 MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoB1Shots$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- B1_GA # set number of goals you want proportion for

number_goals <- sum(B1xGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xGA_output >= goals) # at least that many goals

table(B1xGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCB1Shots$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- B1_G # set number of goals you want proportion for

number_goals <- sum(B1xG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xG_output >= goals) # at least that many goals

table(B1xG_output)

# create data frame from the MC output, so converting vector into data frame
B1MC_Output <- data.frame(B1xGA_output, B1xG_output)

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
x <- c(SeasonxG_output, SeasonxGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_SeasonxG <- data.frame(x, group = group)


x <- c(B1xG_output, B1xGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_B1xG <- data.frame(x, group = group)

B1_Histogram_xG <- df_B1xG %>%
  ggplot(aes(x = x, fill = group, color = group)) + 
  geom_histogram(
    binwidth = 1, 
    alpha = 0.5, 
    position = "identity") +
  scale_x_continuous(breaks = seq(0, max(x), 2)) +
  
  #formatting
  scale_fill_manual(values = color_mapping) +
  scale_color_manual(values = color_mapping) +
  labs(title = paste(MC_Title_text),
       subtitle = paste("1000 sims"),
       x="Goals",
       y="Count", 
       caption = My_caption) +
 theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
    plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        panel.grid.major.y = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

B1_Histogram_xG

```


## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )
```

```{r}
#Matchday MC
HomexGMCB1 <- HomeShots <- DrawDashboard_data %>%
  select(xG)
AwayxGMCB1 <- AwayShots <- DrawOppoDashboard_data %>%
  select(xG)

HomeTotalGoals <- sum(!is.na(ifelse(DrawDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(DrawOppoDashboard_data$type == "Goal", 1, NA)))

# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrixB1 <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrixB1 <- as.data.frame(as.table(prob_matrixB1))
colnames(long_prob_matrixB1) <- c("Home", "Away", "Probability")

long_prob_matrixB1 <- long_prob_matrixB1 %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false


# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrixB1[upper.tri(prob_matrixB1)])*100)
Home_wins_prob <- (sum(prob_matrixB1[lower.tri(prob_matrixB1)])*100)
tie_prob <- (sum(diag(prob_matrixB1))*100)

# Create a data frame for bar chart
outcome_probB1 <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_probB1 <- outcome_probB1 %>%
  mutate(Probability = round(Probability,2))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#calculate match actual goals
#Matchday MC
HomexGMC <- HomeShots <- DrawDashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- DrawOppoDashboard_data %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(DrawDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(DrawOppoDashboard_data$type == "Goal", 1, NA)))


#run MC for Match outcomes and Match Score proablity
sim_results <- simulate_match_outcomes(home_xg_vector = HomexGMC, away_xg_vector = AwayxGMC, seed = 1111, runs = 10000, actual_home_goals = HomeTotalGoals, actual_away_goals = AwayTotalGoals)

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(sim_results$prob_matrix[upper.tri(sim_results$prob_matrix)])*100)
Home_wins_prob <- (sum(sim_results$prob_matrix[lower.tri(sim_results$prob_matrix)])*100)
tie_prob <- (sum(diag(sim_results$prob_matrix))*100)

# Create a data frame for Match outcome bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability, 2))

#create data frame for Match score tile plot
long_prob_matrix <- sim_results$long_prob_matrix

#redo factor to numeric the score probablity
long_prob_matrix <- long_prob_matrix %>%
  mutate(Home = as.numeric(as.character(Home)),
         Away = as.numeric(as.character(Away)))


# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#| label: Match Result Probablity Plot draw
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot

```



```{r}
MD_MC_Result_PlotB1 <- ggplot(outcome_probB1) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (1000 Sims)",
       subtitle = "",
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#MD_MC_Result_PlotB1

```

``` {r}
#| output: false
#MC Season calculations for top three
#load data

LFCShotsALL <- DrawDashboard_data

OppoShotsALL <- DrawOppoDashboard_data

OppoShotsB1 <- OppoShotsALL 

LFCShotsB1 <- LFCShotsALL 

#set total goals for and against
TotalGoals <- sum(!is.na(ifelse(LFCShotsALL$result == "Goal", 1, NA)))
TotalGA <- sum(!is.na(ifelse(OppoShotsALL$result == "Goal", 1, NA)))
TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsALL$result == "OwnGoal", 1, NA)))
TotalGA_OG <- sum(!is.na(ifelse(OppoShotsALL$result == "OwnGoal", 1, NA)))

B1TotalGoals <- sum(!is.na(ifelse(LFCShotsB1$result == "Goal", 1, NA)))
B1TotalGA <- sum(!is.na(ifelse(OppoShotsB1$result == "Goal", 1, NA)))
B1TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsB1$result == "OwnGoal", 1, NA)))
B1TotalGA_OG <- sum(!is.na(ifelse(OppoShotsB1$result == "OwnGoal", 1, NA)))



#set final goal total

Season_G <- sum(TotalGoals + TotalGA_OG)
Season_GA <- sum(TotalGA + TotalGoals_OG)

B1_G <- sum(B1TotalGoals + B1TotalGA_OG)
B1_GA <- sum(B1TotalGA + B1TotalGoals_OG)



#filter for just xg and xga
OppoShotsSeason <- OppoShotsALL %>%
  select(xGA = xG)

LFCShotsSeason <- LFCShotsALL %>%
  select(xG)

OppoB1Shots <- OppoShotsB1 %>%
  select(xGA = xG)

LFCB1Shots <- LFCShotsB1 %>%
  select(xG)


color_mapping <- c("xG" = Color_Home, "xGA" = Color_Away) 


MC_Title_text <- paste0(
            glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Liverpool Expected Goals </span>
                 <span style='color:gray12;font-size:16px;'>(</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>For</span>
                 <span style='font-family:\"Arial\";color:gray12;font-size:16px;'>and</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Against</span>
                 <span style='color:gray12;font-size:16px;'>)</span>"))

#Season MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoShotsSeason$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- Season_GA # set number of goals you want proportion for

number_goals <- sum(SeasonxGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxGA_output >= goals) # at least that many goals

table(SeasonxGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCShotsSeason$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- Season_G # set number of goals you want proportion for

number_goals <- sum(SeasonxG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxG_output >= goals) # at least that many goals

table(SeasonxG_output)

# create data frame from the MC output, so converting vector into data frame
SeasonMC_Output <- data.frame(SeasonxGA_output, SeasonxG_output)



#Block 1 MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoB1Shots$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- B1_GA # set number of goals you want proportion for

number_goals <- sum(B1xGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xGA_output >= goals) # at least that many goals

table(B1xGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCB1Shots$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- B1_G # set number of goals you want proportion for

number_goals <- sum(B1xG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xG_output >= goals) # at least that many goals

table(B1xG_output)

# create data frame from the MC output, so converting vector into data frame
B1MC_Output <- data.frame(B1xGA_output, B1xG_output)

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
x <- c(SeasonxG_output, SeasonxGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_SeasonxG <- data.frame(x, group = group)


x <- c(B1xG_output, B1xGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_B1xG <- data.frame(x, group = group)

B1_Histogram_xG <- df_B1xG %>%
  ggplot(aes(x = x, fill = group, color = group)) + 
  geom_histogram(
    binwidth = 1, 
    alpha = 0.5, 
    position = "identity") +
  scale_x_continuous(breaks = seq(0, max(x), 2)) +
  
  #formatting
  scale_fill_manual(values = color_mapping) +
  scale_color_manual(values = color_mapping) +
  labs(title = paste(MC_Title_text),
       subtitle = paste("1000 sims"),
       x="Goals",
       y="Count", 
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(), 
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        panel.grid.major.y = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

B1_Histogram_xG

```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```


```{r}
#Matchday MC
HomexGMCB1 <- HomeShots <- GTimeDashboard_data %>%
  select(xG)
AwayxGMCB1 <- AwayShots <- GTimeOppoDashboard_data %>%
  select(xG)

HomeTotalGoals <- sum(!is.na(ifelse(GTimeDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(GTimeOppoDashboard_data$type == "Goal", 1, NA)))

# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMCB1$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrixB1 <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrixB1 <- as.data.frame(as.table(prob_matrixB1))
colnames(long_prob_matrixB1) <- c("Home", "Away", "Probability")

long_prob_matrixB1 <- long_prob_matrixB1 %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false


# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrixB1[upper.tri(prob_matrixB1)])*100)
Home_wins_prob <- (sum(prob_matrixB1[lower.tri(prob_matrixB1)])*100)
tie_prob <- (sum(diag(prob_matrixB1))*100)

# Create a data frame for bar chart
outcome_probB1 <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_probB1 <- outcome_probB1 %>%
  mutate(Probability = round(Probability,2))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#calculate match actual goals
#Matchday MC
HomexGMC <- HomeShots <- GTimeDashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- GTimeOppoDashboard_data %>%
  select(xG)

#calculate match actual goals
HomeTotalGoals <- sum(!is.na(ifelse(GTimeDashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(GTimeOppoDashboard_data$type == "Goal", 1, NA)))


#run MC for Match outcomes and Match Score proablity
sim_results <- simulate_match_outcomes(home_xg_vector = HomexGMC, away_xg_vector = AwayxGMC, seed = 1111, runs = 10000, actual_home_goals = HomeTotalGoals, actual_away_goals = AwayTotalGoals)

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(sim_results$prob_matrix[upper.tri(sim_results$prob_matrix)])*100)
Home_wins_prob <- (sum(sim_results$prob_matrix[lower.tri(sim_results$prob_matrix)])*100)
tie_prob <- (sum(diag(sim_results$prob_matrix))*100)

# Create a data frame for Match outcome bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

outcome_prob <- outcome_prob %>%
  mutate(Probability = round(Probability, 2))

#create data frame for Match score tile plot
long_prob_matrix <- sim_results$long_prob_matrix

#redo factor to numeric the score probablity
long_prob_matrix <- long_prob_matrix %>%
  mutate(Home = as.numeric(as.character(Home)),
         Away = as.numeric(as.character(Away)))


# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```

```{r}
#| label: Match Result Probablity Plot gt
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot

```




```{r}
MD_MC_Result_PlotB1 <- ggplot(outcome_probB1) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (1000 Sims)",
       subtitle = "",
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#MD_MC_Result_PlotB1

```

``` {r}
#| output: false
#MC Season calculations for top three
#load data

LFCShotsALL <- GTimeDashboard_data

OppoShotsALL <- GTimeOppoDashboard_data

OppoShotsB1 <- OppoShotsALL 

LFCShotsB1 <- LFCShotsALL 

#set total goals for and against
TotalGoals <- sum(!is.na(ifelse(LFCShotsALL$result == "Goal", 1, NA)))
TotalGA <- sum(!is.na(ifelse(OppoShotsALL$result == "Goal", 1, NA)))
TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsALL$result == "OwnGoal", 1, NA)))
TotalGA_OG <- sum(!is.na(ifelse(OppoShotsALL$result == "OwnGoal", 1, NA)))

B1TotalGoals <- sum(!is.na(ifelse(LFCShotsB1$result == "Goal", 1, NA)))
B1TotalGA <- sum(!is.na(ifelse(OppoShotsB1$result == "Goal", 1, NA)))
B1TotalGoals_OG <- sum(!is.na(ifelse(LFCShotsB1$result == "OwnGoal", 1, NA)))
B1TotalGA_OG <- sum(!is.na(ifelse(OppoShotsB1$result == "OwnGoal", 1, NA)))



#set final goal total

Season_G <- sum(TotalGoals + TotalGA_OG)
Season_GA <- sum(TotalGA + TotalGoals_OG)

B1_G <- sum(B1TotalGoals + B1TotalGA_OG)
B1_GA <- sum(B1TotalGA + B1TotalGoals_OG)



#filter for just xg and xga
OppoShotsSeason <- OppoShotsALL %>%
  select(xGA = xG)

LFCShotsSeason <- LFCShotsALL %>%
  select(xG)

OppoB1Shots <- OppoShotsB1 %>%
  select(xGA = xG)

LFCB1Shots <- LFCShotsB1 %>%
  select(xG)


color_mapping <- c("xG" = Color_Home, "xGA" = Color_Away) 


MC_Title_text <- paste0(
            glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Liverpool Expected Goals </span>
                 <span style='color:gray12;font-size:16px;'>(</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>For</span>
                 <span style='font-family:\"Arial\";color:gray12;font-size:16px;'>and</span>
                 <span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Against</span>
                 <span style='color:gray12;font-size:16px;'>)</span>"))

#Season MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

SeasonxG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoShotsSeason$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- Season_GA # set number of goals you want proportion for

number_goals <- sum(SeasonxGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxGA_output >= goals) # at least that many goals

table(SeasonxGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCShotsSeason$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  SeasonxG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- Season_G # set number of goals you want proportion for

number_goals <- sum(SeasonxG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(SeasonxG_output >= goals) # at least that many goals

table(SeasonxG_output)

# create data frame from the MC output, so converting vector into data frame
SeasonMC_Output <- data.frame(SeasonxGA_output, SeasonxG_output)



#Block 1 MC
# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xGA_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 1000; # change based on how many simulation runs you want

B1xG_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Against
for (i in 1:runs) {
  temp_game <- sapply(OppoB1Shots$xGA, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xGA_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- B1_GA # set number of goals you want proportion for

number_goals <- sum(B1xGA_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xGA_output >= goals) # at least that many goals

table(B1xGA_output)


# monte carlo simulation --------------------------------------------------
#Goals For
for (i in 1:runs) {
  temp_game <- sapply(LFCB1Shots$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  B1xG_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- B1_G # set number of goals you want proportion for

number_goals <- sum(B1xG_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(B1xG_output >= goals) # at least that many goals

table(B1xG_output)

# create data frame from the MC output, so converting vector into data frame
B1MC_Output <- data.frame(B1xGA_output, B1xG_output)

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
x <- c(SeasonxG_output, SeasonxGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_SeasonxG <- data.frame(x, group = group)


x <- c(B1xG_output, B1xGA_output)
group <- c(rep("xG", 1000), rep("xGA", 1000))
df_B1xG <- data.frame(x, group = group)

B1_Histogram_xG <- df_B1xG %>%
  ggplot(aes(x = x, fill = group, color = group)) + 
  geom_histogram(
    binwidth = 1, 
    alpha = 0.5, 
    position = "identity") +
  scale_x_continuous(breaks = seq(0, max(x), 2)) +
  
  #formatting
  scale_fill_manual(values = color_mapping) +
  scale_color_manual(values = color_mapping) +
  labs(title = paste(MC_Title_text),
       subtitle = paste("1000 sims"),
       x="Goals",
       y="Count", 
       caption = My_caption) +
 theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
    plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 10),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        panel.grid.major.y = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

B1_Histogram_xG

```


# Passing Analysis

```{r}
#| output: false
# Step 1: Filter successful passes open play only
successful_passes <- plottingData 
successful_passesB1 <- plottingDataB1 
successful_passesB2 <- plottingDataB2 
successful_passesB3 <- plottingDataB3 

# Step 2: Identify passing sequences with more than the defined level of pass

passing_sequencesLFC <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)


passing_sequencesOppo <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & Team_Group == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & Team_Group == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)

passing_sequencesLFCB1 <- successful_passesB1 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)


passing_sequencesOppoB1 <- successful_passesB1 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & Team_Group == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & Team_Group == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)

passing_sequencesLFCB2 <- successful_passesB2 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)


passing_sequencesOppoB2 <- successful_passesB2 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & Team_Group == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & Team_Group == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)

passing_sequencesLFCB3 <- successful_passesB3 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & TeamName == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & TeamName == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)


passing_sequencesOppoB3 <- successful_passesB3 %>%
  #filter(Game_Block == 1) %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & Team_Group == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & Team_Group == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, Team_Group, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, Game_Block, period, Game_State, Match_day
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1)

#tabeldata
passing_sequencesLFC_Table <- passing_sequencesLFC %>%
  filter(Team_Group == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesLFC_1st_Table <- passing_sequencesLFC %>%
  filter(Team_Group == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1
    #, 
    #Game_Block == 1
    ) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance, Game_State) %>%
  group_by(Pass_Chain_Length, Game_State) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance',  Game_State)

passing_sequencesLFC_2nd_Table <- passing_sequencesLFC %>%
  filter(Team_Group == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1
    #,
    #Game_Block == 2
    ) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')


passing_sequencesOppo_Table <- passing_sequencesOppo %>%
  filter(Team_Group == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesOppo_1st_Table <- passing_sequencesOppo %>%
  filter(Team_Group == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1
    #,
    #Game_Block == 1
    ) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance, Game_State) %>%
  group_by(Pass_Chain_Length, Game_State) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance',  Game_State)

passing_sequencesOppo_2nd_Table <- passing_sequencesOppo %>%
  filter(Team_Group == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1
    #,
    #Game_Block == 2
    ) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

# Define the desired order
desired_order <- c("VLow", "Low", "Medium", "High")

# Arrange passing_sequencesLFC_Table
passing_sequencesLFC_Table <- passing_sequencesLFC_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesOppo_Table
passing_sequencesOppo_Table <- passing_sequencesOppo_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesLFC_1st_Table <- passing_sequencesLFC_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesOppo_Table
passing_sequencesOppo_1st_Table <- passing_sequencesOppo_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesLFC_2nd_Table <- passing_sequencesLFC_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesOppo_Table
passing_sequencesOppo_2nd_Table <- passing_sequencesOppo_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))
```

```{r}
#| output: false
Zone14_Passes_LFC_Data <- plottingData %>%
  filter(Team_Group == Match_Home,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start, Game_State, Match_day)

Zone14_Passes_LFC_Data <- Zone14_Passes_LFC_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_LFC_Data <- plottingData %>%
  filter(Team_Group == Match_Home,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start, Game_State, Match_day)

LHS_Passes_LFC_Data <- LHS_Passes_LFC_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_LFC_Data <- plottingData %>%
  filter(Team_Group == Match_Home,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start, Game_State, Match_day)

RHS_Passes_LFC_Data <- RHS_Passes_LFC_Data %>%
  filter(Successful_Passes == 1)

Zone14_Passes_Oppo_Data <- plottingData %>%
  filter(Team_Group == Match_Away,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start, Game_State, Match_day)

Zone14_Passes_Oppo_Data <- Zone14_Passes_Oppo_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_Oppo_Data <- plottingData %>%
  filter(Team_Group == Match_Away,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start, Game_State, Match_day)

LHS_Passes_Oppo_Data <- LHS_Passes_Oppo_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_Oppo_Data <- plottingData %>%
  filter(Team_Group == Match_Away,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(Team_Group, Game_Block, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start, Game_State, Match_day)

RHS_Passes_Oppo_Data <- RHS_Passes_Oppo_Data %>%
  filter(Successful_Passes == 1)

#combine data frames
Z14_HS_Passes_LFC_Data <- bind_rows(Zone14_Passes_LFC_Data, LHS_Passes_LFC_Data, RHS_Passes_LFC_Data)

Z14_HS_Passes_Oppo_Data <- bind_rows(Zone14_Passes_Oppo_Data, LHS_Passes_Oppo_Data, RHS_Passes_Oppo_Data)

Z14_HS_Passes_LFC_Data <- Z14_HS_Passes_LFC_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_Oppo_Data <- Z14_HS_Passes_Oppo_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_LFC_Data <- Z14_HS_Passes_LFC_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))

Z14_HS_Passes_Oppo_Data <- Z14_HS_Passes_Oppo_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))


Z14_HS_Passes_LFC_DataB1 <- Z14_HS_Passes_LFC_Data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

Z14_HS_Passes_LFC_DataB2 <- Z14_HS_Passes_LFC_Data %>%
  filter(Game_State == "Draw")

Z14_HS_Passes_LFC_DataB3 <- Z14_HS_Passes_LFC_Data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

Z14_HS_Passes_Oppo_DataB1 <- Z14_HS_Passes_Oppo_Data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

Z14_HS_Passes_Oppo_DataB2 <- Z14_HS_Passes_Oppo_Data %>%
  filter(Game_State == "Draw")

Z14_HS_Passes_Oppo_DataB3 <- Z14_HS_Passes_Oppo_Data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

```

## Row {.flow}
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```

## Row {.flow}
```{r Passnetworks home 1st half}
LFCpassPlot1stWD <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot1stWD

```

```{r home 2nd half}
LFCpassPlot2ndWD <- plot_passnet_AI(data = plottingData,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot2ndWD
```

## Row {.flow}
```{r}
#passing chains all in
passing_sequencesLFC_Plot <- passing_sequencesLFC %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesLFC$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesLFC$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesLFC_Plot
```

```{r}
#passing chains all in
passing_sequencesOppo_Plot <- passing_sequencesOppo %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesOppo$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesOppo$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesOppo_Plot

```
## Row
```{r}
Zone14_HS_Passes_LFC_Plot <- Z14_HS_Passes_LFC_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 and HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_LFC_Plot
```
```{r}
Zone14_HS_Passes_Oppo_Plot <- Z14_HS_Passes_Oppo_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = paste0("Zone 14 and HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Oppo_Plot
```

## Row {.flow}
```{r}
#| label: home passing chaing tables
#| results: asis
Home_Passing_Chains_Table <- passing_sequencesLFC_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Full season Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_Table


```

```{r}
#| results: asis
#| label: away passing chaing tables
Oppo_Passing_Chains_Table <- passing_sequencesOppo_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Full Season Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Oppo_Passing_Chains_Table

```
## Row {.flow}
```{r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Data <- plottingData %>%
  filter(Long_Passes == 1 | Cross_Passes == 1) %>%
  select(Team_Group, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Cross_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName, Match_day) %>%
mutate(Cross_Passes = if_else(is.na(Cross_Passes), 0, Cross_Passes)) %>%
  mutate(Pass_Type = ifelse(Cross_Passes == 1, "Cross",
                            ifelse(Long_Passes == 1, "Long Pass", "Successful"))) %>%
    mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))


Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Home) %>%
  #filter(!Match_day == 0) %>%
  filter(EPVvalue >= 0.08) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  #facet_grid(Pass_Type ~ Match_day) +
  #facet_wrap(~ Pass_Type + Half + Match_day) +
  #facet_wrap(vars(Pass_Type, Half, Match_day), ncol = 3) +
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
#ggsave(path = Vizlocation, "Home Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```
``` {r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Away) %>%
    filter(EPVvalue >= 0.08) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```

## Row {.flow}
```{r Passnetworks home 1st half B1}
LFCpassPlot1stWD <- plot_passnet_AI(data = plottingDataB1,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot1stWD

```

```{r home 2nd half B1}
LFCpassPlot2ndWD <- plot_passnet_AI(data = plottingDataB1,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot2ndWD
```

## Row {.flow}
```{r}
#passing chains all in
passing_sequencesLFC_PlotB1 <- passing_sequencesLFCB1 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesLFCB1$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesLFCB1$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesLFC_PlotB1
```

```{r}
#passing chains all in
passing_sequencesOppo_PlotB1 <- passing_sequencesOppoB1 %>%
    #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesOppoB1$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesOppoB1$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesOppo_PlotB1

```
## Row
```{r}
Zone14_HS_Passes_LFC_PlotB1 <- Z14_HS_Passes_LFC_DataB1 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 and HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_LFC_PlotB1
```
```{r}
Zone14_HS_Passes_Oppo_PlotB1 <- Z14_HS_Passes_Oppo_DataB1 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = paste0("Zone 14 and HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Oppo_PlotB1
```
## Row {.flow}
```{r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Data <- plottingDataB1 %>%
  filter(Long_Passes == 1 | Cross_Passes == 1) %>%
  select(Team_Group, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Cross_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName) %>%
  mutate(Cross_Passes = if_else(is.na(Cross_Passes), 0, Cross_Passes)) %>%
  mutate(Pass_Type = ifelse(Cross_Passes == 1, "Cross",
                            ifelse(Long_Passes == 1, "Long Pass","Successful"))) %>%
    mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))


Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Home) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

``` {r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Away) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


## Row
```{r}
#| content: valuebox
#| height: "100%"

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )

```
## Row {.flow}
```{r}
LFCpassPlot1stWD <- plot_passnet_AI(data = plottingDataB2,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot1stWD

```

```{r}
LFCpassPlot2ndWD <- plot_passnet_AI(data = plottingDataB2,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot2ndWD
```

## Row {.flow}
```{r}
#passing chains all in
passing_sequencesLFC_PlotB2 <- passing_sequencesLFCB2 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesLFCB2$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesLFCB2$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesLFC_PlotB2
```

```{r}
#passing chains all in
passing_sequencesOppo_PlotB2 <- passing_sequencesOppoB2 %>%
    #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesOppoB2$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesOppoB2$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesOppo_PlotB2

```
## Row
```{r}
Zone14_HS_Passes_LFC_PlotB2 <- Z14_HS_Passes_LFC_DataB2 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 and HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_LFC_PlotB2
```
```{r}
Zone14_HS_Passes_Oppo_PlotB2 <- Z14_HS_Passes_Oppo_DataB2 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = paste0("Zone 14 and HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Oppo_PlotB2
```

## Row {.flow}
```{r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Data <- plottingDataB2 %>%
  filter(Long_Passes == 1 | Cross_Passes == 1) %>%
  select(Team_Group, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Cross_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName) %>%
    mutate(Cross_Passes = if_else(is.na(Cross_Passes), 0, Cross_Passes)) %>%
  mutate(Pass_Type = ifelse(Cross_Passes == 1, "Cross",
                            ifelse(Long_Passes == 1, "Long Pass","Successful"))) %>%
    mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))


Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Home) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

``` {r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Away) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```
## Row {.flow}
```{r}
LFCpassPlot1stWD <- plot_passnet_AI(data = plottingDataB3,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot1stWD

```

```{r}
LFCpassPlot2ndWD <- plot_passnet_AI(data = plottingDataB3,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 25)
LFCpassPlot2ndWD
```

## Row {.flow}
```{r}
#passing chains all in
passing_sequencesLFC_PlotB3 <- passing_sequencesLFCB3 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesLFCB3$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesLFCB3$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesLFC_PlotB3
```

```{r}
#passing chains all in
passing_sequencesOppo_PlotB3 <- passing_sequencesOppoB3 %>%
    #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesOppoB3$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.1, "cm")),
    lineend = "round",
    linewidth = 0.1,
    color = passing_sequencesOppoB3$Pchain
  ) +
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesOppo_PlotB3

```
## Row
```{r}
Zone14_HS_Passes_LFC_PlotB3 <- Z14_HS_Passes_LFC_DataB3 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 and HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_LFC_PlotB3
```
```{r}
Zone14_HS_Passes_Oppo_PlotB3 <- Z14_HS_Passes_Oppo_DataB3 %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = paste0("Zone 14 and HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Oppo_PlotB3
```

## Row {.flow}
```{r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Data <- plottingDataB3 %>%
  filter(Long_Passes == 1 | Cross_Passes == 1) %>%
  select(Team_Group, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Cross_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName) %>%
    mutate(Cross_Passes = if_else(is.na(Cross_Passes), 0, Cross_Passes)) %>%
  mutate(Pass_Type = ifelse(Cross_Passes == 1, "Cross",
                            ifelse(Long_Passes == 1, "Long Pass","Successful"))) %>%
    mutate(Half = ifelse(period == 1, "First Half",
                            ifelse(period == 2, "Second Half",
                                   ifelse(period == 3, "First Half Extra Time",
                                          ifelse(period == 4, "Second Half Extra Time", "Injury Time")))))

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes & Crosses (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))


Long_Passes_Home_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Home) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot

#save Plot
ggsave(path = Vizlocation, "Home Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

``` {r}
#| out-height: 100%
#| out-width: 100%
Long_Passes_Away_Plot <- Long_Passes_Data %>%
    filter(Team_Group == Match_Away) %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.2, "cm")),
    lineend = "round",
    linewidth = 0.15) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(Pass_Type ~Half) +
  #facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")


Long_Passes_Away_Plot


#save Plot
ggsave(path = Vizlocation, "Away Crosses and Long pass plot.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

## Row {.flow}
```{r}
#| results: asis
#| label: home passing chaing tables all
Home_Passing_Chains_Table_all <- passing_sequencesLFC_1st_Table %>%
  gt(groupname_col = "Game_State") %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Full season Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_Table_all


```

```{r}
#| results: asis
#| label: away passing chaing tables all
Oppo_Passing_Chains_Table_all <- passing_sequencesOppo_1st_Table %>%
  gt(groupname_col = "Game_State") %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Full Season Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Oppo_Passing_Chains_Table_all

```

# Player Analysis

```{r player data setup, echo:FALSE, messages:FALSE, warnings:FALSE}
#| output: false
#player summary tables
#posession and goals by Player
MatchSummaryPLayerData <- plottingData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = as.numeric(ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0))) %>%
  group_by(TeamName, playerId, Team_Group, role) %>%
  summarise_at(vars(Goals, TotalShots, 'OFT Shots' = OFShots, 'OT Shots' = OTShots, Out_Box_Shots, Touches, PK_Box_Touches, Attempted_Passes, Successful_Passes, TeamEPV, Key_Passes, Assists, Hockey_Assists, BCs, xG, xGOT, Aerial_total, Aerial_Won, Aerial_Lost, Ground_Duels_Total, Ground_Duels_Won, Ground_Duels_Lost), list(sum), na.rm = TRUE) %>%
  ungroup() %>%
  group_by(Team_Group) %>%
  mutate(
    Team_TotalTouches = sum(Touches),
    Team_TotalEPV = sum(TeamEPV),
    Team_TotalxG = sum(xG),
    Team_TotalPasses = sum(Attempted_Passes),
    Team_TotalDuels = sum(Ground_Duels_Total),
    Team_TotalAerials = sum(Aerial_total),
    Team_TotalShots = sum(TotalShots),
    Possession = round((Touches / Team_TotalTouches) * 100, 1),
    Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
    Aerial_Success = round((Aerial_Won / Aerial_total) * 100, 1),
    Duel_Success = round((Ground_Duels_Won / Ground_Duels_Total) * 100, 1),
    On_Ball_Time = round(InPlayTime * (Possession / 100), 1),
    Team_EPV_P = round((TeamEPV / Team_TotalEPV) * 100, 1),
    Team_xG_P = round((xG / Team_TotalxG) * 100, 1),
    Team_Duels_P = round((Ground_Duels_Total / Team_TotalDuels) * 100, 1),
    Team_Aerial_P = round((Aerial_total / Team_TotalAerials) * 100, 1),
    Team_Passes_P = round((Attempted_Passes / Team_TotalPasses) * 100, 1),
    Team_Shots_P = round((TotalShots / Team_TotalShots) * 100, 1)
  ) %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0))) %>%
  #replace_na(list( Aerial_Success = 0)) %>%
  #replace_na(list( Duel_Success = 0)) %>%
  filter(role != is.na(role)) %>%
  ungroup()

MatchSummarySeasonPlayerData <- plottingData %>%
  dplyr::mutate(
    Out_of_play_time = Out_of_play_time / 60,
    EventTime        = EventTime / 60,
    TeamEPV          = as.numeric(dplyr::if_else(
                         stringr::str_detect(`outcomeType/value`, "1"),
                         EPVvalue, 0
                       ))
  ) %>%
  dplyr::group_by(TeamName, playerId, Team_Group, role) %>%
  dplyr::summarise(
    n_matches = dplyr::n_distinct(game_name),
    dplyr::across(
      c(
        Goals, TotalShots, OFShots, OTShots, Out_Box_Shots,
        Touches, PK_Box_Touches,
        Attempted_Passes, Successful_Passes, TeamEPV,
        Key_Passes, Assists, Hockey_Assists, BCs,
        xG, xGOT,
        Aerial_total, Aerial_Won, Aerial_Lost,
        Ground_Duels_Total, Ground_Duels_Won, Ground_Duels_Lost
      ),
      ~ sum(.x, na.rm = TRUE) / n_matches
    ),
    .groups = "drop"
  ) %>%
  dplyr::select(-n_matches) %>%
  dplyr::group_by(Team_Group) %>%
  dplyr::mutate(
    Team_TotalTouches = sum(Touches, na.rm = TRUE),
    Team_TotalEPV     = sum(TeamEPV, na.rm = TRUE),
    Team_TotalxG      = sum(xG, na.rm = TRUE),
    Team_TotalPasses  = sum(Attempted_Passes, na.rm = TRUE),
    Team_TotalDuels   = sum(Ground_Duels_Total, na.rm = TRUE),
    Team_TotalAerials = sum(Aerial_total, na.rm = TRUE),
    Team_TotalShots   = sum(TotalShots, na.rm = TRUE),

    Possession        = (Touches / Team_TotalTouches) * 100,
    Pass_Success      = (Successful_Passes / Attempted_Passes) * 100,
    Aerial_Success    = (Aerial_Won / Aerial_total) * 100,
    Duel_Success      = (Ground_Duels_Won / Ground_Duels_Total) * 100,
    On_Ball_Time      = InPlayTime * (Possession / 100),  # assumes InPlayTime exists upstream

    Team_EPV_P        = (TeamEPV / Team_TotalEPV) * 100,
    Team_xG_P         = (xG / Team_TotalxG) * 100,
    Team_Duels_P      = (Ground_Duels_Total / Team_TotalDuels) * 100,
    Team_Aerial_P     = (Aerial_total / Team_TotalAerials) * 100,
    Team_Passes_P     = (Attempted_Passes / Team_TotalPasses) * 100,
    Team_Shots_P      = (TotalShots / Team_TotalShots) * 100
  ) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(role)) %>%
  dplyr::mutate(dplyr::across(where(is.numeric), ~ tidyr::replace_na(.x, 0))) %>%
  dplyr::mutate(dplyr::across(where(is.numeric), ~ round(.x, 2)))

MatchSummaryPLayerProfileData <- MatchSummaryPLayerData

MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  select(Team = Team_Group, role, Name = playerId, '% of Team Possession' = Possession, `% of Team On Ball Time` = On_Ball_Time, Touches = Touches, 'Total Shots' = TotalShots, 'Out Box Shots' = Out_Box_Shots, BCs, Goals, xG, xGOT,  'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, 'Key Passes' = Key_Passes, EPV = TeamEPV, '% of Team EPV' = Team_EPV_P, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success' = Duel_Success)

MatchSummarySeasonPlayerData <- MatchSummarySeasonPlayerData %>%
  select(Team = Team_Group, role, Name = playerId, '% of Team Possession' = Possession, `% of Team On Ball Time` = On_Ball_Time, Touches = Touches, 'Total Shots' = TotalShots, 'Out Box Shots' = Out_Box_Shots, BCs, Goals, xG, xGOT,  'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, 'Key Passes' = Key_Passes, EPV = TeamEPV, '% of Team EPV' = Team_EPV_P, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success' = Duel_Success)

Player_Summary_plot_data <- MatchSummaryPLayerProfileData %>%
  select(Team = Team_Group, Name = playerId, role, '% Possession' = Possession, `% On Ball Time` = On_Ball_Time, Touches = Touches, 'Total Shots' = TotalShots, 'OFT Shots', 'OT Shots', 'Out Box Shots' = Out_Box_Shots, BCs, Goals, xG, xGOT, '% xG' = Team_xG_P, Touches, PK_Box_Touches, 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, 'Key Passes' = Key_Passes, EPV = TeamEPV, '% EPV' = Team_EPV_P, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success %' = Duel_Success, '% Duels' = Team_Duels_P, '% Passes' = Team_Passes_P, '% Shots' = Team_Shots_P, '% Aerials' = Team_Aerial_P)


Player_Summary_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, '% Possession', '% On Ball Time', '% EPV', '% Passes', '% Shots', '% Duels', '% Aerials') %>%
  pivot_longer(cols = c('% Possession', '% On Ball Time', '% EPV','% Passes', '% Shots', '% Duels', '% Aerials'), names_to = "Metric", values_to = "Value")

#player profile plot data

Player_Goal_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, 'OFT Shots', 'OT Shots', 'Out Box Shots', BCs, Goals, Assists, 'Key Passes') %>%
  pivot_longer(cols = c(`OFT Shots`, 'OT Shots', `Out Box Shots`, BCs, Goals, Assists, `Key Passes`), names_to = "Metric", values_to = "Value") 

#filter data by team
Player_Summary_plot_data_Home <- Player_Summary_data %>%
  filter(Team == Match_Home)

Player_Summary_plot_data_Away <- Player_Summary_data %>%
  filter(Team == Match_Away) 

Player_Goal_plot_data_Home <- Player_Goal_data %>%
  filter(Team == Match_Home)

Player_Goal_plot_data_Away <- Player_Goal_data %>%
  filter(Team == Match_Away) 


#work out team and unit averages
#general metrics
Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

#goal metrics
Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()



#wrap the tiles for the general plot
Player_Summary_data_Home$Metric  <- str_wrap(Player_Summary_data_Home$Metric, width = 5)  

Player_Summary_data_Away$Metric  <- str_wrap(Player_Summary_data_Away$Metric, width = 5)  


#wrap the tiles for the goal plot
Player_Goal_data_Home$Metric  <- str_wrap(Player_Goal_data_Home$Metric, width = 5)  

Player_Goal_data_Away$Metric  <- str_wrap(Player_Goal_data_Away$Metric, width = 5)  


#reorder data
facet_order <- c("Keeper", "Defender", "Midfielder", "Attacker")

#general plot
Player_Summary_data_Home  <- Player_Summary_data_Home  %>%
arrange(factor(role, levels = facet_order))

Player_Summary_data_Away  <- Player_Summary_data_Away  %>%
  arrange(factor(role, levels = facet_order))

#goal plot
Player_Goal_data_Home <- Player_Goal_data_Home %>%
  arrange(factor(role, levels = facet_order))

Player_Goal_data_Away <- Player_Goal_data_Away %>%
  arrange(factor(role, levels = facet_order))

```

## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```
## Row
### row {.tabset}
```{r}
#| results: asis
#| title: Player season sumary - averages
MatchSummarySeasonPlayerTableHome <- MatchSummarySeasonPlayerData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "role", rowname_col = "Name") %>%
  #row_group_order(groups = c("Keeper","Defender","Midfielder", "Attacker")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  #cols_hide(Player) %>%
  #gt_img_rows(columns = Player, height = 25) %>%
#  gt_img_circle(column = 'Player', height = 40, border_color = "black", border_weight = 1.5) %>%
#  cols_width(Player ~ px(45)) %>% # 110 = 100 (height) + 10 (padding around imgs)
  summary_rows(columns = c(5:25), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(4:5, 5, 15, 19, 22, 25),
    scale_values = FALSE,
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(18),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Shots", columns = c(9:12)) %>%
  tab_spanner(label = "Passes", columns = c(13:19)) %>%
  tab_spanner(label = "Duels", columns = c(20:25)) %>%
  #tab_style(
  #  style = cell_text(color = "#E5E5E5"),
  #  locations = cells_column_labels('Player')) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Duels'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  gt_color_rows(columns = c(5), palette = ColorScale_Home, domain = c(0,15)) %>%
  gt_color_rows(columns = c(7, 6, 13, 14, 15, 19, 22, 25), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(7, 20, 24), palette = ColorScale_Home, domain = c(0,10)) %>%
  gt_color_rows(columns = c(8:10, 16:17), palette = ColorScale_Home, domain = c(0,5)) %>%
  gt_color_rows(columns = c(21, 23), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(18), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(11:12), palette = ColorScale_Home, domain = c(0,3))

MatchSummarySeasonPlayerTableHome

```
```{r}
#| results: asis
#| title: Player season sumary - Totals
MatchSummaryPlayerTableHome <- MatchSummaryPLayerData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "role", rowname_col = "Name") %>%
  #row_group_order(groups = c("Keeper","Defender","Midfielder", "Attacker")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  #cols_hide(Player) %>%
  #gt_img_rows(columns = Player, height = 25) %>%
#  gt_img_circle(column = 'Player', height = 40, border_color = "black", border_weight = 1.5) %>%
#  cols_width(Player ~ px(45)) %>% # 110 = 100 (height) + 10 (padding around imgs)
  summary_rows(columns = c(5:25), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:25), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(4:5, 5, 15, 19, 22, 25),
    scale_values = FALSE,
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(18),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Shots", columns = c(9:12)) %>%
  tab_spanner(label = "Passes", columns = c(13:19)) %>%
  tab_spanner(label = "Duels", columns = c(20:25)) %>%
  #tab_style(
  #  style = cell_text(color = "#E5E5E5"),
  #  locations = cells_column_labels('Player')) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Duels'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  gt_color_rows(columns = c(5), palette = ColorScale_Home, domain = c(0,15)) %>%
  gt_color_rows(columns = c(7, 6, 13, 14, 15, 19, 22, 25), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(7, 20, 24), palette = ColorScale_Home, domain = c(0,10)) %>%
  gt_color_rows(columns = c(8:10, 16:17), palette = ColorScale_Home, domain = c(0,5)) %>%
  gt_color_rows(columns = c(21, 23), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(18), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(11:12), palette = ColorScale_Home, domain = c(0,3))

MatchSummaryPlayerTableHome

```

```{r}
#| results: asis
MatchSummaryPlayerTableAway <- MatchSummaryPLayerData %>%
  filter(Team == Match_Away) %>%
  gt(groupname_col = "role", rowname_col = "Name") %>%
  #row_group_order(groups = c("Keeper","Defender","Midfielder", "Attacker")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  #cols_hide(Player) %>%
  #gt_img_rows(columns = Player, height = 25) %>%
#  gt_img_circle(column = 'Player', height = 40, border_color = "black", border_weight = 1.5) %>%
#  cols_width(Player ~ px(45)) %>% # 110 = 100 (height) + 10 (padding around imgs)
  summary_rows(columns = c(4:25), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(4:25), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(4:5, 5, 15, 19, 22, 25),
    scale_values = FALSE,
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(18),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Shots", columns = c(7:12)) %>%
  tab_spanner(label = "Passes", columns = c(13:19)) %>%
  tab_spanner(label = "Duels", columns = c(20:25)) %>%
  #tab_style(
  #  style = cell_text(color = "#E5E5E5"),
  #  locations = cells_column_labels('Player')) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Duels'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  gt_color_rows(columns = c(5), palette = ColorScale_Away, domain = c(0,15)) %>%
  gt_color_rows(columns = c(5, 6, 13, 14, 15, 19, 22, 25), palette = ColorScale_Away, domain = c(0,100)) %>%
  gt_color_rows(columns = c(7, 19, 24), palette = ColorScale_Away, domain = c(0,10)) %>%
  gt_color_rows(columns = c(8:10, 16:17), palette = ColorScale_Away, domain = c(0,5)) %>%
  gt_color_rows(columns = c(21, 23), palette = ColorScale_Away, domain = c(0,20)) %>%
  gt_color_rows(columns = c(18), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(11:12), palette = ColorScale_Away, domain = c(0,3))

#MatchSummaryPlayerTableAway
```


```{r pass connections home}
#| output: false
# this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

PassConnections <- plottingData 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "TeamName"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)


# number of passess between players
PassConnections <- PassConnections %>%
  filter(type == "Pass") %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue) 

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100),
         EPV_P_Pass = (round(EPV / Successful_Passes, 3))) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 50) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), EPV_P_Pass)

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV, EPV_P_Pass)
```

## Row
```{r}
#| results: asis
#Home pass connextions tables
PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(3),
    scale_values = FALSE,
    decimals = 1
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 50 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```


```{r}
#| output: false
#| #' dribbles and duels data setup

heatmapdata <- plottingData 

Dribblesmapdata <- heatmapdata %>%
  filter(Dribbles_Total == 1) %>%
  mutate(DribblesFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DribblesFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(TeamName, Team_Group, teamId, playerId, player_shirt, #player_image_url, 
         playerNumber, role,  x, y, DribblesFinalX, DribblesFinalY, outcome, Game_Period )


#duels aerial and ground data
Duelsmapdata <- heatmapdata
  
Duelsmapdata <- heatmapdata %>%
  filter(Ground_Duels_Total == 1 |
           Aerial_total == 1) %>%
  mutate(DuelsFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DuelsFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(TeamName,Team_Group, teamId, playerId, player_shirt, #player_image_url, 
         playerNumber, role, x, y, DuelsFinalX, DuelsFinalY, outcome, Game_Period )


#Liverpool duels data
LFCDuelsmapdata <- Duelsmapdata %>%
  filter(Team_Group == Match_Home)

#Oppo duels data
OppoDuelsmapdata <- Duelsmapdata %>%
  filter(Team_Group == Match_Away)

#Home Dribbles Data
LFCDribblesmapdata <- Dribblesmapdata %>%
  filter(Team_Group == Match_Home)

#Away Dribbles Data
OppoDribblesmapdata <- Dribblesmapdata %>%
  filter(Team_Group == Match_Away)

#PLayer touch data 
TouchDataLFC <- plottingData %>%
  filter(Team_Group == Match_Home)

TouchDataLFCB1 <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

TouchDataLFCB2 <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
           filter(Game_State == "Draw")

TouchDataLFCB3 <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

TouchDataOppo <- plottingData %>%
  filter(Team_Group == Match_Away)

#LFC TEAM Touch zones
TouchData <- plottingData %>%
  filter(!`qualifiers/0/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/1/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/2/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/3/type/value` %in% c(5, 6, 107, 2),
    `type/value` %in% c(1, 2, 3, 13, 14, 15, 16, 42, 50, 61))

LFCTeamTouchData <- TouchData %>%
  filter(TeamName == Match_Home)

OppoTeamTouchData <- TouchData %>%
  filter(Team_Group == Match_Away)

```
## Row

```{r}
#|height: 100%
LFCconvexPlot1st <- TouchPlayerPlot_AI(TouchDataLFC,  title = Match_Home,
                                    plot_start = 00, plot_finish = 100, color = Color_Home, text_color = Color_Home_Text,
                                    subtitle = paste0(Match_Fixture))
LFCconvexPlot1st
```
## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```
```{r pass connections homeb1}
#| output: false
# this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

PassConnections <- plottingDataB1 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "TeamName"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)


# number of passess between players
PassConnections <- PassConnections %>%
  filter(type == "Pass") %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue) 

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100),
         EPV_P_Pass = (round(EPV / Successful_Passes, 3))) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 25) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), EPV_P_Pass)

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV, EPV_P_Pass)
```

## Row
```{r}
#| results: asis
#Home pass connextions tables
PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(3),
    scale_values = FALSE,
    decimals = 1
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 25 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```
## Row
```{r}
#|height: 100%
LFCconvexPlot1stB1 <- TouchPlayerPlot_AI(TouchDataLFCB1,  title = Match_Home,
                                    plot_start = 00, plot_finish = 100, color = Color_Home, text_color = Color_Home_Text,
                                    subtitle = paste0(Match_Fixture))
LFCconvexPlot1stB1
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )
```
```{r pass connections home b2}
#| output: false
# this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

PassConnections <- plottingDataB2 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "TeamName"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)


# number of passess between players
PassConnections <- PassConnections %>%
  filter(type == "Pass") %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue) 

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100),
         EPV_P_Pass = (round(EPV / Successful_Passes, 3))) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 25) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), EPV_P_Pass)

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV, EPV_P_Pass)
```

## Row
```{r}
#| results: asis
#Home pass connextions tables
PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(3),
    scale_values = FALSE,
    decimals = 1
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 25 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```
## Row
```{r}
#|height: 100%
LFCconvexPlot1stB2 <- TouchPlayerPlot_AI(TouchDataLFCB2,  title = Match_Home,
                                    plot_start = 00, plot_finish = 100, color = Color_Home, text_color = Color_Home_Text,
                                    subtitle = paste0(Match_Fixture))
LFCconvexPlot1stB2


```
## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```

```{r pass connections homeb3}
#| output: false
# this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

PassConnections <- plottingDataB3 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "TeamName"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "TeamName", new_names = "receiver_team", len = 1, up = TRUE)


# number of passess between players
PassConnections <- PassConnections %>%
  filter(type == "Pass") %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = TeamName, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue) 

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100),
         EPV_P_Pass = (round(EPV / Successful_Passes, 3))) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 25) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV), EPV_P_Pass)

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV, EPV_P_Pass)
```

## Row
```{r}
#| results: asis
#Home pass connextions tables
PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  fmt_percent(
    columns = c(3),
    scale_values = FALSE,
    decimals = 1
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 25 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```

## Row
```{r}
#|height: 100%
LFCconvexPlot1stB3 <- TouchPlayerPlot_AI(TouchDataLFCB3,  title = Match_Home,
                                    plot_start = 00, plot_finish = 100, color = Color_Home, text_color = Color_Home_Text,
                                    subtitle = paste0(Match_Fixture))
LFCconvexPlot1stB3


```
```{r}
#| title: On ball touch plot 1st subs
#| label: home team touch plot 1st subs
#| height: 100%
#| message: false

HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomeTeamTouchData,  title = paste0(Match_Home, " Team On Ball Touch"),
                                     plot_start = 00, plot_finish = firstSubHome, color = Color_Home, logo = "", method = "mad",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

# EPV Analysis
```{r EPV home time plot}
#| output: false
#set final plot data frame

#EPV over time line plot Opta data
#data wrangling
EPVPlotData <- plottingData

EPVPlotData <- EPVPlotData %>%
  filter(Team_Group == Match_Home) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Home_Cumalative_EPV = cumsum(EPVvalue)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Home_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Home_Cumalative_EPV = round(Home_Cumalative_EPV,2))

OppoEPVPlotData <- plottingData

OppoEPVPlotData <- OppoEPVPlotData %>%
  filter(Team_Group == Match_Away) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Away_Cumalative_EPV = cumsum(EPVvalue)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Away_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Away_Cumalative_EPV = round(Away_Cumalative_EPV,2))
```
## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```


```{r EPV home area}
#| output: false
#EPV Development area  plot Opta data
#data wrangling
EPVAreaPlotData <- plottingData

EPVAreaPlotData <- EPVAreaPlotData %>%
  filter(Team_Group == Match_Home)

#set final plot data frame
EPVAreaPlotData <- EPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = mean(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(isGoal, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(isGoal, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

#Oppo EPV Development area  plot Opta data
#data wrangling
OppoEPVAreaPlotData <- plottingData

OppoEPVAreaPlotData <- OppoEPVAreaPlotData %>%
  filter(Team_Group == Match_Away)

#set final plot data frame
OppoEPVAreaPlotData <- OppoEPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = mean(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(isGoal, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(isGoal, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

```

## Row {.flow}

```{r}  
#| output: false
EPVHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74)

#set time period
EPVHeatMapDataFT <- EPVHeatMapData

# Calculte average player position
      Average_PlayerFT <- EPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPVFT <- sum(EPVHeatMapDataFT$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFT$zone_x <- cut(EPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFT$zone_y <- cut(EPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFT <- EPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
EPVMapplotFT <- ggplot(average_epvFT, aes(x = zone_x, y = zone_y, fill = avg_epv)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PEPV, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +

  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher EPV, \nBox figures = % of Total EPV"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_epvNZFT <- average_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZFT <- average_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPVFT,2)))  

```


```{r}
#Oppo EPV heat plots
#| output: false
OppoEPVHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74)

#set for time period
OppoEPVHeatMapDataFT <- OppoEPVHeatMapData

# Calculate average player position
      OppoAverage_PlayerFT <- OppoEPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
OppoEPVFT <- sum(OppoEPVHeatMapDataFT$EPVvalue)


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapDataFT$zone_x <- cut(OppoEPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapDataFT$zone_y <- cut(OppoEPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epvFT <- OppoEPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPVFT,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZFT <- Oppoaverage_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZFT <- Oppoaverage_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/OppoEPVFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
EPVHeatMapplotFT <- EPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
    #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +


  # add zone percentage numbers
  geom_text(data = average_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +

   #scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) +
#  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

EPVHeatMapplotFT
```

```{r}
#| height: 100%
OppoEPVHeatMapplotFT <- OppoEPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +

  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

OppoEPVHeatMapplotFT

```
```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#wrapped for time period
OppoEPVHeatMapDataFTW <- OppoEPVHeatMapData

#set EPV total for time period
OppoEPVFTW <- sum(OppoEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
OppoEPVFTGP <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapDataFTW$zone_x <- cut(OppoEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapDataFTW$zone_y <- cut(OppoEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epvFTW <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPVFTW,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZFTW <- Oppoaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  left_join(OppoEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
OppoEPVHeatMapplotFTW <- OppoEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

OppoEPVHeatMapplotFTW
```

## Row {.flow}
``` {r}
#| label: EPV defensive values setup fs
#| output: false

DefEPVData <- plottingData %>%
    filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "Def_EPV", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(Team_Group, TeamName, playerId, EPVvalue, Defensive_Action, outcome, Def_EPV, role) %>%
  mutate(Successful_Def_EPV = ifelse(str_detect(outcome, "Successful"), paste0(Def_EPV), 0)) %>%
  mutate(Unsuccessful_Def_EPV = ifelse(str_detect(outcome, "Unsuccessful"), paste0(Def_EPV), 0)) %>%
  mutate(Successful_Def_EPV = as.numeric(Successful_Def_EPV)) %>%
  mutate(Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

AwayDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Away) 

HomeDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Home)

#set EPV total for time period
HomeEPVFT <- sum(HomeDefEPVData$EPVvalue)
AwayEPVFT <- sum(AwayDefEPVData$EPVvalue)


  
HomeDefEPVData <- HomeDefEPVData %>%  
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/AwayEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/AwayEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 





AwayDefEPVData <- AwayDefEPVData %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/HomeEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/HomeEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 



HomeDefEPVTable <- HomeDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

AwayDefEPVTable <- AwayDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))



```

## Column {.flow}
```{r}
#| label: Home Defensive EPV performance tables FS
#| results: asis

HomeDefEPVTable_Final <- HomeDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender", 
    "Midfielder"
    #, "Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeDefEPVTable_Final
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```


```{r} 
#| output: false
#up to first subs map
#set time period
EPVHeatMapData1sub <- EPVHeatMapData %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set EPV total for time period
HomeEPV1sub <- sum(EPVHeatMapData1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1sub$zone_x <- cut(EPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1sub$zone_y <- cut(EPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1sub <- EPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1sub,3)) 

#calculate for combined tile and heat map
average_epvNZ1sub <- average_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1sub <- average_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1sub,2)))  
```
## Row
```{r}
#| height: 100%
EPVHeatMapplot1sub <- EPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  # add zone percentage numbers
  geom_text(data = average_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  

  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1sub
```
```{r}
#| output: false
#first subs
#set for time period
OppoEPVHeatMapData1sub <- OppoEPVHeatMapData %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set EPV total for time period
OppoEPV1sub <- sum(OppoEPVHeatMapData1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapData1sub$zone_x <- cut(OppoEPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapData1sub$zone_y <- cut(OppoEPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epv1sub <- OppoEPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPV1sub,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZ1sub <- Oppoaverage_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZ1sub <- Oppoaverage_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/OppoEPV1sub,2)))  
```

```{r}
#| height: 100%
OppoEPVHeatMapplot1sub <- OppoEPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
    
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

OppoEPVHeatMapplot1sub
```
```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData  %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#wrapped for time period
OppoEPVHeatMapDataFTW <- OppoEPVHeatMapData %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set EPV total for time period
OppoEPVFTW <- sum(OppoEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
OppoEPVFTGP <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapDataFTW$zone_x <- cut(OppoEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapDataFTW$zone_y <- cut(OppoEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epvFTW <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPVFTW,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZFTW <- Oppoaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  left_join(OppoEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
OppoEPVHeatMapplotFTW <- OppoEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

OppoEPVHeatMapplotFTW
```

## Row {.flow}
``` {r}
#| label: EPV defensive values setup win
#| output: false

DefEPVData <- plottingDataB1 %>%
    filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "Def_EPV", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(Team_Group, TeamName, playerId, EPVvalue, Defensive_Action, outcome, Def_EPV, role) %>%
  mutate(Successful_Def_EPV = ifelse(str_detect(outcome, "Successful"), paste0(Def_EPV), 0)) %>%
  mutate(Unsuccessful_Def_EPV = ifelse(str_detect(outcome, "Unsuccessful"), paste0(Def_EPV), 0)) %>%
  mutate(Successful_Def_EPV = as.numeric(Successful_Def_EPV)) %>%
  mutate(Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

AwayDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Away) 

HomeDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Home)

#set EPV total for time period
HomeEPVFT <- sum(HomeDefEPVData$EPVvalue)
AwayEPVFT <- sum(AwayDefEPVData$EPVvalue)


  
HomeDefEPVData <- HomeDefEPVData %>%  
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/AwayEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/AwayEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 





AwayDefEPVData <- AwayDefEPVData %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/HomeEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/HomeEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 



HomeDefEPVTable <- HomeDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

AwayDefEPVTable <- AwayDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

```

## Column {.flow}
```{r}
#| label: Home Defensive EPV performance tables win
#| results: asis

HomeDefEPVTable_Final <- HomeDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender", 
    "Midfielder"
    #, "Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeDefEPVTable_Final
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )
```


```{r} 
#| output: false
#up to first subs map
#set time period
EPVHeatMapData1sub <- EPVHeatMapData %>%
  filter(Game_State == "Draw")

#set EPV total for time period
HomeEPV1sub <- sum(EPVHeatMapData1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1sub$zone_x <- cut(EPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1sub$zone_y <- cut(EPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1sub <- EPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1sub,3)) 

#calculate for combined tile and heat map
average_epvNZ1sub <- average_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1sub <- average_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1sub,2)))  
```
## Row
```{r}
#| height: 100%
EPVHeatMapplot1sub <- EPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  

  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1sub
```
```{r}
#| output: false
#first subs
#set for time period
OppoEPVHeatMapData1sub <- OppoEPVHeatMapData %>%
  filter(Game_State == "Draw")

#set EPV total for time period
OppoEPV1sub <- sum(OppoEPVHeatMapData1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapData1sub$zone_x <- cut(OppoEPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapData1sub$zone_y <- cut(OppoEPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epv1sub <- OppoEPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPV1sub,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZ1sub <- Oppoaverage_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZ1sub <- Oppoaverage_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/OppoEPV1sub,2)))  
```

```{r}
#| height: 100%
OppoEPVHeatMapplot1sub <- OppoEPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
    
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

OppoEPVHeatMapplot1sub
```
```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData  %>%
  filter(Game_State == "Draw")

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#wrapped for time period
OppoEPVHeatMapDataFTW <- OppoEPVHeatMapData %>%
  filter(Game_State == "Draw")

#set EPV total for time period
OppoEPVFTW <- sum(OppoEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
OppoEPVFTGP <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapDataFTW$zone_x <- cut(OppoEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapDataFTW$zone_y <- cut(OppoEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epvFTW <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPVFTW,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZFTW <- Oppoaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  left_join(OppoEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
OppoEPVHeatMapplotFTW <- OppoEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

OppoEPVHeatMapplotFTW
```

## Row {.flow}
``` {r}
#| label: EPV defensive values setup draw
#| output: false

DefEPVData <- plottingDataB2 %>%
    filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "Def_EPV", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(Team_Group, TeamName, playerId, EPVvalue, Defensive_Action, outcome, Def_EPV, role) %>%
  mutate(Successful_Def_EPV = ifelse(str_detect(outcome, "Successful"), paste0(Def_EPV), 0)) %>%
  mutate(Unsuccessful_Def_EPV = ifelse(str_detect(outcome, "Unsuccessful"), paste0(Def_EPV), 0)) %>%
  mutate(Successful_Def_EPV = as.numeric(Successful_Def_EPV)) %>%
  mutate(Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

AwayDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Away) 

HomeDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Home)

#set EPV total for time period
HomeEPVFT <- sum(HomeDefEPVData$EPVvalue)
AwayEPVFT <- sum(AwayDefEPVData$EPVvalue)


  
HomeDefEPVData <- HomeDefEPVData %>%  
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/AwayEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/AwayEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 





AwayDefEPVData <- AwayDefEPVData %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/HomeEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/HomeEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 

HomeDefEPVTable <- HomeDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

AwayDefEPVTable <- AwayDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

```

## Column {.flow}
```{r}
#| label: Home Defensive EPV performance tables draw
#| results: asis

HomeDefEPVTable_Final <- HomeDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender", 
    "Midfielder"
    #, "Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeDefEPVTable_Final
```


## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```


```{r} 
#| output: false
#up to first subs map
#set time period
EPVHeatMapData1sub <- EPVHeatMapData %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")


#set EPV total for time period
HomeEPV1sub <- sum(EPVHeatMapData1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1sub$zone_x <- cut(EPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1sub$zone_y <- cut(EPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1sub <- EPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1sub,3)) 

#calculate for combined tile and heat map
average_epvNZ1sub <- average_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1sub <- average_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1sub,2)))  
```
## Row
```{r}
#| height: 100%
EPVHeatMapplot1sub <- EPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  

  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1sub
```
```{r}
#| output: false
#first subs
#set for time period
OppoEPVHeatMapData1sub <- OppoEPVHeatMapData %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")


#set EPV total for time period
OppoEPV1sub <- sum(OppoEPVHeatMapData1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapData1sub$zone_x <- cut(OppoEPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapData1sub$zone_y <- cut(OppoEPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epv1sub <- OppoEPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPV1sub,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZ1sub <- Oppoaverage_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZ1sub <- Oppoaverage_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/OppoEPV1sub,2)))  
```

```{r}
#| height: 100%
OppoEPVHeatMapplot1sub <- OppoEPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
    
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

OppoEPVHeatMapplot1sub
```
```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData  %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")


#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#wrapped for time period
OppoEPVHeatMapDataFTW <- OppoEPVHeatMapData %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")


#set EPV total for time period
OppoEPVFTW <- sum(OppoEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
OppoEPVFTGP <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
OppoEPVHeatMapDataFTW$zone_x <- cut(OppoEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
OppoEPVHeatMapDataFTW$zone_y <- cut(OppoEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Oppoaverage_epvFTW <- OppoEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/OppoEPVFTW,3)) 

#calculate for combined tile and heat map
Oppoaverage_epvNZFTW <- Oppoaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%
  left_join(OppoEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Oppoaverage_epvNZFTW <- Oppoaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
OppoEPVHeatMapplotFTW <- OppoEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = Oppoaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

OppoEPVHeatMapplotFTW
```

## Row {.flow}
``` {r}
#| label: EPV defensive values setup gt
#| output: false

DefEPVData <- plottingDataB3 %>%
    filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "Def_EPV", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(Team_Group, TeamName, playerId, EPVvalue, Defensive_Action, outcome, Def_EPV, role) %>%
  mutate(Successful_Def_EPV = ifelse(str_detect(outcome, "Successful"), paste0(Def_EPV), 0)) %>%
  mutate(Unsuccessful_Def_EPV = ifelse(str_detect(outcome, "Unsuccessful"), paste0(Def_EPV), 0)) %>%
  mutate(Successful_Def_EPV = as.numeric(Successful_Def_EPV)) %>%
  mutate(Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

AwayDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Away) 

HomeDefEPVData <- DefEPVData %>%
  filter(Team_Group == Match_Home)

#set EPV total for time period
HomeEPVFT <- sum(HomeDefEPVData$EPVvalue)
AwayEPVFT <- sum(AwayDefEPVData$EPVvalue)


  
HomeDefEPVData <- HomeDefEPVData %>%  
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/AwayEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/AwayEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 





AwayDefEPVData <- AwayDefEPVData %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/HomeEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/HomeEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 

HomeDefEPVTable <- HomeDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

AwayDefEPVTable <- AwayDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

```

## Column {.flow}
```{r}
#| label: Home Defensive EPV performance tables gt
#| results: asis

HomeDefEPVTable_Final <- HomeDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender", 
    "Midfielder"
    #, "Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeDefEPVTable_Final
```

# PPDA Analysis
## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```

```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1)

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
              caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1)

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +

  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup

#filter by da following pass or carries
Home_Post_DA_Passes <- plottingData %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Home_Post_DA_Passes <- Home_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Home) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)



HomePPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))
         
#set for time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData


# Calculate average player position
Average_PlayerFT <- HomePPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

#filter by da following pass
Away_Post_DA_Passes <- plottingData %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Away_Post_DA_Passes <- Away_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Away) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)))

  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)


AwayPPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData

# Calculate average player position
Away_Average_PlayerFT <- AwayPPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)

```

```{r}
#| height: 100%
#| label: Home Post DA Plot 1st Half

Home_Post_DA_Passes_1st <- Home_Post_DA_Passes %>%
    filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


```{r}
#| height: 100%
#| label: Away Post DA Plot 1st Half
Away_Post_DA_Passes_1st <- Away_Post_DA_Passes %>%
  filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


## Row {.flow}
```{r}
#| height: 100%
#| label: Home Post DA Plot 2nd Half

Home_Post_DA_Passes_2nd <- Home_Post_DA_Passes %>%
    filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| label: Away Post DA Plot 2nd Half

Away_Post_DA_Passes_2nd <- Away_Post_DA_Passes %>%
  filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```
```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1)  %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +

  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup b1

#filter by da following pass or carries
Home_Post_DA_Passes <- plottingDataB1 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Home_Post_DA_Passes <- Home_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Home) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)



HomePPDAHeatMapData <- plottingDataB1 %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))
         
#set for time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData


# Calculate average player position
Average_PlayerFT <- HomePPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

#filter by da following pass
Away_Post_DA_Passes <- plottingDataB1 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Away_Post_DA_Passes <- Away_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Away) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)))

  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)


AwayPPDAHeatMapData <- plottingDataB1 %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData

# Calculate average player position
Away_Average_PlayerFT <- AwayPPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)

```

```{r}
#| height: 100%
#| label: Home Post DA Plot 1st Half b1

Home_Post_DA_Passes_1st <- Home_Post_DA_Passes %>%
    filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


```{r}
#| height: 100%
#| label: Away Post DA Plot 1st Half b1
Away_Post_DA_Passes_1st <- Away_Post_DA_Passes %>%
  filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


## Row {.flow}
```{r}
#| height: 100%
#| label: Home Post DA Plot 2nd Half b1

Home_Post_DA_Passes_2nd <- Home_Post_DA_Passes %>%
    filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| label: Away Post DA Plot 2nd Half b1

Away_Post_DA_Passes_2nd <- Away_Post_DA_Passes %>%
  filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )
```
```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  filter(Game_State == "Draw")

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1)  %>%
  filter(Game_State == "Draw")

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +

  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup b2

#filter by da following pass or carries
Home_Post_DA_Passes <- plottingDataB2 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Home_Post_DA_Passes <- Home_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Home) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)



HomePPDAHeatMapData <- plottingDataB2 %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))
         
#set for time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData


# Calculate average player position
Average_PlayerFT <- HomePPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

#filter by da following pass
Away_Post_DA_Passes <- plottingDataB2 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Away_Post_DA_Passes <- Away_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Away) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)))

  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)


AwayPPDAHeatMapData <- plottingDataB2 %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData

# Calculate average player position
Away_Average_PlayerFT <- AwayPPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)

```

```{r}
#| height: 100%
#| label: Home Post DA Plot 1st Half b2

Home_Post_DA_Passes_1st <- Home_Post_DA_Passes %>%
    filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


```{r}
#| height: 100%
#| label: Away Post DA Plot 1st Half b2
Away_Post_DA_Passes_1st <- Away_Post_DA_Passes %>%
  filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


## Row {.flow}
```{r}
#| height: 100%
#| label: Home Post DA Plot 2nd Half b2

Home_Post_DA_Passes_2nd <- Home_Post_DA_Passes %>%
    filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| label: Away Post DA Plot 2nd Half b2

Away_Post_DA_Passes_2nd <- Away_Post_DA_Passes %>%
  filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```
```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1)  %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_HomeC) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 5) +
  
  scale_fill_paletteer_c(ColorScale_AwayC) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup B3

#filter by da following pass or carries
Home_Post_DA_Passes <- plottingDataB3 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Home_Post_DA_Passes <- Home_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Home) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)),
         Prog_Action = as.numeric(Prog_Action))

  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Home_Post_DA_Passes <- shift_column(data = Home_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)



HomePPDAHeatMapData <- plottingDataB3 %>%
  filter(Team_Group == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))
         
#set for time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData


# Calculate average player position
Average_PlayerFT <- HomePPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

#filter by da following pass
Away_Post_DA_Passes <- plottingDataB3 %>%
  select(period, period_displayName, Team_Group, playerId, player_shirt, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action, EPVvalue, EPVStart, EPVEnd)

Away_Post_DA_Passes <- Away_Post_DA_Passes %>%
  filter(Prev_Defensive_Action == 1
         ,Team_Group == Match_Away) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)))

  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
  Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "player_shirt", new_names = "receiver_shirt", len = 1, up = TRUE)
Away_Post_DA_Passes <- shift_column(data = Away_Post_DA_Passes, columns = "Team_Group", new_names = "receiver_team", len = 1, up = TRUE)


AwayPPDAHeatMapData <- plottingDataB3 %>%
  filter(Team_Group == Match_Away) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData

# Calculate average player position
Away_Average_PlayerFT <- AwayPPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)

```

```{r}
#| height: 100%
#| label: Home Post DA Plot 1st Half b3

Home_Post_DA_Passes_1st <- Home_Post_DA_Passes %>%
    filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
    #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```


```{r}
#| height: 100%
#| label: Away Post DA Plot 1st Half b3
Away_Post_DA_Passes_1st <- Away_Post_DA_Passes %>%
  filter(period_displayName == "First Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
    filter(period_displayName == "First Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +

  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_1st,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_1st, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 1st Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 1st Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```


## Row {.flow}
```{r}
#| height: 100%
#| label: Home Post DA Plot 2nd Half b3

Home_Post_DA_Passes_2nd <- Home_Post_DA_Passes %>%
    filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player + shirt for DA win
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Home_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Home, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Home_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Home_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste(Match_Home,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Home Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)

```

```{r}
#| height: 100%
#| label: Away Post DA Plot 2nd Half b3

Away_Post_DA_Passes_2nd <- Away_Post_DA_Passes %>%
  filter(period_displayName == "Second Half",
           EPVvalue >= 0.01) 

AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  filter(period_displayName == "Second Half") %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_link(data = Away_Post_DA_Passes_2nd,
               aes( x = x, y = y, xend = finalX, yend = finalY, 
                    color = Prog_Action, 
                    alpha = stat(index),
                    size = after_stat(index)
                    ),
            show.legend = NA,
            inherit.aes = TRUE
  ) +
  
  #plot recieving player from DA
  geom_point(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, color = Prog_Action), fill = Color_Away, size = 4, shape = 21, stroke = 0.5, alpha = 0.8) +
  
  geom_text(data = Away_Post_DA_Passes_2nd, aes(x = finalX, y = finalY, label = receiver_shirt), color = Color_Away_Text, size = 2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_size(range = c(0.5, 2)) +
  scale_fill_paletteer_c(ColorScale_AwayC) +

  #wrap by half
  #facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away,"Passes or Carries Post Successful DA - 2nd Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nComets: Red = Progressive or Blue = Successful, \nCircle Number = Recieving player, Direction of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT

#save Plot
ggsave(path = Vizlocation, "Away Post PD 2nd Half.png", width = 2500, height = 2150, units = "px", dpi = 400)
```

# xG Analysis

```{r xG setup, echo:FALSE, messages:FALSE, warnings:FALSE}
#| output: false
#Load home data
dashboard_data <- plottingData

dashboard_data <- dashboard_data %>%
  filter(Team_Group == Match_Home) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, minute, expandedMinute, result = type, player = playerId, Team_Group, Game_Block, Game_State)

#Load away data
Oppodashboard_data <- plottingData

Oppodashboard_data <- Oppodashboard_data %>%
  filter(Team_Group == Match_Away) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, TeamName, TotalShots, xG, NPxG, xGOT, minute, expandedMinute, result = type, player = playerId, Team_Group, Game_Block, Game_State)


WinDashboard_data <- dashboard_data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")


DrawDashboard_data <- dashboard_data %>%
  filter(Game_State == "Draw")

GTimeDashboard_data <- dashboard_data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

WinOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

DrawOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Draw")

GTimeOppoDashboard_data <- Oppodashboard_data %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

```

## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```

## Row

```{r}
# Density Shot Map
#canvas
xGDensityPlot <- dashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +
  

  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       fill = "xG Level",
       color = "xG Level",
        caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlot_I

```

```{r}

# Density Shot Map

#canvas
xGDensityPlotOppo <- Oppodashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
    #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
   
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlotOppo_I <- ggplotly(xGDensityPlotOppo, tooltip = "text")

xGDensityPlotOppo_I <- xGDensityPlotOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlotOppo_I
```



## Row

```{r}
ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  filter(Team_Group == Match_Home)

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 600), breaks = seq(0, 600, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
```

```{r}
OppoShotBubblexG_data <- plottingData 

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  filter(Team_Group == Match_Away)

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGOppoBubblePlot_data <- OppoShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGOppoBubblePlot_data <- xGOppoBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGOppoBubblePlot_data_pivot <- xGOppoBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  OppoxGBubble_Plot <- xGOppoBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 600), breaks = seq(0, 600, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

OppoxGBubble_Plot_I  <- ggplotly(OppoxGBubble_Plot, tooltip = "text")

OppoxGBubble_Plot_I <- OppoxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OppoxGBubble_Plot_I

```

## Row

```{r}
# Bar Plot

xGSituationBarData <- dashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I

```

```{r}
# Bar Plot
xGSituationBarOppoData <- Oppodashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarOppo <- xGSituationBarOppoData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarOppo_I <- ggplotly(xGSituationBarOppo, tooltip = "xG")

xGSituationBarOppo_I <- xGSituationBarOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarOppo_I
```

## Row
```{r}
#| content: valuebox

list(
  icon = "key",
  color = "primary",
  value = "Game State - Winning")
```

## Row

```{r}
# Density Shot Map
#canvas
xGDensityPlot <- WinDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       fill = "xG Level",
       color = "xG Level",
        caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlot_I

```

```{r}

# Density Shot Map

#canvas
xGDensityPlotOppo <- WinOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#xGDensityPlotOppo_I <- ggplotly(xGDensityPlotOppo, tooltip = "text")

xGDensityPlotOppo_I <- xGDensityPlotOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

#xGDensityPlotOppo_I
```



## Row

```{r}
ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Home) %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
```

```{r}
OppoShotBubblexG_data <- plottingData 

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Away)  %>%
  filter(Game_State == "Away Lead" | Game_State == "Home Lead")

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGOppoBubblePlot_data <- OppoShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGOppoBubblePlot_data <- xGOppoBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGOppoBubblePlot_data_pivot <- xGOppoBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  OppoxGBubble_Plot <- xGOppoBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

OppoxGBubble_Plot_I  <- ggplotly(OppoxGBubble_Plot, tooltip = "text")

OppoxGBubble_Plot_I <- OppoxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OppoxGBubble_Plot_I

```

## Row

```{r}
# Bar Plot

xGSituationBarData <- WinDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I

```

```{r}
# Bar Plot
xGSituationBarOppoData <- WinOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarOppo <- xGSituationBarOppoData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarOppo_I <- ggplotly(xGSituationBarOppo, tooltip = "xG")

xGSituationBarOppo_I <- xGSituationBarOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarOppo_I
```
## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Draw")
```

## Row


```{r}
# Density Shot Map
#canvas
xGDensityPlot <- DrawDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       fill = "xG Level",
       color = "xG Level",
        caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlot_I

```

```{r}

# Density Shot Map

#canvas
xGDensityPlotOppo <- DrawOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlotOppo_I <- ggplotly(xGDensityPlotOppo, tooltip = "text")

xGDensityPlotOppo_I <- xGDensityPlotOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlotOppo_I
```



## Row

```{r}
ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Home) %>%
  filter(Game_State == "Draw")

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
```

```{r}
OppoShotBubblexG_data <- plottingData 

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Away)  %>%
  filter(Game_State == "Draw")

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGOppoBubblePlot_data <- OppoShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGOppoBubblePlot_data <- xGOppoBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGOppoBubblePlot_data_pivot <- xGOppoBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  OppoxGBubble_Plot <- xGOppoBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

OppoxGBubble_Plot_I  <- ggplotly(OppoxGBubble_Plot, tooltip = "text")

OppoxGBubble_Plot_I <- OppoxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OppoxGBubble_Plot_I

```

## Row

```{r}
# Bar Plot

xGSituationBarData <- DrawDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I

```

```{r}
# Bar Plot
xGSituationBarOppoData <- DrawOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarOppo <- xGSituationBarOppoData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarOppo_I <- ggplotly(xGSituationBarOppo, tooltip = "xG")

xGSituationBarOppo_I <- xGSituationBarOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarOppo_I
```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time")
```

## Row

```{r}
# Density Shot Map
#canvas
xGDensityPlot <- GTimeDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       fill = "xG Level",
       color = "xG Level",
        caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlot_I

```

```{r}

# Density Shot Map

#canvas
xGDensityPlotOppo <- GTimeOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  
  #geometrics
  stat_density_2d(aes(#color = after_stat(level), 
    fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.4, adjust = 0.5, linewidth = 0.5) +

  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture),
       caption = "Darker Colour + Tighter Lines = Higher xG") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption =  element_text(colour = "black", size = 8),
        legend.position = "bottom", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

xGDensityPlotOppo_I <- ggplotly(xGDensityPlotOppo, tooltip = "text")

xGDensityPlotOppo_I <- xGDensityPlotOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGDensityPlotOppo_I
```



## Row

```{r}
ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Home) %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
```

```{r}
OppoShotBubblexG_data <- plottingData 

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  #filter(Game_Block == 1) %>%
  filter(Team_Group == Match_Away)  %>%
  filter(Game_State == "Away Garbage Time" | Game_State == "Home Garbage Time")

OppoShotBubblexG_data <- OppoShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGOppoBubblePlot_data <- OppoShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGOppoBubblePlot_data <- xGOppoBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGOppoBubblePlot_data_pivot <- xGOppoBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  OppoxGBubble_Plot <- xGOppoBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50)) +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 5)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

OppoxGBubble_Plot_I  <- ggplotly(OppoxGBubble_Plot, tooltip = "text")

OppoxGBubble_Plot_I <- OppoxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OppoxGBubble_Plot_I

```

## Row

```{r}
# Bar Plot

xGSituationBarData <- GTimeDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I

```

```{r}
# Bar Plot
xGSituationBarOppoData <- GTimeOppoDashboard_data %>%
  #filter(Game_Block == 1) %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarOppo <- xGSituationBarOppoData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
      scale_x_continuous(limits = c(0, 15), breaks = seq(0, 15, 5)) +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarOppo_I <- ggplotly(xGSituationBarOppo, tooltip = "xG")

xGSituationBarOppo_I <- xGSituationBarOppo_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarOppo_I
```


# Shot Analysis

## Row
```{r}
#| content: valuebox

list(
  icon = "calendar-date",
  color = "primary",
  value = "Whole Season")
```

## Row {.flow}
```{r}
#|height: 100%
#shot map
LFC_S_plot <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

LFC_S_plot_I <- ggplotly(LFC_S_plot, tooltip = "text")

LFC_S_plot_I <- LFC_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

LFC_S_plot_I

```

```{r}
#|height: 100%
OPPO_S_plot <- plot_shot_AI(Oppodashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

OPPO_S_plot_I <- ggplotly(OPPO_S_plot, tooltip = "text")


OPPO_S_plot_I <- OPPO_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plot_I

```

## Row {.flow}
```{r}
#|height: 100%
LFC_S_plotWT <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

LFC_S_plotWT_I <- ggplotly(LFC_S_plotWT, tooltip = "text")
LFC_S_plotWT_I <- LFC_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
LFC_S_plotWT_I

```

```{r}
#|height: 100%
OPPO_S_plotWT <- plot_shot_AI(Oppodashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

OPPO_S_plotWT_I <- ggplotly(OPPO_S_plotWT, tooltip = "text")
OPPO_S_plotWT_I <- OPPO_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plotWT_I

```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Winning"
  )
```

## Row {.flow}
```{r}
#|height: 100%
#shot map


LFC_S_plot <- plot_shot_AI(WinDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

LFC_S_plot_I <- ggplotly(LFC_S_plot, tooltip = "text")

LFC_S_plot_I <- LFC_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

LFC_S_plot_I

```
```{r}
#|height: 100%
OPPO_S_plot <- plot_shot_AI(WinOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

OPPO_S_plot_I <- ggplotly(OPPO_S_plot, tooltip = "text")


OPPO_S_plot_I <- OPPO_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plot_I

```
## Row {.flow}
```{r}
#|height: 100%
LFC_S_plotWT <- plot_shot_AI(WinDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

LFC_S_plotWT_I <- ggplotly(LFC_S_plotWT, tooltip = "text")
LFC_S_plotWT_I <- LFC_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
LFC_S_plotWT_I

```

```{r}
#|height: 100%
OPPO_S_plotWT <- plot_shot_AI(WinOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

OPPO_S_plotWT_I <- ggplotly(OPPO_S_plotWT, tooltip = "text")
OPPO_S_plotWT_I <- OPPO_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plotWT_I

```

## Row
```{r}
#| content: valuebox
#| height: "100%"

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Drawing"
  )

```


## Row {.flow}
```{r}
#|height: 100%
#shot map


LFC_S_plot <- plot_shot_AI(DrawDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

LFC_S_plot_I <- ggplotly(LFC_S_plot, tooltip = "text")

LFC_S_plot_I <- LFC_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

LFC_S_plot_I

```
```{r}
#|height: 100%
OPPO_S_plot <- plot_shot_AI(DrawOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

OPPO_S_plot_I <- ggplotly(OPPO_S_plot, tooltip = "text")


OPPO_S_plot_I <- OPPO_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plot_I

```
## Row {.flow}
```{r}
#|height: 100%
LFC_S_plotWT <- plot_shot_AI(WinDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

LFC_S_plotWT_I <- ggplotly(LFC_S_plotWT, tooltip = "text")
LFC_S_plotWT_I <- LFC_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
LFC_S_plotWT_I

```

```{r}
#|height: 100%
OPPO_S_plotWT <- plot_shot_AI(WinOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

OPPO_S_plotWT_I <- ggplotly(OPPO_S_plotWT, tooltip = "text")
OPPO_S_plotWT_I <- OPPO_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plotWT_I

```

## Row
```{r}
#| content: valuebox

list(
  icon = "stopwatch-fill",
  color = "primary",
  value = "Game State - Garbage Time"
  )
```


## Row {.flow}
```{r}
#|height: 100%
#shot map


LFC_S_plot <- plot_shot_AI(GTimeDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

LFC_S_plot_I <- ggplotly(LFC_S_plot, tooltip = "text")

LFC_S_plot_I <- LFC_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

LFC_S_plot_I

```
```{r}
#|height: 100%
OPPO_S_plot <- plot_shot_AI(GTimeOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

OPPO_S_plot_I <- ggplotly(OPPO_S_plot, tooltip = "text")


OPPO_S_plot_I <- OPPO_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plot_I

```
## Row {.flow}
```{r}
#|height: 100%
LFC_S_plotWT <- plot_shot_AI(GTimeDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

LFC_S_plotWT_I <- ggplotly(LFC_S_plotWT, tooltip = "text")
LFC_S_plotWT_I <- LFC_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
LFC_S_plotWT_I

```

```{r}
#|height: 100%
OPPO_S_plotWT <- plot_shot_AI(GTimeOppoDashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = ,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

OPPO_S_plotWT_I <- ggplotly(OPPO_S_plotWT, tooltip = "text")
OPPO_S_plotWT_I <- OPPO_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
OPPO_S_plotWT_I

```